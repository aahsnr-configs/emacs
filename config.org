#+TITLE: Emacs Configuration
#+AUTHOR: Ahsanur Rahman
#+STARTUP: overview
#+PROPERTY: header-args:emacs-lisp :tangle ./init.el :mkdirp yes

* Core Emacs Configuration
** Lexical Binding
#+begin_src emacs-lisp
;;; init.el --- Main Configuration File -*- no-byte-compile: t; lexical-binding: t; -*-
#+end_src

** Garbage Collection
#+begin_src emacs-lisp
;; CRITICAL: Restore GC after startup with optimized values
(defvar better-gc-cons-threshold 134217728  ;; 128MB (increased from default 800KB)
  "Optimal GC threshold for modern LSP-heavy workflows.
Lower this if you experience freezing, raise if stuttering.")

(defvar better-gc-cons-percentage 0.1
  "GC percentage of heap to trigger collection.")

;; Restore GC settings after startup
(add-hook 'elpaca-after-init-hook
          (lambda ()
            (setq gc-cons-threshold better-gc-cons-threshold
                  gc-cons-percentage better-gc-cons-percentage)

            ;; FIX: Only restore file handlers if the original variable actually exists
            (when (boundp 'file-name-handler-alist-original)
              (setq file-name-handler-alist file-name-handler-alist-original)
              (makunbound 'file-name-handler-alist-original))

            ;; Report startup time
            (message "Emacs loaded in %.2fs with %d GCs"
                     (float-time (time-subtract after-init-time before-init-time))
                     gcs-done))
          100) ;; Run late to ensure accurate timing

;; Increase GC threshold in minibuffer to prevent slowdowns during completion
(add-hook 'elpaca-after-init-hook
          (lambda ()
            (defun gc-minibuffer-setup-hook ()
              (setq gc-cons-threshold (* better-gc-cons-threshold 2)))

            (defun gc-minibuffer-exit-hook ()
              (garbage-collect)
              (setq gc-cons-threshold better-gc-cons-threshold))

            (add-hook 'minibuffer-setup-hook #'gc-minibuffer-setup-hook)
            (add-hook 'minibuffer-exit-hook #'gc-minibuffer-exit-hook)))
#+end_src

** Package Management
#+begin_src emacs-lisp
(defvar elpaca-installer-version 0.11)
(defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
(defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
(defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
(defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                              :ref nil :depth 1 :inherit ignore
                              :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                              :build (:not elpaca--activate-package)))
(let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
       (build (expand-file-name "elpaca/" elpaca-builds-directory))
       (order (cdr elpaca-order))
       (default-directory repo))
  (add-to-list 'load-path (if (file-exists-p build) build repo))
  (unless (file-exists-p repo)
    (make-directory repo t)
    (when (<= emacs-major-version 28) (require 'subr-x))
    (condition-case-unless-debug err
        (if-let* ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                  ((zerop (apply #'call-process `("git" nil ,buffer t "clone"
                                                  ,@(when-let* ((depth (plist-get order :depth)))
                                                      (list (format "--depth=%d" depth) "--no-single-branch"))
                                                  ,(plist-get order :repo) ,repo))))
                  ((zerop (call-process "git" nil buffer t "checkout"
                                        (or (plist-get order :ref) "--"))))
                  (emacs (concat invocation-directory invocation-name))
                  ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                        "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                  ((require 'elpaca))
                  ((elpaca-generate-autoloads "elpaca" repo)))
            (progn (message "%s" (buffer-string)) (kill-buffer buffer))
          (error "%s" (with-current-buffer buffer (buffer-string))))
      ((error) (warn "%s" err) (delete-directory repo 'recursive))))
  (unless (require 'elpaca-autoloads nil t)
    (require 'elpaca)
    (elpaca-generate-autoloads "elpaca" repo)
    (let ((load-source-file-function nil)) (load "./elpaca-autoloads"))))
(add-hook 'after-init-hook #'elpaca-process-queues)
(elpaca `(,@elpaca-order))

;; Install use-package support
(elpaca elpaca-use-package
  ;; Enable use-package :ensure support for Elpaca.
  (elpaca-use-package-mode))


(eval-and-compile
  (setq use-package-verbose nil  ;; Changed from t - reduce startup messages
        use-package-expand-minimally t
        use-package-compute-statistics nil  ;; Changed from t - disable unless profiling
        ;;use-package-always-defer t
        use-package-always-ensure t
        use-package-enable-imenu-support t))

(eval-when-compile
  (require 'use-package)
  (require 'bind-key))
#+end_src


** Custom Functions
#+begin_src emacs-lisp
(defun childframe-workable-p ()
  "Whether childframe is workable."
  (and (>= emacs-major-version 26)
       (not noninteractive)
       (or (display-graphic-p)
           (featurep 'tty-child-frames))
       (eq (frame-parameter (selected-frame) 'minibuffer) 't)))

(defun childframe-completion-workable-p ()
  "Whether childframe completion is workable."
  (childframe-workable-p))

(defun icons-displayable-p ()
  "Return non-nil if icons are displayable."
  (or (featurep 'nerd-icons)
      (require 'nerd-icons nil t)))

(defun too-long-file-p ()
  "Check whether the file is too long."
  (or (> (buffer-size) 500000)
      (and (fboundp 'buffer-line-statistics)
           (> (car (buffer-line-statistics)) 10000))))

(defun reload-init-file ()
  "Tangle and reload the Emacs configuration from config.org."
  (interactive)
  (let* ((config-org (expand-file-name "config.org" user-emacs-directory))
         (init-el (expand-file-name "init.el" user-emacs-directory)))
    ;; Check if config.org exists
    (unless (file-exists-p config-org)
      (user-error "Configuration file %s not found!" config-org))
    
    (message "Tangling configuration from %s..." config-org)
    
    ;; Tangle the org file
    (org-babel-tangle-file config-org init-el "emacs-lisp")
    
    (message "Loading %s..." init-el)
    
    ;; Load the tangled init file
    ;; Note: This doesn't fully restart Emacs, so some changes
    ;; (especially to package declarations) may require a restart
    (load-file init-el)
    
    ;; Process any queued Elpaca packages
    (when (fboundp 'elpaca-process-queues)
      (elpaca-process-queues))
    
    (message "Configuration reloaded! Some changes may require an Emacs restart.")))

(defun my/auto-tangle-config-org ()
  "Automatically tangle config.org when saved."
  (when (string-equal (buffer-file-name)
                      (expand-file-name "config.org" user-emacs-directory))
    ;; Dynamic scoping to avoid confirmation prompts
    (let ((org-confirm-babel-evaluate nil))
      (org-babel-tangle))))

(add-hook 'org-mode-hook
          (lambda ()
            (add-hook 'after-save-hook #'my/auto-tangle-config-org nil t)))
#+end_src

** Constants
#+begin_src emacs-lisp
(defconst sys/linuxp
  (eq system-type 'gnu/linux)
  "Are we running on a GNU/Linux system?")

(defconst sys/rootp
  (string-equal "root" (getenv "USER"))
  "Are you using ROOT user?")

(defconst emacs/>=29p
  (>= emacs-major-version 29)
  "Emacs is 29 or above.")

(defconst emacs/>=29.2p
  (and (>= emacs-major-version 29)
       (>= emacs-minor-version 2))
  "Emacs is 29.2 or above.")

(defconst emacs/>=30p
  (>= emacs-major-version 30)
  "Emacs is 30 or above.")

(defconst emacs/>=31p
  (>= emacs-major-version 31)
  "Emacs is 31 or above.")
#+end_src

** Performance Tuning
#+begin_src emacs-lisp
(when (fboundp 'pgtk-use-im-context)
  (add-hook 'after-make-frame-functions
            (lambda (frame)
              (with-selected-frame frame
                (pgtk-use-im-context nil)))))


(setq-default bidi-display-reordering nil
              bidi-paragraph-direction 'left-to-right
              bidi-inhibit-bpa t)

;; Apply to common modes
(defun my/bidi-optimizations ()
  "Apply bidi optimizations for current buffer."
  (setq-local bidi-paragraph-direction 'left-to-right
              bidi-inhibit-bpa t))

(add-hook 'org-mode-hook #'my/bidi-optimizations)
(add-hook 'text-mode-hook #'my/bidi-optimizations)
(add-hook 'prog-mode-hook #'my/bidi-optimizations)

(setq-default long-line-threshold 1000
              large-hscroll-threshold 1000
              syntax-wholeline-max 1000)

(setq undo-limit 800000
      undo-strong-limit 1200000
      undo-outer-limit 120000000)

(setq scroll-conservatively 101
      scroll-margin 0
      scroll-preserve-screen-position t
      auto-window-vscroll nil
      fast-but-imprecise-scrolling t  ;; Trade accuracy for speed
      redisplay-skip-fontification-on-input t)  ;; Skip during rapid input

(setq highlight-nonselected-windows nil)
(setq blink-cursor-mode nil)

(setq frame-resize-pixelwise t)
(setq window-resize-pixelwise nil)

(setq byte-compile-warnings '(not obsolete))
(setq native-comp-async-report-warnings-errors 'silent)

(setq ffap-machine-p-known 'reject)

(setq inhibit-compacting-font-caches t)  ;; Don't compact font cache
#+end_src

** Small Configs
#+begin_src emacs-lisp
;; Move backup files to dedicated directory
(setq backup-directory-alist `(("." . ,(expand-file-name ".backup" user-emacs-directory))))

;; Confirmation settings
(setq confirm-kill-processes nil)  ;; Auto-kill processes on exit

;; Faster echo of keystrokes
(setq echo-keystrokes 0.1)

;; Don't create lockfiles
(setq-default create-lockfiles nil)

;; Compilation settings
(setq-default compilation-always-kill t
              compilation-ask-about-save nil
              compilation-scroll-output t)

;; Suppress redefinition warnings
(setq ad-redefinition-action 'accept)

;; Custom file location - CRITICAL: Load after Elpaca finishes
(setq custom-file (concat user-emacs-directory "custom.el"))
(add-hook 'elpaca-after-init-hook
            (lambda () (load custom-file 'noerror)))

;; Require final newline
(setq require-final-newline t)

;; Enable commands
(put 'erase-buffer 'disabled nil)

;; Global modes
(global-hl-line-mode 1)
(delete-selection-mode 1)

;; File associations
(add-to-list 'auto-mode-alist '("\\.in\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.out\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.args\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.bb\\'" . shell-script-mode))
(add-to-list 'auto-mode-alist '("\\.bbclass\\'" . shell-script-mode))
(add-to-list 'auto-mode-alist '("\\.Rmd\\'" . markdown-mode))

;; Alt key mapping
(setq x-alt-keysym 'meta)
#+end_src


** Garbage Collector Magic Hack
#+begin_src emacs-lisp
(use-package gcmh
  :hook (elpaca-after-init . gcmh-mode)
  :init
  (setq gcmh-idle-delay 'auto))
#+end_src

** UTF-8 Coding System
#+begin_src emacs-lisp
(set-selection-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
(set-language-environment "UTF-8")
(set-default-coding-systems 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(setq locale-coding-system 'utf-8)
;; Treat clipboard input as UTF-8 string first; compound text next, etc.
(when (display-graphic-p)
  (setq x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING)))
#+end_src

** Environment
#+begin_src emacs-lisp
(use-package exec-path-from-shell
  :custom
  (exec-path-from-shell-variables
   '("PATH" "MANPATH"
     "OPENAI_API_KEY" "ANTHROPIC_API_KEY"
     "XAI_API_KEY" "DEEPSEEK_API_KEY"
     "OPENROUTER_API_KEY" "GEMINI_API_KEY"))
  :config
  (when (daemonp)
    (exec-path-from-shell-initialize)))
#+end_src

** Session Management
#+begin_src emacs-lisp
;; Save place
(use-package saveplace
  :ensure nil
  :hook (elpaca-after-init . save-place-mode))

;; History
(use-package recentf
  :ensure nil
  :hook (elpaca-after-init . recentf-mode)
  :init (setq recentf-max-saved-items 300
              recentf-exclude
              '("\\.?cache" ".cask" "url" "COMMIT_EDITMSG\\'" "bookmarks"
                "\\.\\(?:gz\\|gif\\|svg\\|png\\|jpe?g\\|bmp\\|xpm\\)$"
                "\\.?ido\\.last$" "\\.revive$" "/G?TAGS$" "/.elfeed/"
                "^/tmp/" "^/var/folders/.+$" "^/ssh:" "/persp-confs/"
                (lambda (file) (file-in-directory-p file package-user-dir))))
  :config
  (push (expand-file-name recentf-save-file) recentf-exclude)
  (add-to-list 'recentf-filename-handlers #'abbreviate-file-name))

(use-package savehist
  :ensure nil
  :hook (elpaca-after-init . savehist-mode)
  :init (setq enable-recursive-minibuffers t ; Allow commands in minibuffers
              history-length 1000
              savehist-additional-variables '(mark-ring
                                              global-mark-ring
                                              search-ring
                                              regexp-search-ring
                                              extended-command-history)
              savehist-autosave-interval 300))
#+end_src


** Misc
#+begin_src emacs-lisp
;; ;; Misc.
(use-package simple
  :ensure nil
  :hook ((text-mode . visual-line-mode)
         ((prog-mode markdown-mode conf-mode) . enable-trailing-whitespace))
  :init
  (setq column-number-mode t
        line-number-mode t
        kill-whole-line t               ; Kill line including '\n'
        line-move-visual nil
        track-eol t                     ; Keep cursor at end of lines. Require line-move-visual is nil.
        set-mark-command-repeat-pop t)  ; Repeating C-SPC after popping mark pops it again

  ;; Visualize TAB, (HARD) SPACE, NEWLINE
  (setq-default show-trailing-whitespace nil) ; Don't show trailing whitespace by default
  (defun enable-trailing-whitespace ()
    "Show trailing spaces and delete on saving."
    (setq show-trailing-whitespace t)
    (add-hook 'before-save-hook #'delete-trailing-whitespace nil t))

  ;; Prettify the process list
  (with-no-warnings
    (defun my-list-processes--prettify ()
      "Prettify process list."
      (when-let* ((entries tabulated-list-entries))
        (setq tabulated-list-entries nil)
        (dolist (p (process-list))
          (when-let* ((val (cadr (assoc p entries)))
                      (name (aref val 0))
                      (pid (aref val 1))
                      (status (aref val 2))
                      (status (list status
                                    'face
                                    (if (memq status '(stop exit closed failed))
                                        'error
                                      'success)))
                      (buf-label (aref val 3))
                      (tty (list (aref val 4) 'face 'font-lock-doc-face))
                      (thread (list (aref val 5) 'face 'font-lock-doc-face))
                      (cmd (list (aref val 6) 'face 'completions-annotations)))
            (push (list p (vector name pid status buf-label tty thread cmd))
		          tabulated-list-entries)))))
    (advice-add #'list-processes--refresh :after #'my-list-processes--prettify)))

;; Misc
(if (boundp 'use-short-answers)
    (setq use-short-answers t)
  (fset 'yes-or-no-p 'y-or-n-p))
(setq-default major-mode 'text-mode
              fill-column 80
              tab-width 4
              indent-tabs-mode nil)     ; Permanently indent with spaces, never with TABs

(setq visible-bell t
      inhibit-compacting-font-caches t  ; Don’t compact font caches during GC
      delete-by-moving-to-trash t       ; Deleting files go to OS's trash folder
      make-backup-files nil             ; Forbide to make backup files
      auto-save-default nil             ; Disable auto save

      uniquify-buffer-name-style 'post-forward-angle-brackets ; Show path if names are same
      adaptive-fill-regexp "[ t]+|[ t]*([0-9]+.|*+)[ t]*"
      adaptive-fill-first-line-regexp "^* *$"
      sentence-end "\\([。！？]\\|……\\|[.?!][]\"')}]*\\($\\|[ \t]\\)\\)[ \t\n]*"
      sentence-end-double-space nil
      word-wrap-by-category t)
#+end_src

* Evil
** Core Evil
#+begin_src emacs-lisp
;; The undo-fu package is a lightweight wrapper around Emacs' built-in undo
;; system, providing more convenient undo/redo functionality.
(use-package undo-fu
  :commands (undo-fu-only-undo
             undo-fu-only-redo
             undo-fu-only-redo-all
             undo-fu-disable-checkpoint)
  :config
  (global-unset-key (kbd "C-z"))
  (global-set-key (kbd "C-z") 'undo-fu-only-undo)
  (global-set-key (kbd "C-S-z") 'undo-fu-only-redo))

;; The undo-fu-session package complements undo-fu by enabling the saving
;; and restoration of undo history across Emacs sessions, even after restarting.
(use-package undo-fu-session
  :commands undo-fu-session-global-mode
  :hook (elpaca-after-init . undo-fu-session-global-mode))


(setq evil-undo-system 'undo-fu)

;; Vim emulation
(use-package evil
  :commands (evil-mode evil-define-key)
  :hook (elpaca-after-init . evil-mode)

  :init
  ;; It has to be defined before evil
  (setq evil-want-integration t)
  (setq evil-want-keybinding nil)

  :custom
  ;; Make :s in visual mode operate only on the actual visual selection
  ;; (character or block), instead of the full lines covered by the selection
  (evil-ex-visual-char-range t)
  ;; Use Vim-style regular expressions in search and substitute commands,
  ;; allowing features like \v (very magic), \zs, and \ze for precise matches
  (evil-ex-search-vim-style-regexp t)
  ;; Enable automatic horizontal split below
  (evil-split-window-below t)
  ;; Enable automatic vertical split to the right
  (evil-vsplit-window-right t)
  ;; Disable echoing Evil state to avoid replacing eldoc
  (evil-echo-state nil)
  ;; Do not move cursor back when exiting insert state
  (evil-move-cursor-back nil)
  ;; Make `v$` exclude the final newline
  (evil-v$-excludes-newline t)
  ;; Allow C-h to delete in insert state
  (evil-want-C-h-delete t)
  ;; Enable C-u to delete back to indentation in insert state
  (evil-want-C-u-delete t)
  ;; Enable fine-grained undo behavior
  (evil-want-fine-undo t)
  ;; Allow moving cursor beyond end-of-line in visual block mode
  (evil-move-beyond-eol t)
  ;; Disable wrapping of search around buffer
  (evil-search-wrap nil)
  ;; Whether Y yanks to the end of the line
  (evil-want-Y-yank-to-eol t))

(use-package evil-collection
  :after evil
  :init
  ;; It has to be defined before evil-colllection
  (setq evil-collection-setup-minibuffer t)
  :config
  (evil-collection-init))

;; The evil-surround package simplifies handling surrounding characters, such as
;; parentheses, brackets, quotes, etc. It provides key bindings to easily add,
;; change, or delete these surrounding characters in pairs. For instance, you
;; can surround the currently selected text with double quotes in visual state
;; using S" or gS".
(use-package evil-surround
  :after evil
  :commands global-evil-surround-mode
  :custom
  (evil-surround-pairs-alist
   '((?\( . ("(" . ")"))
     (?\[ . ("[" . "]"))
     (?\{ . ("{" . "}"))

     (?\) . ("(" . ")"))
     (?\] . ("[" . "]"))
     (?\} . ("{" . "}"))

     (?< . ("<" . ">"))
     (?> . ("<" . ">"))))
  :hook (elpaca-after-init . global-evil-surround-mode))

(use-package evil-lion
  :config
  (evil-lion-mode))

;; The following code enables commenting and uncommenting by pressing gcc in
;; normal mode and gc in visual mode.
(with-eval-after-load "evil"
  (evil-define-operator my-evil-comment-or-uncomment (beg end)
    "Toggle comment for the region between BEG and END."
    (interactive "<r>")
    (comment-or-uncomment-region beg end))
  (evil-define-key 'normal 'global (kbd "gc") 'my-evil-comment-or-uncomment))

#+end_src

** Evil Window Movement Enhancements
#+begin_src emacs-lisp
(defcustom ar/evil-want-move-window-to-wrap-around nil
  "If non-nil, window movement commands wrap around."
  :type 'boolean
  :group 'evil)

(defun ar/evil-window-move-left ()
  "Move to window on the left, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-left))))
      (evil-window-bottom-right)
    (windmove-left)))

(defun ar/evil-window-move-right ()
  "Move to window on the right, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-right))))
      (evil-window-top-left)
    (windmove-right)))

(defun ar/evil-window-move-up ()
  "Move to window above, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-up))))
      (evil-window-bottom-right)
    (windmove-up)))

(defun ar/evil-window-move-down ()
  "Move to window below, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-down))))
      (evil-window-top-left)
    (windmove-down)))
#+end_src

* Setup User
#+begin_src emacs-lisp
(setq user-full-name "Ahsanur Rahman"
      user-mail-address "ahsanur041@proton.me")
#+end_src

* Hydra Setup
#+begin_src emacs-lisp
(use-package hydra
  :ensure (:wait t)
  :demand t
  :defines posframe-border-width
  :hook (emacs-lisp-mode . hydra-add-imenu)
  :init
  (setq hydra-hint-display-type 'lv)
  :config
  ;; Use posframe if available and graphical
  (when (and (display-graphic-p)
             (require 'posframe nil t))
    (setq hydra-hint-display-type 'posframe)
    (setq hydra-posframe-show-params
          `(:left-fringe 8
            :right-fringe 8
            :internal-border-width 2
            :internal-border-color ,(face-background 'region nil t)
            :background-color ,(face-background 'tooltip nil t)
            :foreground-color ,(face-foreground 'tooltip nil t)
            :lines-truncate t
            :poshandler posframe-poshandler-frame-center-near-bottom))

    ;; Update colors on theme change
    (defun my-hydra-update-posframe-params ()
      "Update hydra posframe parameters after theme change."
      (setq hydra-posframe-show-params
            `(:left-fringe 8
              :right-fringe 8
              :internal-border-width 2
              :internal-border-color ,(face-background 'region nil t)
              :background-color ,(face-background 'tooltip nil t)
              :foreground-color ,(face-foreground 'tooltip nil t)
              :lines-truncate t
              :poshandler posframe-poshandler-frame-center-near-bottom)))
    (add-hook 'after-load-theme-hook #'my-hydra-update-posframe-params t)))

(use-package pretty-hydra
  :ensure (:wait t)
  :demand t
  :functions icons-displayable-p
  :bind ("<f6>" . toggles-hydra/body)
  :hook (emacs-lisp-mode . (lambda ()
                             (add-to-list
                              'imenu-generic-expression
                              '("Hydras"
                                "^.*(\\(pretty-hydra-define\\) \\([a-zA-Z-]+\\)"
                                2))))
  :init
  (cl-defun pretty-hydra-title (title &optional icon-type icon-name
                                      &key face height v-adjust)
    "Add an icon in the hydra title."
    (let ((face (or face 'mode-line-emphasis))
          (height (or height 1.2))
          (v-adjust (or v-adjust 0.0)))
      (concat
       (when (and (display-graphic-p)
                  (or (featurep 'nerd-icons) (require 'nerd-icons nil t))
                  icon-type icon-name)
         (let ((f (intern (format "nerd-icons-%s" icon-type))))
           (when (fboundp f)
             (concat
              (apply f (list icon-name :face face :height height :v-adjust v-adjust))
              " "))))
       (propertize title 'face face))))

  ;; Global toggles
  (with-no-warnings
    (pretty-hydra-define toggles-hydra (:title (pretty-hydra-title "Toggles" 'faicon "nf-fa-toggle_on")
                                        :color amaranth :quit-key ("q" "C-g"))
      ("Basic"
       (("n" (cond ((fboundp 'display-line-numbers-mode)
                    (display-line-numbers-mode (if display-line-numbers-mode -1 1)))
                   ((fboundp 'gblobal-linum-mode)
                    (global-linum-mode (if global-linum-mode -1 1))))
         "line number"
         :toggle (or (bound-and-true-p display-line-numbers-mode)
                     (bound-and-true-p global-linum-mode)))
        ("a" global-aggressive-indent-mode "aggressive indent" :toggle t)
        ("d" global-hungry-delete-mode "hungry delete" :toggle t)
        ("e" electric-pair-mode "electric pair" :toggle t)
        ("c" flyspell-mode "spell check" :toggle t)
        ("s" prettify-symbols-mode "pretty symbol" :toggle t)
        ("l" global-page-break-lines-mode "page break lines" :toggle t)
        ("b" display-battery-mode "battery" :toggle t)
        ("i" display-time-mode "time" :toggle t)
        ("m" doom-modeline-mode "modern mode-line" :toggle t))
       "Highlight"
       (("h l" global-hl-line-mode "line" :toggle t)
        ("h p" show-paren-mode "paren" :toggle t)
        ("h s" symbol-overlay-mode "symbol" :toggle t)
        ("h r" rainbow-mode "rainbow" :toggle t)
        ("h w" (setq-default show-trailing-whitespace (not show-trailing-whitespace))
         "whitespace" :toggle show-trailing-whitespace)
        ("h d" rainbow-delimiters-mode "delimiter" :toggle t)
        ("h i" highlight-indent-guides-mode "indent" :toggle t)
        ("h t" global-hl-todo-mode "todo" :toggle t))
       "Program"
       (("f" flymake-mode "flymake" :toggle t)
        ("O" hs-minor-mode "hideshow" :toggle t)
        ("u" subword-mode "subword" :toggle t)
        ("W" which-function-mode "which function" :toggle t)
        ("E" toggle-debug-on-error "debug on error" :toggle (default-value 'debug-on-error))
        ("Q" toggle-debug-on-quit "debug on quit" :toggle (default-value 'debug-on-quit))
        ("v" global-diff-hl-mode "gutter" :toggle t)
        ("V" diff-hl-flydiff-mode "live gutter" :toggle t)
        ("M" diff-hl-margin-mode "margin gutter" :toggle t)
        ("D" diff-hl-dired-mode "dired gutter" :toggle t))
       "Theme"
       (("t a" (centaur-load-theme 'auto) "auto"
         :toggle (eq centaur-theme 'auto) :exit t)
        ("t r" (centaur-load-theme 'random) "random"
         :toggle (eq centaur-theme 'random) :exit t)
        ("t s" (centaur-load-theme 'system) "system"
         :toggle (eq centaur-theme 'system) :exit t)
        ("t d" (centaur-load-theme 'default) "default"
         :toggle (centaur-theme-enable-p 'default) :exit t)
        ("t p" (centaur-load-theme 'pro) "pro"
         :toggle (centaur-theme-enable-p 'pro) :exit t)
        ("t k" (centaur-load-theme 'dark) "dark"
         :toggle (centaur-theme-enable-p 'dark) :exit t)
        ("t l" (centaur-load-theme 'light) "light"
         :toggle (centaur-theme-enable-p 'light) :exit t)
        ("t w" (centaur-load-theme 'warm) "warm"
         :toggle (centaur-theme-enable-p 'warm) :exit t)
        ("t c" (centaur-load-theme 'cold) "cold"
         :toggle (centaur-theme-enable-p 'cold) :exit t)
        ("t y" (centaur-load-theme 'day) "day"
         :toggle (centaur-theme-enable-p 'day) :exit t)
        ("t n" (centaur-load-theme 'night) "night"
         :toggle (centaur-theme-enable-p 'night) :exit t)
        ("t o" (centaur-load-theme
                (intern (completing-read "Load custom theme: "
                                         (mapcar #'symbol-name
				                                 (custom-available-themes)))))
         "others"
         :toggle (not (or (rassoc (car custom-enabled-themes) centaur-theme-alist)
                          (rassoc (cadr custom-enabled-themes) centaur-theme-alist)))
         :exit t))
       "Package Archive"
       (("p m" (centaur-set-package-archives 'melpa t)
         "melpa" :toggle (eq centaur-package-archives 'melpa) :exit t)
        ("p b" (centaur-set-package-archives 'bfsu t)
         "bfsu" :toggle (eq centaur-package-archives 'bfsu) :exit t)
        ("p i" (centaur-set-package-archives 'iscas t)
         "iscas" :toggle (eq centaur-package-archives 'iscas) :exit t)
        ("p n" (centaur-set-package-archives 'netease t)
         "netease" :toggle (eq centaur-package-archives 'netease) :exit t)
        ("p s" (centaur-set-package-archives 'sjtu t)
         "sjtu" :toggle (eq centaur-package-archives 'sjtu) :exit t)
        ("p t" (centaur-set-package-archives 'tuna t)
         "tuna" :toggle (eq centaur-package-archives 'tuna) :exit t)
        ("p u" (centaur-set-package-archives 'ustc t)
         "ustc" :toggle (eq centaur-package-archives 'ustc) :exit t)
        ("p T" (centaur-test-package-archives) "speed test" :exit t))))))
#+end_src

* UI and Theming
** Fonts
#+begin_src emacs-lisp
(defun ar/set-fonts ()
  "Set the default, fixed-pitch, and variable-pitch fonts for the current frame."
  (set-face-attribute 'default nil :font "JetBrains Mono" :height 125 :weight 'medium)
  (set-face-attribute 'fixed-pitch nil :font "JetBrains Mono" :height 125 :weight 'medium)
  (set-face-attribute 'variable-pitch nil :font "JetBrains Mono" :height 125 :weight 'medium)
  ;; Apply italic slant to comments and keywords
  (set-face-attribute 'font-lock-comment-face nil :slant 'italic)
  (set-face-attribute 'font-lock-keyword-face nil :slant 'italic))

(if (daemonp)
    (add-hook 'elpaca-after-init-hook
              (lambda ()
                (add-hook 'after-make-frame-functions
                          (lambda (frame)
                            (with-selected-frame frame (ar/set-fonts))))))
  ;; For non-daemon mode, set fonts immediately
  (ar/set-fonts))

;; Line spacing
(setq-default line-spacing 0.02)

;; Font settings
(setq font-lock-maximum-decoration t
      inhibit-compacting-font-caches t)
#+end_src

** Title
#+begin_src emacs-lisp
(setq frame-title-format '("Emacs - %b")
      icon-title-format frame-title-format)
#+end_src

** Doom Themes
#+begin_src emacs-lisp
(use-package doom-themes
  :demand t
  :custom
  (doom-themes-enable-bold t)
  (doom-themes-enable-italic t)
  (doom-themes-treemacs-theme "doom-atom")
  :config
  (load-theme 'doom-tokyo-night t)
  (doom-themes-visual-bell-config)
  (doom-themes-neotree-config)
  (doom-themes-treemacs-config)
  (doom-themes-org-config))
#+end_src

** Solaire Mode
#+begin_src emacs-lisp
(use-package solaire-mode
  :hook (elpaca-after-init . solaire-global-mode))
#+end_src

** Modeline
#+begin_src emacs-lisp
(size-indication-mode -1)
(setq-default mode-line-percent-position nil)

(use-package doom-modeline
  :defer 0.1
  :hook (elpaca-after-init . doom-modeline-mode)
  :hook (doom-modeline-mode . column-number-mode)
  :init
  (setq projectile-dynamic-mode-line nil)
  (setq doom-modeline-bar-width 3
        doom-modeline-github nil
        doom-modeline-mu4e nil
        doom-modeline-persp-name nil
        doom-modeline-minor-modes nil
        doom-modeline-major-mode-icon nil
        doom-modeline-buffer-file-name-style 'relative-from-project)
  :config
  (setq doom-modeline-height 25
        doom-modeline-column-zero-based nil
        doom-modeline-bar-width 3
        doom-modeline-buffer-file-size nil
        doom-modeline-buffer-encoding nil
        doom-modeline-percent-position nil
        doom-modeline-vcs-icon t
        doom-modeline-vcs-max-length 0))

#+end_src

** Hide Modeline
#+begin_src emacs-lisp
(use-package hide-mode-line
  :autoload turn-off-hide-mode-line-mode
  :hook (((eat-mode
           eshell-mode shell-mode
           term-mode vterm-mode
           embark-collect-mode lsp-ui-imenu-mode
           pdf-annot-list-mode) . turn-on-hide-mode-line-mode)))
#+end_src

** Nerd Icons
#+begin_src emacs-lisp
(use-package nerd-icons
  :custom
  (nerd-icons-font-family "Symbols Nerd Font Mono")
  (nerd-icons-color-icons t)
  :config
  (setq inhibit-compacting-font-caches t))
#+end_src

** Dashboard
#+begin_src emacs-lisp
(use-package dashboard
  :init
  (setq dashboard-banner-logo-title "Welcome to Emacs!")
  (setq dashboard-startup-banner 'logo)
  ;; For example: (setq dashboard-startup-banner "~/.emacs.d/emacs_logo.png")

  ;; Set the content of the dashboard
  (setq dashboard-items '((recents   . 5)
                         (bookmarks . 5)
                         (projects  . 5)
                         (agenda    . 5)))

  ;; Center the dashboard content
  (setq dashboard-center-content t)

  ;; Enable icons
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (setq dashboard-icon-type 'nerd-icons)

  :config
  ;; Enable the dashboard on startup
  (dashboard-setup-startup-hook)
  ;; If you are using emacsclient, you'll want to see the dashboard when you create a new frame.
  (setq initial-buffer-choice (lambda () (get-buffer "*dashboard*"))))
#+end_src

** Line Numbers
#+begin_src emacs-lisp
(use-package display-line-numbers
  :ensure nil
  :hook ((prog-mode
          conf-mode toml-ts-mode
          yaml-mode yaml-ts-mode)
         . display-line-numbers-mode)
  :init (setq display-line-numbers-width-start t))
#+end_src

** Display dividers between windows
#+begin_src emacs-lisp
(setq window-divider-default-places t
      window-divider-default-bottom-width 1
      window-divider-default-right-width 1)
(add-hook 'window-setup-hook #'window-divider-mode)
#+end_src

** Text Scaling
#+begin_src emacs-lisp
(use-package default-text-scale
  :hook (elpaca-after-init . default-text-scale-mode))
#+end_src

** Scrolling
#+begin_src emacs-lisp
;; Scroll one line at a time (less "jumpy" than defaults)
(setq hscroll-step 1
      hscroll-margin 2
      scroll-step 1
      scroll-margin 0
      scroll-conservatively 100000
      scroll-preserve-screen-position t
      auto-window-vscroll nil
      ;; mouse
      mouse-wheel-scroll-amount-horizontal 1
      mouse-wheel-progressive-speed nil)

;; Smooth scrolling
(when (fboundp 'pixel-scroll-precision-mode) ;; 29+
  (use-package ultra-scroll
    :functions (hl-todo-mode diff-hl-flydiff-mode)
    :hook (elpaca-after-init . ultra-scroll-mode)
    :config
    (add-hook 'ultra-scroll-hide-functions #'diff-hl-flydiff-mode)
    (add-hook 'ultra-scroll-hide-functions #'hl-todo-mode)
    (add-hook 'ultra-scroll-hide-functions #'jit-lock-mode)))

#+end_src

* Org Mode
** Dynamic Directory Structure
#+begin_src emacs-lisp
;; Define base directory
(defvar my/org-directory (expand-file-name "~/org/")
  "Base directory for all org files.")

;; Define subdirectories relative to base
(defvar my/org-subdirs
  '("roam" "downloads" "noter" "archive"
    "roam/projects" "roam/literature" "roam/ideas" "roam/zettel"
    "attachments" "reviews" "backups")
  "List of subdirectories to create under `my/org-directory'.")

;; Helper function to get org subdirectory paths
(defun my/org-subdir (subdir)
  "Return full path for SUBDIR under `my/org-directory'."
  (expand-file-name subdir my/org-directory))

;; Lazy directory creation - only when needed
(defun my/ensure-org-dir (subdir)
  "Ensure SUBDIR exists under `my/org-directory'."
  (let ((dir (my/org-subdir subdir)))
    (unless (file-directory-p dir)
      (make-directory dir t))
    dir))

;; Create all directories at startup
(mapc #'my/ensure-org-dir my/org-subdirs)

;; Define convenience variables
(defvar my/org-roam-directory (my/org-subdir "roam/"))
(defvar my/org-downloads-directory (my/org-subdir "downloads/"))
(defvar my/org-noter-directory (my/org-subdir "noter/"))
(defvar my/org-archive-directory (my/org-subdir "archive/"))
#+end_src

** Better Font Faces
#+begin_src emacs-lisp
(defun ar/org-font-setup ()
  ;; Replace list hyphen with dot
  (font-lock-add-keywords 'org-mode
                          '(("^ *\\([-]\\) "
                             (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "•"))))))

  ;; Set faces for heading levels
  (dolist (face '((org-level-1 . 1.20)
                  (org-level-2 . 1.13)
                  (org-level-3 . 1.10)
                  (org-level-4 . 1.07)
                  (org-level-5 . 1.05)
                  (org-level-6 . 1.03)
                  (org-level-7 . 1.02)
                  (org-level-8 . 1)))
    (set-face-attribute (car face) nil :font "JetBrains Mono" :weight 'bold :height (cdr face))))
#+end_src

** Core Configuration
=Disable large file optimizations for now=
=add redisplay inline images=
#+begin_src emacs-lisp
(use-package org
  :ensure nil
  :pretty-hydra
  ;; See `org-structure-template-alist'
  ((:title (pretty-hydra-title "Org Template" 'sucicon "nf-custom-orgmode" :face 'nerd-icons-green)
    :color blue :quit-key ("q" "C-g"))
   ("Basic"
    (("a" (hot-expand "<a") "ascii")
     ("c" (hot-expand "<c") "center")
     ("C" (hot-expand "<C") "comment")
     ("x" (hot-expand "<e") "example")
     ("E" (hot-expand "<E") "export")
     ("h" (hot-expand "<h") "html")
     ("l" (hot-expand "<l") "latex")
     ("n" (hot-expand "<n") "note")
     ("o" (hot-expand "<q") "quote")
     ("v" (hot-expand "<v") "verse"))
    "Head"
    (("i" (hot-expand "<i") "index")
     ("A" (hot-expand "<A") "ASCII")
     ("I" (hot-expand "<I") "INCLUDE")
     ("H" (hot-expand "<H") "HTML")
     ("L" (hot-expand "<L") "LaTeX"))
    "Source"
    (("s" (hot-expand "<s") "src")
     ("e" (hot-expand "<s" "emacs-lisp") "emacs-lisp")
     ("y" (hot-expand "<s" "python :results output") "python")
     ("p" (hot-expand "<s" "perl") "perl")
     ("w" (hot-expand "<s" "powershell") "powershell")
     ("r" (hot-expand "<s" "ruby") "ruby")
     ("S" (hot-expand "<s" "sh") "sh")
     ("g" (hot-expand "<s" "go :imports '\(\"fmt\"\)") "golang"))
    "Misc"
    (("m" (hot-expand "<s" "mermaid :file chart.png") "mermaid")
     ("u" (hot-expand "<s" "plantuml :file chart.png") "plantuml")
     ("Y" (hot-expand "<s" "ipython :session :exports both :results raw drawer\n$0") "ipython")
     ("P" (progn
            (insert "#+HEADERS: :results output :exports both :shebang \"#!/usr/bin/env perl\"\n")
            (hot-expand "<s" "perl")) "Perl tangled")
     ("<" self-insert-command "ins"))))

  :bind (:map org-mode-map
         ("<" . (lambda ()
                  "Insert org template."
                  (interactive)
                  (if (or (region-active-p) (looking-back "^\s*" 1))
                      (org-hydra/body)
                    (self-insert-command 1)))))

  :hook ((org-mode . (lambda ()
                       (electric-indent-local-mode -1)
                       (evil-define-key 'normal org-mode-map (kbd "TAB") 'org-cycle)))

	     (org-mode . visual-line-mode)
	     (org-mode . ar/org-font-setup)
	     (org-mode . auto-fill-mode)
         (org-mode . (lambda () (setq-local yas-parents '(latex-mode))))
	     (org-agenda-mode . (lambda ()
                              (visual-line-mode -1)
                              (toggle-truncate-lines 1)
                              (display-line-numbers-mode -1)
                              (setq mode-line-format nil)
                              (setq header-line-format nil)))
	     (org-capture-mode . (lambda ()
                               (setq mode-line-format nil)
                               (setq header-line-format nil))))

  :custom
  (org-modules nil)
  (org-directory my/org-directory)
  (org-log-done 'time)
  (org-pretty-entities t)
  (org-log-into-drawer t)
  (org-return-follows-link t)
  (org-src-fontify-natively t)
  (org-element-use-cache t)
  (org-hide-leading-stars t)
  (org-fontify-done-headline t)
  (org-fontify-todo-headline t)
  (org-fontify-whole-heading-line t)
  (org-fontify-quote-and-verse-blocks t)
  (org-hide-emphasis-markers t)
  (org-element-cache-persistent t)
  ;; (org-fontify-quote-and-verse-blocks nil)
  ;; (org-fontify-whole-heading-line nil)
  ;; (org-fontify-done-headline nil)
  (org-highlight-latex-and-related nil)
  (org-src-preserve-indentation t)
  (org-edit-src-content-indentation 0)
  (org-startup-folded 'overview)
  (org-startup-with-inline-images nil)
  (org-startup-with-latex-preview nil)
  (org-cycle-separator-lines 2)

  (org-todo-keywords
   '((sequence "TODO(t)" "NEXT(n)" "PROG(p)" "WAIT(w@/!)" "|" "DONE(d!)" "CANCEL(c@)")
	 (sequence "PLAN(P)" "ACTIVE(A)" "PAUSED(x)" "|" "ACHIEVED(a)" "DROPPED(D)")))

  (org-todo-keyword-faces
   '(("TODO"      . (:foreground "#f7768e" :weight bold))
     ("NEXT"      . (:foreground "#ff9e64" :weight bold))
     ("PROG"      . (:foreground "#7aa2f7" :weight bold))
     ("WAIT"      . (:foreground "#e0af68" :weight bold))
     ("DONE"      . (:foreground "#9ece6a" :weight bold))
     ("CANCEL"    . (:foreground "#565f89" :weight bold))
     ("PLAN"      . (:foreground "#7dcfff" :weight bold))
     ("ACTIVE"    . (:foreground "#bb9af7" :weight bold))
     ("PAUSED"    . (:foreground "#a9b1d6" :weight bold))
     ("ACHIEVED"  . (:foreground "#9ece6a" :weight bold))
     ("DROPPED"   . (:foreground "#565f89" :weight bold))))

  (org-tag-alist '(("@work"      . ?w)
		   ("@home"      . ?h)
		   ("@computer"  . ?c)
		   ("@errands"   . ?e)
		   ("read"       . ?r)
		   ("meeting"    . ?m)
		   ("urgent"     . ?u)
		   ("someday"    . ?s)))


  (org-priority-faces '((?A . error)
                        (?B . warning)
                        (?C . success)))

  ;; Agenda styling
  (org-agenda-files (list my/org-directory))
  (org-agenda-block-separator ?─)
  (org-agenda-time-grid
   '((daily today require-timed)
     (800 1000 1200 1400 1600 1800 2000)
     " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄"))
  (org-agenda-current-time-string
   "⭠ now ─────────────────────────────────────────────────")
  (org-agenda-inhibit-startup t)
  (org-agenda-dim-blocked-tasks nil)
  (org-agenda-use-tag-inheritance nil)
  (org-agenda-ignore-properties '(effort appt category))
  (org-agenda-span 'day)
  (org-tags-column -80)
  (org-catch-invisible-edits 'smart)

  :config
  (defun hot-expand (str &optional mod)
    (let (text)
      (when (region-active-p)
        (setq text (buffer-substring (region-beginning) (region-end)))
        (delete-region (region-beginning) (region-end)))
      (insert str)
      (if (fboundp 'org-try-structure-completion)
          (org-try-structure-completion) ; < org 9
        (progn
          ;; New template expansion since org 9
          (require 'org-tempo nil t)
          (org-tempo-complete-tag)))
      (when mod (insert mod) (forward-line))
      (when text (insert text))))

  ;; Babel
  (setq org-confirm-babel-evaluate nil
        org-src-fontify-natively t
        org-src-tab-acts-natively t)

  (defconst load-language-alist
    '((emacs-lisp . t)
      (perl       . t)
      (python     . t)
      (ruby       . t)
      (js         . t)
      (css        . t)
      (sass       . t)
      (C          . t)
      (java       . t)
      (shell      . t)
      (plantuml   . t))
    "Alist of org ob languages.")

  (org-babel-do-load-languages 'org-babel-load-languages
                               load-language-alist)

  (org-babel-do-load-languages 'org-babel-load-languages
                               load-language-alist)

  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python"))
  (add-to-list 'org-structure-template-alist '("jpy" . "src jupyter-python"))
  (add-to-list 'org-structure-template-alist '("tex" . "src latex")))
#+end_src

** Org Appear
#+begin_src emacs-lisp
(use-package org-appear
  :hook (org-mode . org-appear-mode)
  :custom
  (org-appear-autoentities t)
  (org-appear-autokeywords t)
  (org-appear-autolinks t)
  (org-appear-autosubmarkers t)
  (org-appear-inside-latex t)
  (org-appear-manual-linger t)
  (org-appear-delay 0.5))
#+end_src

** Org Roam
#+begin_src emacs-lisp
;; Org-Roam Configuration
(when (and (fboundp 'sqlite-available-p) (sqlite-available-p))
  (use-package org-roam
    :defer t
    :functions org-roam-db-autosync-enable
    :defines org-roam-graph-viewer
    :init
    (setq org-roam-directory (expand-file-name "roam/" my/org-directory))
    :custom
    (org-roam-completion-everywhere t)
    (org-roam-node-display-template
     (concat "${title:*} "
             (propertize "${tags:20}" 'face 'org-tag)))
    :config
    (add-to-list 'org-agenda-files org-roam-directory)
    (org-roam-db-autosync-enable)

    ;; Templates for different kinds of notes (Zettelkasten)
    (setq org-roam-capture-templates
          '(("d" "default" plain "%?"
             :target (file+head "${slug}.org"
                                "#+title: ${title}\n#+filetags: \n\n")
             :unnarrowed t)

            ("p" "project" plain "* Goal\n\n%?\n\n* Tasks\n\n* Notes\n\n* Log\n"
             :target (file+head "projects/${slug}.org"
                                "#+title: Project: ${title}\n#+filetags: project\n")
             :unnarrowed t)

            ("l" "literature note" plain "* Source\n- Author: %?\n- Title: \n- Year: \n\n* Summary\n\n* Key Takeaways\n\n* Quotes\n"
             :target (file+head "literature/${slug}.org"
                                "#+title: ${title}\n#+filetags: literature\n")
             :unnarrowed t)

            ("i" "idea" plain "* %?"
             :target (file+head "ideas/${slug}.org"
                                "#+title: ${title}\n#+filetags: idea fleeting\n")
             :unnarrowed t)

            ("z" "zettel" plain "* %?\n\n* References\n\n"
             :target (file+head "zettel/${slug}.org"
                                "#+title: ${title}\n#+filetags: zettel permanent\n")
             :unnarrowed t)))

    ;; Dailies configuration
    (setq org-roam-dailies-directory "daily/"
          org-roam-dailies-capture-templates
          '(("d" "default" entry "* %?"
             :target (file+head "%<%Y-%m-%d>.org"
                                "#+title: %<%Y-%m-%d %A>\n\n"))

            ("j" "journal" entry "* %<%H:%M> - Journal\n\n%?"
             :target (file+head "%<%Y-%m-%d>.org"
                                "#+title: %<%Y-%m-%d %A>\n\n"))

            ("m" "meeting" entry "* %<%H:%M> - %^{Meeting Title}\n\n** Attendees\n- %?\n\n** Notes\n\n** Action Items\n"
             :target (file+head "%<%Y-%m-%d>.org"
                                "#+title: %<%Y-%m-%d %A>\n\n"))))))

(use-package org-roam-ui
  :after org-roam
  :commands (org-roam-ui-mode org-roam-ui-open)
  :custom
  (org-roam-ui-sync-theme t)
  (org-roam-ui-follow t)
  (org-roam-ui-update-on-save t)
  (org-roam-ui-open-on-start nil))

(use-package consult-org-roam
   :after org-roam
   :init
   (require 'consult-org-roam)
   ;; Activate the minor mode
   (consult-org-roam-mode 1)
   :custom
   ;; Use `ripgrep' for searching with `consult-org-roam-search'
   (consult-org-roam-grep-func #'consult-ripgrep)
   ;; Configure a custom narrow key for `consult-buffer'
   (consult-org-roam-buffer-narrow-key ?r)
   ;; Display org-roam buffers right after non-org-roam buffers
   ;; in consult-buffer (and not down at the bottom)
   (consult-org-roam-buffer-after-buffers t)
   :config
   ;; Eventually suppress previewing for certain functions
   (consult-customize
    consult-org-roam-forward-links
    :preview-key "M-."))
#+end_src

** Capture: The Gateway to Org
*Use dynamic directory*
#+begin_src emacs-lisp
(defun my/find-org-projects ()
  "Find all org files in the projects directory."
  (directory-files (expand-file-name "projects" my/org-directory) t "\\.org$"))

(use-package org-capture
  :defer t
  :ensure nil
  :after org
  :custom
  (org-capture-templates
   `(("t" "Task" entry
      (file+headline ,(expand-file-name "inbox.org" my/org-directory) "Tasks")
      "* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:\n")

     ("n" "Note" entry
      (file+headline ,(expand-file-name "inbox.org" my/org-directory) "Notes")
      "* %? :note:\n:PROPERTIES:\n:CREATED: %U\n:SOURCE:\n:END:\n")

     ("j" "Journal" entry
      (file+olp+datetree ,(expand-file-name "journal.org" my/org-directory))
      "* %U %?\n")

     ("m" "Meeting" entry
      (file+headline ,(expand-file-name "inbox.org" my/org-directory) "Meetings")
      "* Meeting: %? :meeting:\n:PROPERTIES:\n:CREATED: %U\n:ATTENDEES:\n:END:\n** Agenda\n** Notes\n** Action Items\n")

     ("p" "Project" entry
      (file+headline ,(expand-file-name "projects.org" my/org-directory) "Projects")
      "* PLAN %? :project:\n:PROPERTIES:\n:CREATED: %U\n:GOAL:\n:DEADLINE:\n:END:\n** Goals\n** Tasks\n*** TODO Define project scope\n** Resources\n** Notes\n")

     ("P" "Project Task" entry
      (file (lambda ()
              (let* ((files (my/find-org-projects))
                     (file (completing-read "Select Project: "
                                           (mapcar #'file-name-nondirectory files)
                                           nil t)))
                (car (seq-filter
                      (lambda (f) (string= (file-name-nondirectory f) file))
                      files)))))
      "* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:\n"
      :prepend t
      :headline "Tasks")

     ("b" "Book" entry
      (file+headline ,(expand-file-name "reading.org" my/org-directory) "Reading List")
      "* %? :book:read:\n:PROPERTIES:\n:CREATED: %U\n:AUTHOR:\n:GENRE:\n:PAGES:\n:STARTED:\n:FINISHED:\n:RATING:\n:END:\n** Summary\n** Key Takeaways\n** Quotes\n")

     ("h" "Habit" entry
      (file+headline ,(expand-file-name "habits.org" my/org-directory) "Habits")
      "* TODO %? :habit:\nSCHEDULED: %(format-time-string \"<%Y-%m-%d %a .+1d>\")\n:PROPERTIES:\n:CREATED: %U\n:STYLE: habit\n:END:\n")

     ("g" "Goal" entry
      (file+headline ,(expand-file-name "goals.org" my/org-directory) "Goals")
      "* GOAL %? :goal:\nDEADLINE: %(org-read-date nil nil \"+1y\")\n:PROPERTIES:\n:CREATED: %U\n:TYPE:\n:END:\n** Why this goal?\n** Success criteria\n** Action steps\n*** TODO Break down into smaller tasks\n** Resources needed\n** Potential obstacles\n** Progress tracking\n"))))
#+end_src

** Org Habit
#+begin_src emacs-lisp
(use-package org-habit
  :ensure nil
  :defer t
  :after org
  :custom
  (org-habit-graph-column 60)
  (org-habit-show-habits-only-for-today t)
  (org-habit-preceding-days 21)
  (org-habit-following-days 7)
  (org-habit-completed-glyph
   (string-to-char (nerd-icons-codicon "nf-cod-check")))
  (org-habit-today-glyph
   (string-to-char (nerd-icons-codicon "nf-cod-circle_filled"))))
#+end_src

** Org Download
#+begin_src emacs-lisp
(use-package org-download
  :defer t
  :after org
  :custom
  (org-download-screenshot-method "grim -g \"$(slurp)\" - | swappy -f - -o -")
  (org-download-image-dir "assets")
  (org-download-method 'attach)
  (org-download-timestamp "%Y-%m-%d-%H%M%S_")
  (org-download-display-inline t)
  (org-image-actual-width 600)
  :config
  (advice-add 'org-download-dnd :after #'org-download-display-inline-images))
#+end_src

** Org Modern
#+begin_src emacs-lisp
(use-package org-modern
  :hook (org-mode . org-modern-mode)
  :config
  (setq org-modern-hide-stars nil
        org-modern-star '("◉" "○" "◈" "◇" "◆" "▷")
        org-modern-list '((43 . "➤") (45 . "–") (42 . "•"))
        org-modern-table-vertical 1
        org-modern-table-horizontal 0.1
        org-modern-block-name
        '(("src" "»" "«")
          ("example" "»" "«")
          ("quote" """ """))

        org-modern-todo-faces
        '(("TODO"      . (:foreground "#f7768e" :weight bold))
          ("NEXT"      . (:foreground "#ff9e64" :weight bold))
          ("PROG"      . (:foreground "#7aa2f7" :weight bold))
          ("WAIT"      . (:foreground "#e0af68" :weight bold))
          ("DONE"      . (:background "#20293a" :foreground "#9ece6a" :weight bold))
          ("CANCEL"    . (:strike-through t :foreground "#565f89"))
          ("PLAN"      . (:foreground "#7dcfff" :weight bold))
          ("ACTIVE"    . (:foreground "#bb9af7" :weight bold))
          ("PAUSED"    . (:foreground "#a9b1d6" :weight bold))
          ("ACHIEVED"  . (:background "#20293a" :foreground "#9ece6a" :weight bold :box t))
          ("DROPPED"   . (:strike-through t :foreground "#565f89")))

        org-modern-tag-faces
        `((:foreground "#a9b1d6" :weight bold :box (:line-width (1 . -1) :color "#414868")))
        org-modern-checkbox '((todo . "☐") (done . "☑") (cancel . "☑") (priority . "⚑") (on . "◉") (off . "◯"))))
#+end_src

* Elisp
#+begin_src emacs-lisp
(use-package elisp-mode
  :ensure nil
  :config
  (with-no-warnings
    (defun my-lisp-indent-function (indent-point state)
      (let ((normal-indent (current-column))
            (orig-point (point)))
        (goto-char (1+ (elt state 1)))
        (parse-partial-sexp (point) calculate-lisp-indent-last-sexp 0 t)
        (cond
         ((and (elt state 2)
               (or (not (looking-at "\\sw\\|\\s_"))
                   (looking-at ":")))
          (if (not (> (save-excursion (forward-line 1) (point))
                     calculate-lisp-indent-last-sexp))
              (progn (goto-char calculate-lisp-indent-last-sexp)
                     (beginning-of-line)
                     (parse-partial-sexp (point)
                                         calculate-lisp-indent-last-sexp 0 t)))
          (backward-prefix-chars)
          (current-column))
         ((and (save-excursion
                 (goto-char indent-point)
                 (skip-syntax-forward " ")
                 (not (looking-at ":")))
               (save-excursion
                 (goto-char orig-point)
                (looking-at ":")))
         (save-excursion
           (goto-char (+ 2 (elt state 1)))
           (current-column)))
        (t
         (let ((function (buffer-substring (point)
                                           (progn (forward-sexp 1) (point))))
               method)
           (setq method (or (function-get (intern-soft function)
                                          'lisp-indent-function)
                            (get (intern-soft function) 'lisp-indent-hook)))
           (cond ((or (eq method 'defun)
                      (and (null method)
                           (length> function 3)
                           (string-match "\\`def" function)))
                  (lisp-indent-defform state indent-point))
                 ((integerp method)
                  (lisp-indent-specform method state
                                        indent-point normal-indent))
                 (method
                  (funcall method indent-point state))))))))
   (add-hook 'emacs-lisp-mode-hook
             (lambda () (setq-local lisp-indent-function #'my-lisp-indent-function)))

   ;; Add remove buttons for advices
   (add-hook 'help-mode-hook 'cursor-sensor-mode)

   (defun function-advices (function)
     "Return FUNCTION's advices."
     (let ((flist (indirect-function function)) advices)
       (while (advice--p flist)
         (setq advices `(,@advices ,(advice--car flist)))
         (setq flist (advice--cdr flist)))
       advices))

   (defun add-remove-advice-button (advice function)
     (when (and (functionp advice) (functionp function))
       (let ((inhibit-read-only t)
             (msg (format "Remove advice `%s'" advice)))
         (insert "\t")
         (insert-button
          "Remove"
          'face 'custom-button
          'cursor-sensor-functions `((lambda (&rest _) ,msg))
          'help-echo msg
          'action (lambda (_)
                    (when (yes-or-no-p msg)
                      (message "%s from function `%s'" msg function)
                      (advice-remove function advice)
                      (if (eq major-mode 'helpful-mode)
                          (helpful-update)
                        (revert-buffer nil t))))
          'follow-link t))))

   (defun add-button-to-remove-advice (buffer-or-name function)
     "Add a button to remove advice."
     (with-current-buffer buffer-or-name
       (save-excursion
         (goto-char (point-min))
         (let ((ad-list (function-advices function)))
           (while (re-search-forward "^\\(?:This function has \\)?:[-a-z]+ advice: \\(.+\\)$" nil t)
             (let ((advice (car ad-list)))
               (add-remove-advice-button advice function)
               (setq ad-list (delq advice ad-list))))))))

   (define-advice describe-function-1 (:after (function) advice-remove-button)
     (add-button-to-remove-advice (help-buffer) function))
   (with-eval-after-load 'helpful
     (define-advice helpful-update (:after () advice-remove-button)
       (when helpful--callable-p
         (add-button-to-remove-advice (current-buffer) helpful--sym))))

   ;; Remove hooks
   (defun remove-hook-at-point ()
     "Remove the hook at the point in the *Help* buffer."
     (interactive)
     (unless (memq major-mode '(help-mode helpful-mode))
       (error "Only for help-mode or helpful-mode"))

     (let ((orig-point (point)))
       (save-excursion
         (when-let*
             ((hook (progn (goto-char (point-min)) (symbol-at-point)))
              (func (when (and
                           (or (re-search-forward (format "^Value:?[\s|\n]") nil t)
                               (goto-char orig-point))
                           (sexp-at-point))
                      (end-of-sexp)
                      (backward-char 1)
                      (catch 'break
                        (while t
                          (condition-case _err
                              (backward-sexp)
                            (scan-error (throw 'break nil)))
                          (let ((bounds (bounds-of-thing-at-point 'sexp)))
                            (when (<= (car bounds) orig-point (cdr bounds))
                              (throw 'break (sexp-at-point)))))))))
           (when (yes-or-no-p (format "Remove %s from %s? " func hook))
             (remove-hook hook func)
             (if (eq major-mode 'helpful-mode)
                 (helpful-update)
               (revert-buffer nil t)))))))
   (bind-key "r" #'remove-hook-at-point help-mode-map)))

;; Syntax highlighting of known Elisp symbols
(if (boundp 'elisp-fontify-semantically)
    (setq elisp-fontify-semantically t)
  (use-package highlight-defined
    :hook ((emacs-lisp-mode inferior-emacs-lisp-mode) . highlight-defined-mode)))

(use-package macrostep)

;; A better *Help* buffer
(use-package helpful
  :bind (([remap describe-function] . helpful-callable)
         ([remap describe-command]  . helpful-command)
         ([remap describe-variable] . helpful-variable)
         ([remap describe-key]      . helpful-key)
         ([remap describe-symbol]   . helpful-symbol))
  :hook (helpful-mode . cursor-sensor-mode) ; for remove-advice button
  :init
  (with-no-warnings
    (with-eval-after-load 'apropos
      ;; patch apropos buttons to call helpful instead of help
      (dolist (fun-bt '(apropos-function apropos-macro apropos-command))
        (button-type-put
         fun-bt 'action
         (lambda (button)
           (helpful-callable (button-get button 'apropos-symbol)))))
      (dolist (var-bt '(apropos-variable apropos-user-option))
        (button-type-put
         var-bt 'action
         (lambda (button)
           (helpful-variable (button-get button 'apropos-symbol))))))))
#+end_src

* General Keybindings
#+begin_src emacs-lisp
(use-package general
  :after evil
  :ensure (:wait t)
  :demand t
  :config
  ;; Set up leader keys
  (general-create-definer ar/global-leader
    :states '(normal insert visual emacs)
    :prefix "SPC"
    :global-prefix "C-SPC")

  (general-create-definer ar/local-leader
    :states '(normal insert visual emacs)
    :prefix "SPC m"
    :global-prefix "C-SPC m")

  (ar/global-leader
    "SPC" '(execute-extended-command :wk "M-x")
    ":" '(eval-expression :wk "Eval")
    ";" '(evilnc-comment-or-uncomment-lines :wk "Comment")
    "u" '(universal-argument :wk "Universal arg")
    "!" '(shell-command :wk "Shell cmd")
    "X" '(org-capture :wk "Org capture"))

  ;; File operations (SPC f)
  (ar/global-leader
    "f" '(:ignore t :wk "file")
    "f f" '(find-file :wk "Find file")
    "f r" '(consult-recent-file :wk "Recent files")
    "f s" '(save-buffer :wk "Save file")
    "f S" '(write-file :wk "Save as")
    "f D" '(delete-this-file :wk "Delete file")
    "f R" '(rename-this-file :wk "Rename file")
    "f c" '(copy-file-name :wk "Copy filename")
    "f y" '(copy-file-name :wk "Yank filename")
    "f E" '(sudo-edit :wk "Sudo edit")
    "f l" '(reload-init-file :wk "Reload config")
    "f e" '(:ignore t :wk "emacs")
    "f e d" '((lambda () (interactive) (find-file user-emacs-directory)) :wk "Open emacs.d")
    "f e i" '((lambda () (interactive) (find-file user-init-file)) :wk "Open init.el")
    "f e c" '(find-custom-file :wk "Open custom.el")
    "f d" '(consult-dir :wk "Change directory")
    "f j" '(consult-dir-jump-file :wk "Jump to file in dir"))

  ;; Buffer operations (SPC b)
  (ar/global-leader
    "b" '(:ignore t :wk "buffer")
    "b b" '(consult-buffer :wk "Switch buffer")
    "b i" '(ibuffer :wk "Ibuffer")
    "b k" '(kill-current-buffer :wk "Kill buffer")
    "b K" '(kill-buffer :wk "Kill buffer (choose)")
    "b n" '(next-buffer :wk "Next buffer")
    "b p" '(previous-buffer :wk "Previous buffer")
    "b r" '(revert-buffer-quick :wk "Revert buffer")
    "b R" '(rename-buffer :wk "Rename buffer")
    "b s" '(create-scratch-buffer :wk "Scratch buffer")
    "b S" '(save-buffer :wk "Save buffer")
    "b y" '(copy-file-name :wk "Copy buffer name")
    "b z" '(bury-buffer :wk "Bury buffer")
    "b [" '(previous-buffer :wk "Previous buffer")
    "b ]" '(next-buffer :wk "Next buffer"))

  ;; Search operations (SPC s)
  (ar/global-leader
    "s" '(:ignore t :wk "search")
    "s s" '(consult-line :wk "Search buffer")
    "s S" '(consult-line-multi :wk "Search buffers")
    "s p" '(consult-ripgrep :wk "Search project")
    "s d" '(consult-dir :wk "Search directory")
    "s i" '(consult-imenu :wk "Imenu")
    "s I" '(consult-imenu-multi :wk "Imenu multi")
    "s o" '(consult-outline :wk "Outline")
    "s b" '(consult-line :wk "Search buffer")
    "s j" '(evil-show-jumps :wk "Jump list")
    "s m" '(consult-mark :wk "Mark ring")
    "s r" '(rg :wk "Ripgrep")
    "s e" '(consult-isearch-history :wk "Search history")
    "s y" '(consult-yasnippet :wk "Yasnippet")
    "s t" '(hl-todo-occur :wk "Todo list")
    "s T" '(hl-todo-rg-project :wk "Todo in project")

    "s h" '(:ignore t :wk "highlight")
    "s h h" '(symbol-overlay-put :wk "Highlight symbol")
    "s h c" '(symbol-overlay-remove-all :wk "Clear highlights")
    "s h n" '(symbol-overlay-jump-next :wk "Next occurrence")
    "s h p" '(symbol-overlay-jump-prev :wk "Prev occurrence")
    "s h d" '(symbol-overlay-jump-to-definition :wk "Jump to definition")
    "s h r" '(symbol-overlay-rename :wk "Rename symbol")
    "s h q" '(symbol-overlay-query-replace :wk "Query replace")
    "s h t" '(symbol-overlay-toggle-in-scope :wk "Toggle scope")
    "s h w" '(symbol-overlay-save-symbol :wk "Copy symbol")
    "s h m" '(symbol-overlay-mode :wk "Symbol overlay mode"))

  ;; Window operations (SPC w)
  (ar/global-leader
    "w" '(:ignore t :wk "window")
    "w w" '(other-window :wk "Other window")
    "w d" '(delete-window :wk "Delete window")
    "w D" '(delete-other-windows :wk "Delete other windows")
    "w s" '(split-window-below :wk "Split below")
    "w v" '(split-window-right :wk "Split right")
    "w h" '(evil-window-left :wk "Window left")
    "w j" '(evil-window-down :wk "Window down")
    "w k" '(evil-window-up :wk "Window up")
    "w l" '(evil-window-right :wk "Window right")
    "w H" '(evil-window-move-far-left :wk "Move far left")
    "w J" '(evil-window-move-very-bottom :wk "Move bottom")
    "w K" '(evil-window-move-very-top :wk "Move top")
    "w L" '(evil-window-move-far-right :wk "Move far right")
    "w =" '(balance-windows :wk "Balance windows")
    "w m" '(delete-other-windows :wk "Maximize")
    "w o" '(other-window :wk "Other window")
    "w u" '(winner-undo :wk "Winner undo")
    "w r" '(winner-redo :wk "Winner redo")
    "w t" '(toggle-window-split :wk "Toggle split")
    "w _" '(split-window-vertically-instead :wk "Split vertically instead")
    "w |" '(split-window-horizontally-instead :wk "Split horizontally instead"))

  ;; Project operations (SPC p)
  (ar/global-leader
    "p" '(:ignore t :wk "project")
    "p p" '(project-switch-project :wk "Switch project")
    "p f" '(project-find-file :wk "Find file in project")
    "p s" '(consult-ripgrep :wk "Search project")
    "p b" '(consult-project-buffer :wk "Project buffers")
    "p k" '(project-kill-buffers :wk "Kill project buffers")
    "p c" '(project-compile :wk "Compile project")
    "p d" '(project-dired :wk "Dired project root")
    "p e" '(project-eshell :wk "Eshell in project")
    "p t" '(treemacs :wk "Treemacs"))

  ;; Toggle operations (SPC t)
  (ar/global-leader
    "t" '(:ignore t :wk "toggle")
    "t l" '(display-line-numbers-mode :wk "Line numbers")
    "t w" '(whitespace-mode :wk "Whitespace")
    "t f" '(toggle-frame-fullscreen :wk "Fullscreen")
    "t m" '(toggle-frame-maximized :wk "Maximize")
    "t t" '(consult-theme :wk "Theme")
    "t v" '(visual-line-mode :wk "Visual line mode")
    "t i" '(highlight-indent-guides-mode :wk "Indent guides")
    "t r" '(rainbow-mode :wk "Rainbow mode")
    "t h" '(global-hl-line-mode :wk "Highlight line")
    "t p" '(show-paren-mode :wk "Show paren")
    "t T" '(toggles-hydra/body :wk "Toggles hydra")
    "t o" '(olivetti-mode :wk "Olivetti mode")
    "t z" '(:ignore t :wk "transparency")
    "t z i" '(transwin-inc :wk "Increase")
    "t z d" '(transwin-dec :wk "Decrease")
    "t z t" '(transwin-toggle :wk "Toggle"))

  ;; Open operations (SPC o)
  (ar/global-leader
    "o" '(:ignore t :wk "open")
    "o p" '(treemacs :wk "Treemacs")
    "o t" '(vterm :wk "Terminal")
    "o e" '(eshell :wk "Eshell")
    "o s" '(shell :wk "Shell")
    "o d" '(dired :wk "Dired")
    "o D" '(dashboard-open :wk "Dashboard")
    "o P" '(popper-toggle :wk "Toggle popup"))

  ;; Help operations (SPC h)
  (ar/global-leader
    "h" '(:ignore t :wk "help")
    "h f" '(helpful-callable :wk "Describe function")
    "h v" '(helpful-variable :wk "Describe variable")
    "h k" '(helpful-key :wk "Describe key")
    "h m" '(describe-mode :wk "Describe mode")
    "h o" '(helpful-symbol :wk "Describe symbol")
    "h c" '(helpful-command :wk "Describe command")
    "h ." '(helpful-at-point :wk "Describe at point")
    "h i" '(info :wk "Info")
    "h I" '(consult-info :wk "Consult info")
    "h p" '(describe-package :wk "Describe package")
    "h a" '(apropos :wk "Apropos")
    "h w" '(woman :wk "Woman")
    "h r" '(:ignore t :wk "reload")
    "h r r" '(reload-init-file :wk "Reload config"))

  ;; Code operations (SPC c)
  (ar/global-leader
    "c" '(:ignore t :wk "code")
    "c a" '(lsp-execute-code-action :wk "Code action")
    "c d" '(lsp-find-definition :wk "Definition")
    "c D" '(lsp-find-declaration :wk "Declaration")
    "c r" '(lsp-find-references :wk "References")
    "c i" '(lsp-find-implementation :wk "Implementation")
    "c t" '(lsp-find-type-definition :wk "Type definition")
    "c s" '(consult-lsp-symbols :wk "Symbols")
    "c S" '(lsp-ui-doc-show :wk "Show doc")
    "c f" '(lsp-format-buffer :wk "Format buffer")
    "c F" '(lsp-format-region :wk "Format region")
    "c o" '(lsp-organize-imports :wk "Organize imports")
    "c R" '(lsp-rename :wk "Rename")
    "c e" '(consult-flymake :wk "Errors")
    "c x" '(quickrun :wk "Quickrun")
    "c X" '(quickrun-shell :wk "Quickrun shell")
    "c c" '(compile :wk "Compile")
    "c C" '(recompile :wk "Recompile")
    "c l" '(:ignore t :wk "lsp")
    "c l r" '(lsp-workspace-restart :wk "Restart workspace")
    "c l s" '(lsp-workspace-shutdown :wk "Shutdown workspace")
    "c l d" '(lsp-describe-session :wk "Describe session")
    "c l D" '(lsp-disconnect :wk "Disconnect")
    "c l u" '(lsp-ui-hydra/body :wk "LSP UI hydra")
    "c l i" '(lsp-ui-imenu :wk "LSP Imenu")
    "c l t" '(lsp-treemacs-symbols :wk "Treemacs symbols")
    "c l e" '(lsp-treemacs-errors-list :wk "Treemacs errors"))

  ;; Git operations (SPC g)
  (ar/global-leader
    "g" '(:ignore t :wk "git")
    "g g" '(magit-status :wk "Magit status")
    "g s" '(magit-status :wk "Status")
    "g d" '(magit-diff :wk "Diff")
    "g D" '(magit-diff-buffer-file :wk "Diff file")
    "g l" '(magit-log :wk "Log")
    "g L" '(magit-log-buffer-file :wk "Log file")
    "g b" '(magit-blame :wk "Blame")
    "g c" '(magit-clone :wk "Clone")
    "g i" '(magit-init :wk "Init")
    "g f" '(:ignore t :wk "file")
    "g f f" '(magit-find-file :wk "Find file")
    "g f l" '(magit-log-buffer-file :wk "Log file")
    "g f d" '(magit-diff-buffer-file :wk "Diff file")
    "g [" '(diff-hl-previous-hunk :wk "Previous hunk")
    "g ]" '(diff-hl-next-hunk :wk "Next hunk")
    "g h" '(:ignore t :wk "hunk")
    "g h s" '(diff-hl-stage-current-hunk :wk "Stage hunk")
    "g h r" '(diff-hl-revert-hunk :wk "Revert hunk")
    "g h m" '(diff-hl-mark-hunk :wk "Mark hunk"))

  ;; Register/Bookmark operations (SPC r)
  (ar/global-leader
    "r" '(:ignore t :wk "register/bookmark")
    "r r" '(consult-register :wk "Registers")
    "r s" '(consult-register-store :wk "Store register")
    "r l" '(consult-register-load :wk "Load register")
    "r b" '(consult-bookmark :wk "Bookmarks")
    "r B" '(bookmark-set :wk "Set bookmark")
    "r d" '(bookmark-delete :wk "Delete bookmark")
    "r m" '(bookmark-bmenu-list :wk "Bookmark menu"))

  ;; Notes operations (SPC n)
  (ar/global-leader
    "n" '(:ignore t :wk "notes")
    "n a" '(org-agenda :wk "Agenda")
    "n c" '(org-capture :wk "Capture")
    "n f" '(org-roam-node-find :wk "Find node")
    "n F" '(consult-org-roam-file-find :wk "Find file")
    "n i" '(org-roam-node-insert :wk "Insert node")
    "n l" '(org-roam-buffer-toggle :wk "Roam buffer")
    "n g" '(org-roam-graph :wk "Roam graph")
    "n u" '(org-roam-ui-open :wk "Roam UI")
    "n j" '(org-roam-dailies-capture-today :wk "Daily note")
    "n b" '(consult-org-roam-backlinks :wk "Backlinks")
    "n B" '(consult-org-roam-backlinks-recursive :wk "Backlinks recursive")
    "n L" '(consult-org-roam-forward-links :wk "Forward links")
    "n s" '(consult-org-roam-search :wk "Search roam")
    "n t" '(:ignore t :wk "table")
    "n t c" '(org-table-create :wk "Create table")
    "n t a" '(org-table-align :wk "Align table")
    "n t r" '(org-table-recalculate :wk "Recalculate"))

  ;; Quit/Session operations (SPC q)
  (ar/global-leader
    "q" '(:ignore t :wk "quit/session")
    "q q" '(save-buffers-kill-terminal :wk "Quit Emacs")
    "q Q" '(kill-emacs :wk "Quit (no save)")
    "q r" '(restart-emacs :wk "Restart Emacs")
    "q f" '(delete-frame :wk "Delete frame")
    "q s" '(tabspaces-save-session :wk "Save session")
    "q l" '(tabspaces-restore-session :wk "Load session"))

  ;; Insert operations (SPC i)
  (ar/global-leader
    "i" '(:ignore t :wk "insert")
    "i s" '(consult-yasnippet :wk "Snippet")
    "i u" '(insert-char :wk "Unicode char")
    "i e" '(emoji-insert :wk "Emoji")
    "i t" '(insert-time :wk "Timestamp"))

  ;; Zoom operations (SPC z)
  (ar/global-leader
    "z" '(:ignore t :wk "zoom")
    "z +" '(text-scale-increase :wk "Zoom in")
    "z -" '(text-scale-decrease :wk "Zoom out")
    "z 0" '((lambda () (interactive) (text-scale-set 0)) :wk "Reset zoom")
    "z f" '(toggle-frame-fullscreen :wk "Fullscreen")
    "z m" '(toggle-frame-maximized :wk "Maximize")
    "z l" '(centaur-frame-left-half :wk "Left half")
    "z r" '(centaur-frame-right-half :wk "Right half")
    "z t" '(centaur-frame-top-half :wk "Top half")
    "z b" '(centaur-frame-bottom-half :wk "Bottom half")
    "z R" '(centaur-frame-restore :wk "Restore frame"))

  ;; Workspace operations (SPC TAB)
  (ar/global-leader
    "TAB" '(:ignore t :wk "workspace")
    "TAB TAB" '(tabspaces-switch-or-create-workspace :wk "Switch workspace")
    "TAB n" '(tabspaces-switch-or-create-workspace :wk "New workspace")
    "TAB d" '(tabspaces-close-workspace :wk "Delete workspace")
    "TAB r" '(tabspaces-switch-or-create-workspace :wk "Rename workspace")
    "TAB [" '(tabspaces-switch-buffer-and-tab :wk "Previous workspace")
    "TAB ]" '(tabspaces-switch-buffer-and-tab :wk "Next workspace")
    "TAB s" '(tabspaces-save-session :wk "Save session")
    "TAB l" '(tabspaces-restore-session :wk "Load session"))

  ;; Macro operations (SPC @)
  (ar/global-leader
    "@" '(:ignore t :wk "macro")
    "@ @" '(kmacro-end-and-call-macro :wk "End and call")
    "@ s" '(kmacro-start-macro :wk "Start recording")
    "@ e" '(kmacro-end-macro :wk "End recording")
    "@ c" '(kmacro-call-macro :wk "Call macro")
    "@ n" '(kmacro-name-last-macro :wk "Name last")
    "@ b" '(kmacro-bind-to-key :wk "Bind to key")
    "@ v" '(kmacro-view-macro :wk "View macro")
    "@ d" '(kmacro-delete-ring-head :wk "Delete"))

  ;; Kill ring (SPC k)
  (ar/global-leader
    "k" '(browse-kill-ring :wk "Kill ring"))

  ;; Iedit (SPC e)
  (ar/global-leader
    "e" '(:ignore t :wk "iedit")
    "e e" '(iedit-mode :wk "Iedit mode")
    "e r" '(iedit-rectangle-mode :wk "Rectangle mode"))

  ;; Casual suite (SPC ?)
  (ar/global-leader
    "?" '(:ignore t :wk "casual")
    "? a" '(casual-avy-tmenu :wk "Avy")
    "? e" '(casual-editkit-main-tmenu :wk "Editkit")
    "? d" '(casual-dired-tmenu :wk "Dired")
    "? i" '(casual-isearch-tmenu :wk "Isearch")
    "? I" '(casual-info-tmenu :wk "Info")
    "? b" '(casual-bookmarks-tmenu :wk "Bookmarks")
    "? c" '(casual-calc-tmenu :wk "Calc"))

  ;; Treemacs (SPC 0)
  (ar/global-leader
    "0" '(treemacs-select-window :wk "Select treemacs"))

  (general-define-key
   :states 'motion
   ;; Avy bindings
   "g s" 'avy-goto-char-2
   "g S" 'avy-goto-line
   "g w" 'avy-goto-word-1
   "g e" 'avy-goto-word-0

   ;; Xref/LSP navigation
   "g d" 'xref-find-definitions
   "g D" 'xref-find-references
   "g i" 'lsp-find-implementation
   "g t" 'lsp-find-type-definition
   "g [" 'diff-hl-previous-hunk
   "g ]" 'diff-hl-next-hunk
   "g ," 'xref-go-back
   "g ." 'xref-find-definitions)

  (general-define-key
   :states '(normal visual)
   ;; Better navigation
   "j" 'evil-next-visual-line
   "k" 'evil-previous-visual-line
   "gj" 'evil-next-line
   "gk" 'evil-previous-line

   ;; Avy zap
   "z" 'avy-zap-to-char-dwim
   "Z" 'avy-zap-up-to-char-dwim)

  (general-define-key
   :states 'normal
   ;; Undo-fu
   "u" 'undo-fu-only-undo
   "C-r" 'undo-fu-only-redo)

  (general-define-key
   :states 'insert
   ;; Yasnippet navigation with Tab conflict resolution handled by yasnippet itself
   )

  (general-define-key
   ;; Ace-link
   "M-o" 'ace-link-addr

   ;; Popper
   "C-`" 'popper-toggle
   "C-~" 'popper-cycle
   "M-`" 'popper-toggle-type)

  (general-define-key
   :states 'normal
   :keymaps 'dired-mode-map
   "h" 'dired-up-directory
   "l" 'dired-find-file
   "o" 'dired-find-file-other-window
   "v" 'dired-view-file
   "m" 'dired-mark
   "u" 'dired-unmark
   "U" 'dired-unmark-all-marks
   "c" 'dired-create-directory
   "C" 'dired-do-copy
   "D" 'dired-do-delete
   "R" 'dired-do-rename
   "Y" 'dired-do-copy
   "!" 'dired-do-shell-command
   "&" 'dired-do-async-shell-command
   "q" 'quit-window
   "g r" 'revert-buffer
   "g g" 'evil-goto-first-line
   "G" 'evil-goto-line
   "s" 'dired-sort-toggle-or-edit
   "(" 'dired-hide-details-mode
   ")" 'dired-omit-mode)

  (general-define-key
   :states 'normal
   :keymaps 'helpful-mode-map
   "q" 'quit-window
   "g r" 'helpful-update
   "TAB" 'forward-button
   "S-TAB" 'backward-button
   "RET" 'push-button)

  (general-define-key
   :states 'normal
   :keymaps 'pdf-view-mode-map
   "j" 'pdf-view-next-line-or-next-page
   "k" 'pdf-view-previous-line-or-previous-page
   "h" 'image-backward-hscroll
   "l" 'image-forward-hscroll
   "J" 'pdf-view-next-page
   "K" 'pdf-view-previous-page
   "g g" 'pdf-view-first-page
   "G" 'pdf-view-last-page
   "g t" 'pdf-view-goto-page
   "g l" 'pdf-view-goto-label
   "+" 'pdf-view-enlarge
   "=" 'pdf-view-enlarge
   "-" 'pdf-view-shrink
   "0" 'pdf-view-scale-reset
   "W" 'pdf-view-fit-width-to-window
   "H" 'pdf-view-fit-height-to-window
   "P" 'pdf-view-fit-page-to-window
   "n" 'pdf-view-next-page-command
   "p" 'pdf-view-previous-page-command
   "d" 'pdf-view-midnight-minor-mode
   "/" 'isearch-forward
   "?" 'isearch-backward
   "o" 'pdf-outline
   "m" 'pdf-view-set-slice-using-mouse
   "b" 'pdf-view-set-slice-from-bounding-box
   "r" 'pdf-view-reset-slice
   "q" 'quit-window)

  (ar/local-leader
    :keymaps 'org-mode-map
    "," '(org-ctrl-c-ctrl-c :wk "Ctrl-c Ctrl-c")
    "." '(org-time-stamp :wk "Timestamp")
    "*" '(org-ctrl-c-star :wk "Heading")
    "-" '(org-ctrl-c-minus :wk "List")
    "a" '(org-agenda :wk "Agenda")
    "c" '(org-capture :wk "Capture")
    "e" '(org-export-dispatch :wk "Export")
    "i" '(:ignore t :wk "insert")
    "i l" '(org-insert-link :wk "Link")
    "i s" '(org-download-screenshot :wk "Screenshot")
    "i y" '(org-download-yank :wk "Yank image")
    "i t" '(org-table-create :wk "Table")
    "i h" '(org-insert-heading :wk "Heading")
    "t" '(org-todo :wk "Todo")
    "T" '(org-show-todo-tree :wk "Todo tree")
    "s" '(org-schedule :wk "Schedule")
    "d" '(org-deadline :wk "Deadline")
    "p" '(org-priority :wk "Priority")
    "r" '(org-refile :wk "Refile")
    "A" '(org-archive-subtree :wk "Archive")
    "l" '(:ignore t :wk "link")
    "l l" '(org-insert-link :wk "Insert link")
    "l s" '(org-store-link :wk "Store link")
    "l i" '(org-id-get-create :wk "Insert ID")
    "b" '(:ignore t :wk "babel")
    "b t" '(org-babel-tangle :wk "Tangle")
    "b e" '(org-babel-execute-src-block :wk "Execute")
    "b b" '(org-babel-execute-buffer :wk "Execute buffer")
    "b c" '(org-babel-check-src-block :wk "Check")
    "x" '(:ignore t :wk "text")
    "x b" '(org-toggle-checkbox :wk "Toggle checkbox")
    "x i" '(org-toggle-item :wk "Toggle item")
    "x p" '(org-set-property :wk "Set property")
    "x t" '(org-set-tags-command :wk "Set tags")))
#+end_src
