#+TITLE: Emacs Configuration
#+AUTHOR: Ahsanur Rahman
#+STARTUP: overview
#+PROPERTY: header-args:emacs-lisp :tangle ./init.el :mkdirp yes

* Core Emacs Configuration
** Lexical Binding
#+begin_src emacs-lisp
;;; init.el --- Main Configuration File -*- no-byte-compile: t; lexical-binding: t; -*-
#+end_src

** Garbage Collection
#+begin_src emacs-lisp
;; CRITICAL: Restore GC after startup with optimized values
(defvar better-gc-cons-threshold 134217728  ;; 128MB (increased from default 800KB)
  "Optimal GC threshold for modern LSP-heavy workflows.
Lower this if you experience freezing, raise if stuttering.")

(defvar better-gc-cons-percentage 0.1
  "GC percentage of heap to trigger collection.")

;; Restore GC settings after startup
(add-hook 'elpaca-after-init-hook
          (lambda ()
            (setq gc-cons-threshold better-gc-cons-threshold
                  gc-cons-percentage better-gc-cons-percentage)

            ;; FIX: Only restore file handlers if the original variable actually exists
            (when (boundp 'file-name-handler-alist-original)
              (setq file-name-handler-alist file-name-handler-alist-original)
              (makunbound 'file-name-handler-alist-original))

            ;; Report startup time
            (message "Emacs loaded in %.2fs with %d GCs"
                     (float-time (time-subtract after-init-time before-init-time))
                     gcs-done))
          100) ;; Run late to ensure accurate timing

;; Increase GC threshold in minibuffer to prevent slowdowns during completion
(add-hook 'elpaca-after-init-hook
          (lambda ()
            (defun gc-minibuffer-setup-hook ()
              (setq gc-cons-threshold (* better-gc-cons-threshold 2)))

            (defun gc-minibuffer-exit-hook ()
              (garbage-collect)
              (setq gc-cons-threshold better-gc-cons-threshold))

            (add-hook 'minibuffer-setup-hook #'gc-minibuffer-setup-hook)
            (add-hook 'minibuffer-exit-hook #'gc-minibuffer-exit-hook)))
#+end_src

** Package Management
#+begin_src emacs-lisp
(defvar elpaca-installer-version 0.11)
(defvar elpaca-directory (expand-file-name "elpaca/" user-emacs-directory))
(defvar elpaca-builds-directory (expand-file-name "builds/" elpaca-directory))
(defvar elpaca-repos-directory (expand-file-name "repos/" elpaca-directory))
(defvar elpaca-order '(elpaca :repo "https://github.com/progfolio/elpaca.git"
                              :ref nil :depth 1 :inherit ignore
                              :files (:defaults "elpaca-test.el" (:exclude "extensions"))
                              :build (:not elpaca--activate-package)))
(let* ((repo  (expand-file-name "elpaca/" elpaca-repos-directory))
       (build (expand-file-name "elpaca/" elpaca-builds-directory))
       (order (cdr elpaca-order))
       (default-directory repo))
  (add-to-list 'load-path (if (file-exists-p build) build repo))
  (unless (file-exists-p repo)
    (make-directory repo t)
    (when (<= emacs-major-version 28) (require 'subr-x))
    (condition-case-unless-debug err
        (if-let* ((buffer (pop-to-buffer-same-window "*elpaca-bootstrap*"))
                  ((zerop (apply #'call-process `("git" nil ,buffer t "clone"
                                                  ,@(when-let* ((depth (plist-get order :depth)))
                                                      (list (format "--depth=%d" depth) "--no-single-branch"))
                                                  ,(plist-get order :repo) ,repo))))
                  ((zerop (call-process "git" nil buffer t "checkout"
                                        (or (plist-get order :ref) "--"))))
                  (emacs (concat invocation-directory invocation-name))
                  ((zerop (call-process emacs nil buffer nil "-Q" "-L" "." "--batch"
                                        "--eval" "(byte-recompile-directory \".\" 0 'force)")))
                  ((require 'elpaca))
                  ((elpaca-generate-autoloads "elpaca" repo)))
            (progn (message "%s" (buffer-string)) (kill-buffer buffer))
          (error "%s" (with-current-buffer buffer (buffer-string))))
      ((error) (warn "%s" err) (delete-directory repo 'recursive))))
  (unless (require 'elpaca-autoloads nil t)
    (require 'elpaca)
    (elpaca-generate-autoloads "elpaca" repo)
    (let ((load-source-file-function nil)) (load "./elpaca-autoloads"))))
(add-hook 'after-init-hook #'elpaca-process-queues)
(elpaca `(,@elpaca-order))

;; Install use-package support
(elpaca elpaca-use-package
  ;; Enable use-package :ensure support for Elpaca.
  (elpaca-use-package-mode))


(eval-and-compile
  (setq use-package-verbose nil  ;; Changed from t - reduce startup messages
        use-package-expand-minimally t
        use-package-compute-statistics nil  ;; Changed from t - disable unless profiling
        ;;use-package-always-defer t
        use-package-always-ensure t
        use-package-enable-imenu-support t))

(eval-when-compile
  (require 'use-package)
  (require 'bind-key))
#+end_src

** Emacs Start Up Profiler
#+begin_src emacs-lisp
;; Profile startup time with detailed breakdown
(use-package esup
  :defer t
  :commands esup
  :config
  ;; Work around byte-compile issues
  (setq esup-depth 0))
#+end_src

** Custom Functions
#+begin_src emacs-lisp
(defun childframe-workable-p ()
  "Whether childframe is workable."
  (and (>= emacs-major-version 26)
       (not noninteractive)
       (or (display-graphic-p)
           (featurep 'tty-child-frames))
       (eq (frame-parameter (selected-frame) 'minibuffer) 't)))

(defun childframe-completion-workable-p ()
  "Whether childframe completion is workable."
  (childframe-workable-p))

(defun icons-displayable-p ()
  "Return non-nil if icons are displayable."
  (or (featurep 'nerd-icons)
      (require 'nerd-icons nil t)))

(defun too-long-file-p ()
  "Check whether the file is too long."
  (or (> (buffer-size) 500000)
      (and (fboundp 'buffer-line-statistics)
           (> (car (buffer-line-statistics)) 10000))))

(defun reload-init-file ()
  "Tangle and reload the Emacs configuration from config.org."
  (interactive)
  (let* ((config-org (expand-file-name "config.org" user-emacs-directory))
         (init-el (expand-file-name "init.el" user-emacs-directory)))
    ;; Check if config.org exists
    (unless (file-exists-p config-org)
      (user-error "Configuration file %s not found!" config-org))
    
    (message "Tangling configuration from %s..." config-org)
    
    ;; Tangle the org file
    (org-babel-tangle-file config-org init-el "emacs-lisp")
    
    (message "Loading %s..." init-el)
    
    ;; Load the tangled init file
    ;; Note: This doesn't fully restart Emacs, so some changes
    ;; (especially to package declarations) may require a restart
    (load-file init-el)
    
    ;; Process any queued Elpaca packages
    (when (fboundp 'elpaca-process-queues)
      (elpaca-process-queues))
    
    (message "Configuration reloaded! Some changes may require an Emacs restart.")))

(defun my/auto-tangle-config-org ()
  "Automatically tangle config.org when saved."
  (when (string-equal (buffer-file-name)
                      (expand-file-name "config.org" user-emacs-directory))
    ;; Dynamic scoping to avoid confirmation prompts
    (let ((org-confirm-babel-evaluate nil))
      (org-babel-tangle))))

(add-hook 'org-mode-hook
          (lambda ()
            (add-hook 'after-save-hook #'my/auto-tangle-config-org nil t)))
#+end_src

** Constants
#+begin_src emacs-lisp
(defconst sys/linuxp
  (eq system-type 'gnu/linux)
  "Are we running on a GNU/Linux system?")

(defconst sys/rootp
  (string-equal "root" (getenv "USER"))
  "Are you using ROOT user?")

(defconst emacs/>=29p
  (>= emacs-major-version 29)
  "Emacs is 29 or above.")

(defconst emacs/>=29.2p
  (and (>= emacs-major-version 29)
       (>= emacs-minor-version 2))
  "Emacs is 29.2 or above.")

(defconst emacs/>=30p
  (>= emacs-major-version 30)
  "Emacs is 30 or above.")

(defconst emacs/>=31p
  (>= emacs-major-version 31)
  "Emacs is 31 or above.")
#+end_src

** Performance Tuning
#+begin_src emacs-lisp
(when (fboundp 'pgtk-use-im-context)
  (add-hook 'after-make-frame-functions
            (lambda (frame)
              (with-selected-frame frame
                (pgtk-use-im-context nil)))))


(setq-default bidi-display-reordering nil
              bidi-paragraph-direction 'left-to-right
              bidi-inhibit-bpa t)

;; Apply to common modes
(defun my/bidi-optimizations ()
  "Apply bidi optimizations for current buffer."
  (setq-local bidi-paragraph-direction 'left-to-right
              bidi-inhibit-bpa t))

(add-hook 'org-mode-hook #'my/bidi-optimizations)
(add-hook 'text-mode-hook #'my/bidi-optimizations)
(add-hook 'prog-mode-hook #'my/bidi-optimizations)

(setq-default long-line-threshold 1000
              large-hscroll-threshold 1000
              syntax-wholeline-max 1000)

(setq undo-limit 800000
      undo-strong-limit 1200000
      undo-outer-limit 120000000)

(setq scroll-conservatively 101
      scroll-margin 0
      scroll-preserve-screen-position t
      auto-window-vscroll nil
      fast-but-imprecise-scrolling t  ;; Trade accuracy for speed
      redisplay-skip-fontification-on-input t)  ;; Skip during rapid input

(setq highlight-nonselected-windows nil)
(setq blink-cursor-mode nil)

(setq frame-resize-pixelwise t)
(setq window-resize-pixelwise nil)

(setq byte-compile-warnings '(not obsolete))
(setq native-comp-async-report-warnings-errors 'silent)

(setq ffap-machine-p-known 'reject)

(setq inhibit-compacting-font-caches t)  ;; Don't compact font cache
#+end_src

** Small Configs
#+begin_src emacs-lisp
;; Move backup files to dedicated directory
(setq backup-directory-alist `(("." . ,(expand-file-name ".backup" user-emacs-directory))))

;; Confirmation settings
(setq confirm-kill-processes nil)  ;; Auto-kill processes on exit

;; Faster echo of keystrokes
(setq echo-keystrokes 0.1)

;; Don't create lockfiles
(setq-default create-lockfiles nil)

;; Compilation settings
(setq-default compilation-always-kill t
              compilation-ask-about-save nil
              compilation-scroll-output t)

;; Suppress redefinition warnings
(setq ad-redefinition-action 'accept)

;; Custom file location - CRITICAL: Load after Elpaca finishes
(setq custom-file (concat user-emacs-directory "custom.el"))
(add-hook 'elpaca-after-init-hook
            (lambda () (load custom-file 'noerror)))

;; Require final newline
(setq require-final-newline t)

;; Enable commands
(put 'erase-buffer 'disabled nil)

;; Global modes
(global-hl-line-mode 1)
(delete-selection-mode 1)

;; File associations
(add-to-list 'auto-mode-alist '("\\.in\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.out\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.args\\'" . text-mode))
(add-to-list 'auto-mode-alist '("\\.bb\\'" . shell-script-mode))
(add-to-list 'auto-mode-alist '("\\.bbclass\\'" . shell-script-mode))
(add-to-list 'auto-mode-alist '("\\.Rmd\\'" . markdown-mode))

;; Alt key mapping
(setq x-alt-keysym 'meta)
#+end_src

** Garbage Collector Magic Hack
#+begin_src emacs-lisp
(use-package gcmh
  :hook (elpaca-after-init . gcmh-mode)
  :init
  (setq gcmh-idle-delay 'auto))
#+end_src

** UTF-8 Coding System
#+begin_src emacs-lisp
(set-selection-coding-system 'utf-8)
(prefer-coding-system 'utf-8)
(set-language-environment "UTF-8")
(set-default-coding-systems 'utf-8)
(set-terminal-coding-system 'utf-8)
(set-keyboard-coding-system 'utf-8)
(setq locale-coding-system 'utf-8)
;; Treat clipboard input as UTF-8 string first; compound text next, etc.
(when (display-graphic-p)
  (setq x-select-request-type '(UTF8_STRING COMPOUND_TEXT TEXT STRING)))
#+end_src

** Environment
#+begin_src emacs-lisp
(use-package exec-path-from-shell
  :custom
  (exec-path-from-shell-variables
   '("PATH" "MANPATH"
     "OPENAI_API_KEY" "ANTHROPIC_API_KEY"
     "XAI_API_KEY" "DEEPSEEK_API_KEY"
     "OPENROUTER_API_KEY" "GEMINI_API_KEY"))
  :config
  (when (daemonp)
    (exec-path-from-shell-initialize)))
#+end_src

** Session Management
#+begin_src emacs-lisp
;; Save place
(use-package saveplace
  :ensure nil
  :hook (elpaca-after-init . save-place-mode))

;; History with symlink resolution
(use-package recentf
  :ensure nil
  :hook (elpaca-after-init . recentf-mode)
  :init
  (setq recentf-max-saved-items 300
        recentf-exclude
        '("\\.?cache" ".cask" "url" "COMMIT_EDITMSG\\'" "bookmarks"
          "\\.\\(?:gz\\|gif\\|svg\\|png\\|jpe?g\\|bmp\\|xpm\\)$"
          "\\.?ido\\.last$" "\\.revive$" "/G?TAGS$" "/.elfeed/"
          "^/tmp/" "^/var/folders/.+$" "^/ssh:" "/persp-confs/"
          (lambda (file) (file-in-directory-p file package-user-dir))))
  :config
  (push (expand-file-name recentf-save-file) recentf-exclude)
  
  ;; CRITICAL: Resolve symlinks FIRST, then abbreviate
  ;; This ensures ~/org/todo.org and ~/Git/.../org/todo.org become the same
  (setq recentf-filename-handlers
        '(file-truename        ; Resolve symlinks to real path
          abbreviate-file-name)) ; Then abbreviate for display
  
  ;; Prevent org-agenda files from cluttering recent files
  ;; Dashboard opens these files, triggering recentf
  (defun ar/exclude-org-agenda-files (file)
    "Exclude files in org-agenda-files from recentf."
    (when (bound-and-true-p org-agenda-files)
      (let ((file-true (file-truename file)))
        (cl-some (lambda (agenda-file)
                   (string= file-true (file-truename agenda-file)))
                 (org-agenda-files t)))))
  
  (add-to-list 'recentf-exclude #'ar/exclude-org-agenda-files))

(use-package savehist
  :ensure nil
  :hook (elpaca-after-init . savehist-mode)
  :init
  (setq enable-recursive-minibuffers t
        history-length 1000
        savehist-additional-variables '(mark-ring
                                        global-mark-ring
                                        search-ring
                                        regexp-search-ring
                                        extended-command-history)
        savehist-autosave-interval 300))
#+end_src

** Misc
#+begin_src emacs-lisp
;; ;; Misc.
(use-package simple
  :ensure nil
  :hook ((text-mode . visual-line-mode)
         ((prog-mode markdown-mode conf-mode) . enable-trailing-whitespace))
  :init
  (setq column-number-mode t
        line-number-mode t
        kill-whole-line t               ; Kill line including '\n'
        line-move-visual nil
        track-eol t                     ; Keep cursor at end of lines. Require line-move-visual is nil.
        set-mark-command-repeat-pop t)  ; Repeating C-SPC after popping mark pops it again

  ;; Visualize TAB, (HARD) SPACE, NEWLINE
  (setq-default show-trailing-whitespace nil) ; Don't show trailing whitespace by default
  (defun enable-trailing-whitespace ()
    "Show trailing spaces and delete on saving."
    (setq show-trailing-whitespace t)
    (add-hook 'before-save-hook #'delete-trailing-whitespace nil t))

  ;; Prettify the process list
  (with-no-warnings
    (defun my-list-processes--prettify ()
      "Prettify process list."
      (when-let* ((entries tabulated-list-entries))
        (setq tabulated-list-entries nil)
        (dolist (p (process-list))
          (when-let* ((val (cadr (assoc p entries)))
                      (name (aref val 0))
                      (pid (aref val 1))
                      (status (aref val 2))
                      (status (list status
                                    'face
                                    (if (memq status '(stop exit closed failed))
                                        'error
                                      'success)))
                      (buf-label (aref val 3))
                      (tty (list (aref val 4) 'face 'font-lock-doc-face))
                      (thread (list (aref val 5) 'face 'font-lock-doc-face))
                      (cmd (list (aref val 6) 'face 'completions-annotations)))
            (push (list p (vector name pid status buf-label tty thread cmd))
		          tabulated-list-entries)))))
    (advice-add #'list-processes--refresh :after #'my-list-processes--prettify)))

;; Misc
(if (boundp 'use-short-answers)
    (setq use-short-answers t)
  (fset 'yes-or-no-p 'y-or-n-p))
(setq-default major-mode 'text-mode
              fill-column 80
              tab-width 4
              indent-tabs-mode nil)     ; Permanently indent with spaces, never with TABs

(setq visible-bell t
      inhibit-compacting-font-caches t  ; Don’t compact font caches during GC
      delete-by-moving-to-trash t       ; Deleting files go to OS's trash folder
      make-backup-files nil             ; Forbide to make backup files
      auto-save-default nil             ; Disable auto save

      uniquify-buffer-name-style 'post-forward-angle-brackets ; Show path if names are same
      adaptive-fill-regexp "[ t]+|[ t]*([0-9]+.|*+)[ t]*"
      adaptive-fill-first-line-regexp "^* *$"
      sentence-end "\\([。！？]\\|……\\|[.?!][]\"')}]*\\($\\|[ \t]\\)\\)[ \t\n]*"
      sentence-end-double-space nil
      word-wrap-by-category t)
#+end_src

* Evil
** Core Evil
#+begin_src emacs-lisp
;; The undo-fu package is a lightweight wrapper around Emacs' built-in undo
;; system, providing more convenient undo/redo functionality.
(use-package undo-fu
  :commands (undo-fu-only-undo
             undo-fu-only-redo
             undo-fu-only-redo-all
             undo-fu-disable-checkpoint)
  :config
  (global-unset-key (kbd "C-z"))
  (global-set-key (kbd "C-z") 'undo-fu-only-undo)
  (global-set-key (kbd "C-S-z") 'undo-fu-only-redo))

;; The undo-fu-session package complements undo-fu by enabling the saving
;; and restoration of undo history across Emacs sessions, even after restarting.
(use-package undo-fu-session
  :commands undo-fu-session-global-mode
  :hook (elpaca-after-init . undo-fu-session-global-mode))


(setq evil-undo-system 'undo-fu)

;; Vim emulation
(use-package evil
  :commands (evil-mode evil-define-key)
  :hook (elpaca-after-init . evil-mode)

  :init
  ;; It has to be defined before evil
  (setq evil-want-integration t)
  (setq evil-want-keybinding nil)

  :custom
  ;; Make :s in visual mode operate only on the actual visual selection
  ;; (character or block), instead of the full lines covered by the selection
  (evil-ex-visual-char-range t)
  ;; Use Vim-style regular expressions in search and substitute commands,
  ;; allowing features like \v (very magic), \zs, and \ze for precise matches
  (evil-ex-search-vim-style-regexp t)
  ;; Enable automatic horizontal split below
  (evil-split-window-below t)
  ;; Enable automatic vertical split to the right
  (evil-vsplit-window-right t)
  ;; Disable echoing Evil state to avoid replacing eldoc
  (evil-echo-state nil)
  ;; Do not move cursor back when exiting insert state
  (evil-move-cursor-back nil)
  ;; Make `v$` exclude the final newline
  (evil-v$-excludes-newline t)
  ;; Allow C-h to delete in insert state
  (evil-want-C-h-delete t)
  ;; Enable C-u to delete back to indentation in insert state
  (evil-want-C-u-delete t)
  ;; Enable fine-grained undo behavior
  (evil-want-fine-undo t)
  ;; Allow moving cursor beyond end-of-line in visual block mode
  (evil-move-beyond-eol t)
  ;; Disable wrapping of search around buffer
  (evil-search-wrap nil)
  ;; Whether Y yanks to the end of the line
  (evil-want-Y-yank-to-eol t)
  :config
  (evil-select-search-module 'evil-search-module 'isearch))

(use-package evil-collection
  :after evil
  :init
  ;; It has to be defined before evil-colllection
  (setq evil-collection-setup-minibuffer t)
  :config
  (evil-collection-init))

;; The evil-surround package simplifies handling surrounding characters, such as
;; parentheses, brackets, quotes, etc. It provides key bindings to easily add,
;; change, or delete these surrounding characters in pairs. For instance, you
;; can surround the currently selected text with double quotes in visual state
;; using S" or gS".
(use-package evil-surround
  :after evil
  :commands global-evil-surround-mode
  :custom
  (evil-surround-pairs-alist
   '((?\( . ("(" . ")"))
     (?\[ . ("[" . "]"))
     (?\{ . ("{" . "}"))

     (?\) . ("(" . ")"))
     (?\] . ("[" . "]"))
     (?\} . ("{" . "}"))

     (?< . ("<" . ">"))
     (?> . ("<" . ">"))))
  :hook (elpaca-after-init . global-evil-surround-mode))

(use-package evil-lion
  :config
  (evil-lion-mode))

;; The following code enables commenting and uncommenting by pressing gcc in
;; normal mode and gc in visual mode.
(with-eval-after-load "evil"
  (evil-define-operator my-evil-comment-or-uncomment (beg end)
    "Toggle comment for the region between BEG and END."
    (interactive "<r>")
    (comment-or-uncomment-region beg end))
  (evil-define-key 'normal 'global (kbd "gc") 'my-evil-comment-or-uncomment))

#+end_src

** Evil Window Movement Enhancements
#+begin_src emacs-lisp
(defcustom ar/evil-want-move-window-to-wrap-around nil
  "If non-nil, window movement commands wrap around."
  :type 'boolean
  :group 'evil)

(defun ar/evil-window-move-left ()
  "Move to window on the left, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-left))))
      (evil-window-bottom-right)
    (windmove-left)))

(defun ar/evil-window-move-right ()
  "Move to window on the right, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-right))))
      (evil-window-top-left)
    (windmove-right)))

(defun ar/evil-window-move-up ()
  "Move to window above, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-up))))
      (evil-window-bottom-right)
    (windmove-up)))

(defun ar/evil-window-move-down ()
  "Move to window below, wrapping if needed."
  (interactive)
  (if (and ar/evil-want-move-window-to-wrap-around
           (not (ignore-errors (windmove-down))))
      (evil-window-top-left)
    (windmove-down)))
#+end_src

* Setup User
#+begin_src emacs-lisp
(setq user-full-name "Ahsanur Rahman"
      user-mail-address "ahsanur041@proton.me")
#+end_src

* Child Frame
#+begin_src emacs-lisp
(use-package posframe
  :hook (after-load-theme . posframe-delete-all)
  :init
  (defface posframe-border
    `((t (:inherit region)))
    "Face used by the `posframe' border."
    :group 'posframe)
  (defvar posframe-border-width 2
    "Default posframe border width.")
  :config
  (with-no-warnings
    (defun my-posframe--prettify-frame (&rest _)
      (set-face-background 'fringe nil posframe--frame))
    (advice-add #'posframe--create-posframe :after #'my-posframe--prettify-frame)

    (defun posframe-poshandler-frame-center-near-bottom (info)
      (cons (/ (- (plist-get info :parent-frame-width)
                  (plist-get info :posframe-width))
               2)
            (/ (+ (plist-get info :parent-frame-height)
                  (* 2 (plist-get info :font-height)))
               2)))))
#+end_src

* Hydra Setup
#+begin_src emacs-lisp
(use-package hydra
  :ensure (:wait t)
  :demand t
  :defines posframe-border-width
  :hook (emacs-lisp-mode . hydra-add-imenu)
  :init
  (setq hydra-hint-display-type 'lv)
  :config
  ;; Use posframe if available and graphical
  (when (and (display-graphic-p)
             (require 'posframe nil t))
    (setq hydra-hint-display-type 'posframe)
    (setq hydra-posframe-show-params
          `(:left-fringe 8
            :right-fringe 8
            :internal-border-width 2
            :internal-border-color ,(face-background 'region nil t)
            :background-color ,(face-background 'tooltip nil t)
            :foreground-color ,(face-foreground 'tooltip nil t)
            :lines-truncate t
            :poshandler posframe-poshandler-frame-center-near-bottom))

    ;; Update colors on theme change
    (defun my-hydra-update-posframe-params ()
      "Update hydra posframe parameters after theme change."
      (setq hydra-posframe-show-params
            `(:left-fringe 8
              :right-fringe 8
              :internal-border-width 2
              :internal-border-color ,(face-background 'region nil t)
              :background-color ,(face-background 'tooltip nil t)
              :foreground-color ,(face-foreground 'tooltip nil t)
              :lines-truncate t
              :poshandler posframe-poshandler-frame-center-near-bottom)))
    (add-hook 'after-load-theme-hook #'my-hydra-update-posframe-params t)))

(use-package pretty-hydra
  :ensure (:wait t)
  :demand t
  :functions icons-displayable-p
  :bind ("<f6>" . toggles-hydra/body)
  :hook (emacs-lisp-mode . (lambda ()
                             (add-to-list
                              'imenu-generic-expression
                              '("Hydras"
                                "^.*(\\(pretty-hydra-define\\) \\([a-zA-Z-]+\\)"
                                2))))
  :init
  (cl-defun pretty-hydra-title (title &optional icon-type icon-name
                                      &key face height v-adjust)
    "Add an icon in the hydra title."
    (let ((face (or face 'mode-line-emphasis))
          (height (or height 1.2))
          (v-adjust (or v-adjust 0.0)))
      (concat
       (when (and (display-graphic-p)
                  (or (featurep 'nerd-icons) (require 'nerd-icons nil t))
                  icon-type icon-name)
         (let ((f (intern (format "nerd-icons-%s" icon-type))))
           (when (fboundp f)
             (concat
              (apply f (list icon-name :face face :height height :v-adjust v-adjust))
              " "))))
       (propertize title 'face face))))

  ;; Global toggles
  (with-no-warnings
    (pretty-hydra-define toggles-hydra (:title (pretty-hydra-title "Toggles" 'faicon "nf-fa-toggle_on")
                                        :color amaranth :quit-key ("q" "C-g"))
      ("Basic"
       (("n" (cond ((fboundp 'display-line-numbers-mode)
                    (display-line-numbers-mode (if display-line-numbers-mode -1 1)))
                   ((fboundp 'gblobal-linum-mode)
                    (global-linum-mode (if global-linum-mode -1 1))))
         "line number"
         :toggle (or (bound-and-true-p display-line-numbers-mode)
                     (bound-and-true-p global-linum-mode)))
        ("a" global-aggressive-indent-mode "aggressive indent" :toggle t)
        ("d" global-hungry-delete-mode "hungry delete" :toggle t)
        ("e" electric-pair-mode "electric pair" :toggle t)
        ("c" flyspell-mode "spell check" :toggle t)
        ("s" prettify-symbols-mode "pretty symbol" :toggle t)
        ("l" global-page-break-lines-mode "page break lines" :toggle t)
        ("b" display-battery-mode "battery" :toggle t)
        ("i" display-time-mode "time" :toggle t)
        ("m" doom-modeline-mode "modern mode-line" :toggle t))
       "Highlight"
       (("h l" global-hl-line-mode "line" :toggle t)
        ("h p" show-paren-mode "paren" :toggle t)
        ("h s" symbol-overlay-mode "symbol" :toggle t)
        ("h r" rainbow-mode "rainbow" :toggle t)
        ("h w" (setq-default show-trailing-whitespace (not show-trailing-whitespace))
         "whitespace" :toggle show-trailing-whitespace)
        ("h d" rainbow-delimiters-mode "delimiter" :toggle t)
        ("h i" highlight-indent-guides-mode "indent" :toggle t)
        ("h t" global-hl-todo-mode "todo" :toggle t))
       "Program"
       (("f" flymake-mode "flymake" :toggle t)
        ("O" hs-minor-mode "hideshow" :toggle t)
        ("u" subword-mode "subword" :toggle t)
        ("W" which-function-mode "which function" :toggle t)
        ("E" toggle-debug-on-error "debug on error" :toggle (default-value 'debug-on-error))
        ("Q" toggle-debug-on-quit "debug on quit" :toggle (default-value 'debug-on-quit))
        ("v" global-diff-hl-mode "gutter" :toggle t)
        ("V" diff-hl-flydiff-mode "live gutter" :toggle t)
        ("M" diff-hl-margin-mode "margin gutter" :toggle t)
        ("D" diff-hl-dired-mode "dired gutter" :toggle t))
       "Theme"
       (("t a" (centaur-load-theme 'auto) "auto"
         :toggle (eq centaur-theme 'auto) :exit t)
        ("t r" (centaur-load-theme 'random) "random"
         :toggle (eq centaur-theme 'random) :exit t)
        ("t s" (centaur-load-theme 'system) "system"
         :toggle (eq centaur-theme 'system) :exit t)
        ("t d" (centaur-load-theme 'default) "default"
         :toggle (centaur-theme-enable-p 'default) :exit t)
        ("t p" (centaur-load-theme 'pro) "pro"
         :toggle (centaur-theme-enable-p 'pro) :exit t)
        ("t k" (centaur-load-theme 'dark) "dark"
         :toggle (centaur-theme-enable-p 'dark) :exit t)
        ("t l" (centaur-load-theme 'light) "light"
         :toggle (centaur-theme-enable-p 'light) :exit t)
        ("t w" (centaur-load-theme 'warm) "warm"
         :toggle (centaur-theme-enable-p 'warm) :exit t)
        ("t c" (centaur-load-theme 'cold) "cold"
         :toggle (centaur-theme-enable-p 'cold) :exit t)
        ("t y" (centaur-load-theme 'day) "day"
         :toggle (centaur-theme-enable-p 'day) :exit t)
        ("t n" (centaur-load-theme 'night) "night"
         :toggle (centaur-theme-enable-p 'night) :exit t)
        ("t o" (centaur-load-theme
                (intern (completing-read "Load custom theme: "
                                         (mapcar #'symbol-name
				                                 (custom-available-themes)))))
         "others"
         :toggle (not (or (rassoc (car custom-enabled-themes) centaur-theme-alist)
                          (rassoc (cadr custom-enabled-themes) centaur-theme-alist)))
         :exit t))
       "Package Archive"
       (("p m" (centaur-set-package-archives 'melpa t)
         "melpa" :toggle (eq centaur-package-archives 'melpa) :exit t)
        ("p b" (centaur-set-package-archives 'bfsu t)
         "bfsu" :toggle (eq centaur-package-archives 'bfsu) :exit t)
        ("p i" (centaur-set-package-archives 'iscas t)
         "iscas" :toggle (eq centaur-package-archives 'iscas) :exit t)
        ("p n" (centaur-set-package-archives 'netease t)
         "netease" :toggle (eq centaur-package-archives 'netease) :exit t)
        ("p s" (centaur-set-package-archives 'sjtu t)
         "sjtu" :toggle (eq centaur-package-archives 'sjtu) :exit t)
        ("p t" (centaur-set-package-archives 'tuna t)
         "tuna" :toggle (eq centaur-package-archives 'tuna) :exit t)
        ("p u" (centaur-set-package-archives 'ustc t)
         "ustc" :toggle (eq centaur-package-archives 'ustc) :exit t)
        ("p T" (centaur-test-package-archives) "speed test" :exit t))))))
#+end_src

* UI and Theming
** Fonts
#+begin_src emacs-lisp
(defun ar/set-fonts ()
  "Set the default, fixed-pitch, and variable-pitch fonts for the current frame."
  (set-face-attribute 'default nil :font "JetBrains Mono" :height 125 :weight 'medium)
  (set-face-attribute 'fixed-pitch nil :font "JetBrains Mono" :height 125 :weight 'medium)
  (set-face-attribute 'variable-pitch nil :font "JetBrains Mono" :height 125 :weight 'medium)
  ;; Apply italic slant to comments and keywords
  (set-face-attribute 'font-lock-comment-face nil :slant 'italic)
  (set-face-attribute 'font-lock-keyword-face nil :slant 'italic))

(if (daemonp)
    (add-hook 'elpaca-after-init-hook
              (lambda ()
                (add-hook 'after-make-frame-functions
                          (lambda (frame)
                            (with-selected-frame frame (ar/set-fonts))))))
  ;; For non-daemon mode, set fonts immediately
  (ar/set-fonts))

;; Line spacing
(setq-default line-spacing 0.02)

;; Font settings
(setq font-lock-maximum-decoration t
      inhibit-compacting-font-caches t)
#+end_src

** Title
#+begin_src emacs-lisp
(setq frame-title-format '("Emacs - %b")
      icon-title-format frame-title-format)
#+end_src

** Doom Themes
#+begin_src emacs-lisp
(use-package doom-themes
  :demand t
  :custom
  (doom-themes-enable-bold t)
  (doom-themes-enable-italic t)
  (doom-themes-treemacs-theme "doom-atom")
  :config
  (load-theme 'doom-tokyo-night t)
  (doom-themes-visual-bell-config)
  (doom-themes-neotree-config)
  (doom-themes-treemacs-config)
  (doom-themes-org-config))
#+end_src

** Solaire Mode
#+begin_src emacs-lisp
(use-package solaire-mode
  :hook (elpaca-after-init . solaire-global-mode))
#+end_src

** Modeline
#+begin_src emacs-lisp
(size-indication-mode -1)
(setq-default mode-line-percent-position nil)

(use-package doom-modeline
  :defer 0.1
  :hook (elpaca-after-init . doom-modeline-mode)
  :hook (doom-modeline-mode . column-number-mode)
  :init
  (setq projectile-dynamic-mode-line nil)
  (setq doom-modeline-bar-width 3
        doom-modeline-github nil
        doom-modeline-mu4e nil
        doom-modeline-persp-name nil
        doom-modeline-minor-modes nil
        doom-modeline-major-mode-icon nil
        doom-modeline-buffer-file-name-style 'relative-from-project)
  :config
  (setq doom-modeline-height 25
        doom-modeline-column-zero-based nil
        doom-modeline-bar-width 3
        doom-modeline-buffer-file-size nil
        doom-modeline-buffer-encoding nil
        doom-modeline-percent-position nil
        doom-modeline-vcs-icon t
        doom-modeline-vcs-max-length 0))

#+end_src

** Hide Modeline
#+begin_src emacs-lisp
(use-package hide-mode-line
  :autoload turn-off-hide-mode-line-mode
  :hook (((eat-mode
           eshell-mode shell-mode
           term-mode vterm-mode
           embark-collect-mode lsp-ui-imenu-mode
           pdf-annot-list-mode) . turn-on-hide-mode-line-mode)))
#+end_src

** Nerd Icons
#+begin_src emacs-lisp
(use-package nerd-icons
  :custom
  (nerd-icons-font-family "Symbols Nerd Font Mono")
  (nerd-icons-color-icons t)
  :config
  (setq inhibit-compacting-font-caches t))
#+end_src

** Dashboard
#+begin_src emacs-lisp
(use-package dashboard
  :init
  (setq dashboard-banner-logo-title "Welcome to Emacs!")
  (setq dashboard-startup-banner 'logo)
  (setq dashboard-items '((recents   . 5)
                         (bookmarks . 5)
                         (projects  . 5)
                         (agenda    . 5)))
  
  ;; CRITICAL: Close org files after reading them for agenda
  (setq dashboard-agenda-release-buffers t)
  
  (setq dashboard-center-content t)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (setq dashboard-icon-type 'nerd-icons)
  
  :config
  ;; CRITICAL FIX: Suppress "Followed link to" messages in daemon mode
  (defun ar/dashboard-setup-startup-hook-quiet ()
    "Setup dashboard but suppress messages during daemon startup."
    (if (daemonp)
        ;; In daemon mode: suppress all messages during dashboard init
        (let ((inhibit-message t)
              (message-log-max nil))  ; Don't even log to *Messages*
          (dashboard-setup-startup-hook))
      ;; Normal mode: show messages as usual
      (dashboard-setup-startup-hook)))
  
  (ar/dashboard-setup-startup-hook-quiet)
  
  (setq initial-buffer-choice (lambda () (get-buffer "*dashboard*"))))
#+end_src

** Line Numbers
#+begin_src emacs-lisp
(use-package display-line-numbers
  :ensure nil
  :hook ((prog-mode
          conf-mode toml-ts-mode
          yaml-mode yaml-ts-mode)
         . display-line-numbers-mode)
  :init (setq display-line-numbers-width-start t))
#+end_src

** Display dividers between windows
#+begin_src emacs-lisp
(setq window-divider-default-places t
      window-divider-default-bottom-width 1
      window-divider-default-right-width 1)
(add-hook 'window-setup-hook #'window-divider-mode)
#+end_src

** Text Scaling
#+begin_src emacs-lisp
(use-package default-text-scale
  :hook (elpaca-after-init . default-text-scale-mode))
#+end_src

** Scrolling
#+begin_src emacs-lisp
;; Scroll one line at a time (less "jumpy" than defaults)
(setq hscroll-step 1
      hscroll-margin 2
      scroll-step 1
      scroll-margin 0
      scroll-conservatively 100000
      scroll-preserve-screen-position t
      auto-window-vscroll nil
      ;; mouse
      mouse-wheel-scroll-amount-horizontal 1
      mouse-wheel-progressive-speed nil)

;; Smooth scrolling
(when (fboundp 'pixel-scroll-precision-mode) ;; 29+
  (use-package ultra-scroll
    :functions (hl-todo-mode diff-hl-flydiff-mode)
    :hook (elpaca-after-init . ultra-scroll-mode)
    :config
    (add-hook 'ultra-scroll-hide-functions #'diff-hl-flydiff-mode)
    (add-hook 'ultra-scroll-hide-functions #'hl-todo-mode)
    (add-hook 'ultra-scroll-hide-functions #'jit-lock-mode)))

#+end_src

* Org Mode
** Dynamic Directory Structure
#+begin_src emacs-lisp
;; Define base directory with symlinks resolved
(defvar my/org-directory (file-truename (expand-file-name "~/org/"))
  "Base directory for all org files (symlinks resolved).")

;; Define subdirectories relative to base
(defvar my/org-subdirs
  '("roam" "downloads" "noter" "archive"
    "roam/projects" "roam/literature" "roam/ideas" "roam/zettel"
    "attachments" "reviews" "backups")
  "List of subdirectories to create under `my/org-directory'.")

;; Helper function to get org subdirectory paths
(defun my/org-subdir (subdir)
  "Return full path for SUBDIR under `my/org-directory'."
  (expand-file-name subdir my/org-directory))

;; Lazy directory creation - only when needed
(defun my/ensure-org-dir (subdir)
  "Ensure SUBDIR exists under `my/org-directory'."
  (let ((dir (my/org-subdir subdir)))
    (unless (file-directory-p dir)
      (make-directory dir t))
    dir))

;; Create all directories at startup
(mapc #'my/ensure-org-dir my/org-subdirs)

;; Define convenience variables
(defvar my/org-roam-directory (my/org-subdir "roam/"))
(defvar my/org-downloads-directory (my/org-subdir "downloads/"))
(defvar my/org-noter-directory (my/org-subdir "noter/"))
(defvar my/org-archive-directory (my/org-subdir "archive/"))
#+end_src

** Better Font Faces
#+begin_src emacs-lisp
(defun ar/org-font-setup ()
  ;; Replace list hyphen with dot
  (font-lock-add-keywords 'org-mode
                          '(("^ *\\([-]\\) "
                             (0 (prog1 () (compose-region (match-beginning 1) (match-end 1) "•"))))))

  ;; Set faces for heading levels
  (dolist (face '((org-level-1 . 1.20)
                  (org-level-2 . 1.13)
                  (org-level-3 . 1.10)
                  (org-level-4 . 1.07)
                  (org-level-5 . 1.05)
                  (org-level-6 . 1.03)
                  (org-level-7 . 1.02)
                  (org-level-8 . 1)))
    (set-face-attribute (car face) nil :font "JetBrains Mono" :weight 'bold :height (cdr face))))
#+end_src

** Core Configuration
=Disable large file optimizations for now=
=add redisplay inline images=
#+begin_src emacs-lisp
(use-package org
  :ensure nil
  :pretty-hydra
  ;; See `org-structure-template-alist'
  ((:title (pretty-hydra-title "Org Template" 'sucicon "nf-custom-orgmode" :face 'nerd-icons-green)
    :color blue :quit-key ("q" "C-g"))
   ("Basic"
    (("a" (hot-expand "<a") "ascii")
     ("c" (hot-expand "<c") "center")
     ("C" (hot-expand "<C") "comment")
     ("x" (hot-expand "<e") "example")
     ("E" (hot-expand "<E") "export")
     ("h" (hot-expand "<h") "html")
     ("l" (hot-expand "<l") "latex")
     ("n" (hot-expand "<n") "note")
     ("o" (hot-expand "<q") "quote")
     ("v" (hot-expand "<v") "verse"))
    "Head"
    (("i" (hot-expand "<i") "index")
     ("A" (hot-expand "<A") "ASCII")
     ("I" (hot-expand "<I") "INCLUDE")
     ("H" (hot-expand "<H") "HTML")
     ("L" (hot-expand "<L") "LaTeX"))
    "Source"
    (("s" (hot-expand "<s") "src")
     ("e" (hot-expand "<s" "emacs-lisp") "emacs-lisp")
     ("y" (hot-expand "<s" "python :results output") "python")
     ("p" (hot-expand "<s" "perl") "perl")
     ("w" (hot-expand "<s" "powershell") "powershell")
     ("r" (hot-expand "<s" "ruby") "ruby")
     ("S" (hot-expand "<s" "sh") "sh")
     ("g" (hot-expand "<s" "go :imports '\(\"fmt\"\)") "golang"))
    "Misc"
    (("m" (hot-expand "<s" "mermaid :file chart.png") "mermaid")
     ("u" (hot-expand "<s" "plantuml :file chart.png") "plantuml")
     ("Y" (hot-expand "<s" "ipython :session :exports both :results raw drawer\n$0") "ipython")
     ("P" (progn
            (insert "#+HEADERS: :results output :exports both :shebang \"#!/usr/bin/env perl\"\n")
            (hot-expand "<s" "perl")) "Perl tangled")
     ("<" self-insert-command "ins"))))

  :bind (:map org-mode-map
         ("<" . (lambda ()
                  "Insert org template."
                  (interactive)
                  (if (or (region-active-p) (looking-back "^\s*" 1))
                      (org-hydra/body)
                    (self-insert-command 1)))))

  :hook ((org-mode . (lambda ()
                       ;;(electric-indent-local-mode -1)
                       (evil-define-key 'normal org-mode-map (kbd "TAB") 'org-cycle)))

	     (org-mode . visual-line-mode)
	     (org-mode . ar/org-font-setup)
	     (org-mode . auto-fill-mode)
         (org-mode . (lambda () (setq-local yas-parents '(latex-mode))))
	     (org-agenda-mode . (lambda ()
                              (visual-line-mode -1)
                              (toggle-truncate-lines 1)
                              (display-line-numbers-mode -1)
                              (setq mode-line-format nil)
                              (setq header-line-format nil)))
	     (org-capture-mode . (lambda ()
                               (setq mode-line-format nil)
                               (setq header-line-format nil))))

  :custom
  (org-modules nil)
  (org-directory my/org-directory)
  (org-log-done 'time)
  (org-pretty-entities t)
  (org-log-into-drawer t)
  (org-return-follows-link t)
  (org-src-fontify-natively t)
  (org-element-use-cache t)
  (org-hide-leading-stars t)
  (org-fontify-done-headline t)
  (org-fontify-todo-headline t)
  (org-fontify-whole-heading-line t)
  (org-fontify-quote-and-verse-blocks t)
  (org-hide-emphasis-markers t)
  (org-element-cache-persistent t)
  ;; (org-fontify-quote-and-verse-blocks nil)
  ;; (org-fontify-whole-heading-line nil)
  ;; (org-fontify-done-headline nil)
  (org-highlight-latex-and-related nil)
  (org-src-preserve-indentation t)
  (org-edit-src-content-indentation 0)
  (org-startup-folded 'overview)
  (org-startup-with-inline-images nil)
  (org-startup-with-latex-preview nil)
  (org-cycle-separator-lines 2)

  (org-todo-keywords
   '((sequence "TODO(t)" "NEXT(n)" "PROG(p)" "WAIT(w@/!)" "|" "DONE(d!)" "CANCEL(c@)")
	 (sequence "PLAN(P)" "ACTIVE(A)" "PAUSED(x)" "|" "ACHIEVED(a)" "DROPPED(D)")))

  (org-todo-keyword-faces
   '(("TODO"      . (:foreground "#f7768e" :weight bold))
     ("NEXT"      . (:foreground "#ff9e64" :weight bold))
     ("PROG"      . (:foreground "#7aa2f7" :weight bold))
     ("WAIT"      . (:foreground "#e0af68" :weight bold))
     ("DONE"      . (:foreground "#9ece6a" :weight bold))
     ("CANCEL"    . (:foreground "#565f89" :weight bold))
     ("PLAN"      . (:foreground "#7dcfff" :weight bold))
     ("ACTIVE"    . (:foreground "#bb9af7" :weight bold))
     ("PAUSED"    . (:foreground "#a9b1d6" :weight bold))
     ("ACHIEVED"  . (:foreground "#9ece6a" :weight bold))
     ("DROPPED"   . (:foreground "#565f89" :weight bold))))

  (org-tag-alist '(("@work"      . ?w)
		   ("@home"      . ?h)
		   ("@computer"  . ?c)
		   ("@errands"   . ?e)
		   ("read"       . ?r)
		   ("meeting"    . ?m)
		   ("urgent"     . ?u)
		   ("someday"    . ?s)))


  (org-priority-faces '((?A . error)
                        (?B . warning)
                        (?C . success)))

  ;; Agenda styling
  (org-agenda-files (list my/org-directory))
  (org-agenda-block-separator ?─)
  (org-agenda-time-grid
   '((daily today require-timed)
     (800 1000 1200 1400 1600 1800 2000)
     " ┄┄┄┄┄ " "┄┄┄┄┄┄┄┄┄┄┄┄┄┄┄"))
  (org-agenda-current-time-string
   "⭠ now ─────────────────────────────────────────────────")
  (org-agenda-inhibit-startup t)
  (org-agenda-dim-blocked-tasks nil)
  (org-agenda-use-tag-inheritance nil)
  (org-agenda-ignore-properties '(effort appt category))
  (org-agenda-span 'day)
  (org-tags-column -80)
  (org-catch-invisible-edits 'smart)

  :config
  (defun hot-expand (str &optional mod)
    (let (text)
      (when (region-active-p)
        (setq text (buffer-substring (region-beginning) (region-end)))
        (delete-region (region-beginning) (region-end)))
      (insert str)
      (if (fboundp 'org-try-structure-completion)
          (org-try-structure-completion) ; < org 9
        (progn
          ;; New template expansion since org 9
          (require 'org-tempo nil t)
          (org-tempo-complete-tag)))
      (when mod (insert mod) (forward-line))
      (when text (insert text))))

  ;; Babel
  (setq org-confirm-babel-evaluate nil
        org-src-fontify-natively t
        org-src-tab-acts-natively t)

  (defconst load-language-alist
    '((emacs-lisp . t)
      (perl       . t)
      (python     . t)
      (ruby       . t)
      (js         . t)
      (css        . t)
      (sass       . t)
      (C          . t)
      (java       . t)
      (shell      . t)
      (plantuml   . t))
    "Alist of org ob languages.")

  (org-babel-do-load-languages 'org-babel-load-languages
                               load-language-alist)

  
  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python"))
  (add-to-list 'org-structure-template-alist '("jpy" . "src jupyter-python"))
  (add-to-list 'org-structure-template-alist '("tex" . "src latex")))
#+end_src

** Org Appear
#+begin_src emacs-lisp
(use-package org-appear
  :hook (org-mode . org-appear-mode)
  :custom
  (org-appear-autoentities t)
  (org-appear-autokeywords t)
  (org-appear-autolinks t)
  (org-appear-autosubmarkers t)
  (org-appear-inside-latex t)
  (org-appear-manual-linger t)
  (org-appear-delay 0.5))
#+end_src

** Org Roam
#+begin_src emacs-lisp
;; Org-Roam Configuration
(when (and (fboundp 'sqlite-available-p) (sqlite-available-p))
  (use-package org-roam
    :defer t
    :functions org-roam-db-autosync-enable
    :defines org-roam-graph-viewer
    :init
    (setq org-roam-directory (expand-file-name "roam/" my/org-directory))
    :custom
    (org-roam-completion-everywhere t)
    (org-roam-node-display-template
     (concat "${title:*} "
             (propertize "${tags:20}" 'face 'org-tag)))
    :config
    (add-to-list 'org-agenda-files org-roam-directory)

    ;; Delay database sync until idle
    (run-with-idle-timer 5 nil #'org-roam-db-autosync-enable)
 

    ;; Templates for different kinds of notes (Zettelkasten)
    (setq org-roam-capture-templates
          '(("d" "default" plain "%?"
             :target (file+head "${slug}.org"
                                "#+title: ${title}\n#+filetags: \n\n")
             :unnarrowed t)

            ("p" "project" plain "* Goal\n\n%?\n\n* Tasks\n\n* Notes\n\n* Log\n"
             :target (file+head "projects/${slug}.org"
                                "#+title: Project: ${title}\n#+filetags: project\n")
             :unnarrowed t)

            ("l" "literature note" plain "* Source\n- Author: %?\n- Title: \n- Year: \n\n* Summary\n\n* Key Takeaways\n\n* Quotes\n"
             :target (file+head "literature/${slug}.org"
                                "#+title: ${title}\n#+filetags: literature\n")
             :unnarrowed t)

            ("i" "idea" plain "* %?"
             :target (file+head "ideas/${slug}.org"
                                "#+title: ${title}\n#+filetags: idea fleeting\n")
             :unnarrowed t)

            ("z" "zettel" plain "* %?\n\n* References\n\n"
             :target (file+head "zettel/${slug}.org"
                                "#+title: ${title}\n#+filetags: zettel permanent\n")
             :unnarrowed t)))

    ;; Dailies configuration
    (setq org-roam-dailies-directory "daily/"
          org-roam-dailies-capture-templates
          '(("d" "default" entry "* %?"
             :target (file+head "%<%Y-%m-%d>.org"
                                "#+title: %<%Y-%m-%d %A>\n\n"))

            ("j" "journal" entry "* %<%H:%M> - Journal\n\n%?"
             :target (file+head "%<%Y-%m-%d>.org"
                                "#+title: %<%Y-%m-%d %A>\n\n"))

            ("m" "meeting" entry "* %<%H:%M> - %^{Meeting Title}\n\n** Attendees\n- %?\n\n** Notes\n\n** Action Items\n"
             :target (file+head "%<%Y-%m-%d>.org"
                                "#+title: %<%Y-%m-%d %A>\n\n"))))))

(use-package org-roam-ui
  :after org-roam
  :commands (org-roam-ui-mode org-roam-ui-open)
  :custom
  (org-roam-ui-sync-theme t)
  (org-roam-ui-follow t)
  (org-roam-ui-update-on-save t)
  (org-roam-ui-open-on-start nil))

(use-package consult-org-roam
   :after org-roam
   :init
   (require 'consult-org-roam)
   ;; Activate the minor mode
   (consult-org-roam-mode 1)
   :custom
   ;; Use `ripgrep' for searching with `consult-org-roam-search'
   (consult-org-roam-grep-func #'consult-ripgrep)
   ;; Configure a custom narrow key for `consult-buffer'
   (consult-org-roam-buffer-narrow-key ?r)
   ;; Display org-roam buffers right after non-org-roam buffers
   ;; in consult-buffer (and not down at the bottom)
   (consult-org-roam-buffer-after-buffers t)
   :config
   ;; Eventually suppress previewing for certain functions
   (consult-customize
    consult-org-roam-forward-links
    :preview-key "M-."))
#+end_src

** Capture: The Gateway to Org
*Use dynamic directory*
#+begin_src emacs-lisp
(defun my/find-org-projects ()
  "Find all org files in the projects directory."
  (directory-files (expand-file-name "projects" my/org-directory) t "\\.org$"))

(use-package org-capture
  :defer t
  :ensure nil
  :after org
  :custom
  (org-capture-templates
   `(("t" "Task" entry
      (file+headline ,(expand-file-name "inbox.org" my/org-directory) "Tasks")
      "* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:\n")

     ("n" "Note" entry
      (file+headline ,(expand-file-name "inbox.org" my/org-directory) "Notes")
      "* %? :note:\n:PROPERTIES:\n:CREATED: %U\n:SOURCE:\n:END:\n")

     ("j" "Journal" entry
      (file+olp+datetree ,(expand-file-name "journal.org" my/org-directory))
      "* %U %?\n")

     ("m" "Meeting" entry
      (file+headline ,(expand-file-name "inbox.org" my/org-directory) "Meetings")
      "* Meeting: %? :meeting:\n:PROPERTIES:\n:CREATED: %U\n:ATTENDEES:\n:END:\n** Agenda\n** Notes\n** Action Items\n")

     ("p" "Project" entry
      (file+headline ,(expand-file-name "projects.org" my/org-directory) "Projects")
      "* PLAN %? :project:\n:PROPERTIES:\n:CREATED: %U\n:GOAL:\n:DEADLINE:\n:END:\n** Goals\n** Tasks\n*** TODO Define project scope\n** Resources\n** Notes\n")

     ("P" "Project Task" entry
      (file (lambda ()
              (let* ((files (my/find-org-projects))
                     (file (completing-read "Select Project: "
                                           (mapcar #'file-name-nondirectory files)
                                           nil t)))
                (car (seq-filter
                      (lambda (f) (string= (file-name-nondirectory f) file))
                      files)))))
      "* TODO %?\n:PROPERTIES:\n:CREATED: %U\n:END:\n"
      :prepend t
      :headline "Tasks")

     ("b" "Book" entry
      (file+headline ,(expand-file-name "reading.org" my/org-directory) "Reading List")
      "* %? :book:read:\n:PROPERTIES:\n:CREATED: %U\n:AUTHOR:\n:GENRE:\n:PAGES:\n:STARTED:\n:FINISHED:\n:RATING:\n:END:\n** Summary\n** Key Takeaways\n** Quotes\n")

     ("h" "Habit" entry
      (file+headline ,(expand-file-name "habits.org" my/org-directory) "Habits")
      "* TODO %? :habit:\nSCHEDULED: %(format-time-string \"<%Y-%m-%d %a .+1d>\")\n:PROPERTIES:\n:CREATED: %U\n:STYLE: habit\n:END:\n")

     ("g" "Goal" entry
      (file+headline ,(expand-file-name "goals.org" my/org-directory) "Goals")
      "* GOAL %? :goal:\nDEADLINE: %(org-read-date nil nil \"+1y\")\n:PROPERTIES:\n:CREATED: %U\n:TYPE:\n:END:\n** Why this goal?\n** Success criteria\n** Action steps\n*** TODO Break down into smaller tasks\n** Resources needed\n** Potential obstacles\n** Progress tracking\n"))))
#+end_src

** Org Habit
#+begin_src emacs-lisp
(use-package org-habit
  :ensure nil
  :defer t
  :after org
  :custom
  (org-habit-graph-column 60)
  (org-habit-show-habits-only-for-today t)
  (org-habit-preceding-days 21)
  (org-habit-following-days 7)
  (org-habit-completed-glyph
   (string-to-char (nerd-icons-codicon "nf-cod-check")))
  (org-habit-today-glyph
   (string-to-char (nerd-icons-codicon "nf-cod-circle_filled"))))
#+end_src

** Org Download
#+begin_src emacs-lisp
(use-package org-download
  :defer t
  :after org
  :custom
  (org-download-screenshot-method "grim -g \"$(slurp)\" - | swappy -f - -o -")
  (org-download-image-dir "assets")
  (org-download-method 'attach)
  (org-download-timestamp "%Y-%m-%d-%H%M%S_")
  (org-download-display-inline t)
  (org-image-actual-width 600)
  :config
  (advice-add 'org-download-dnd :after #'org-download-display-inline-images))
#+end_src

** Org Modern
#+begin_src emacs-lisp
(use-package org-modern
  :hook (org-mode . org-modern-mode)
  :config
  (setq org-modern-hide-stars nil
        org-modern-star '("◉" "○" "◈" "◇" "◆" "▷")
        org-modern-list '((43 . "➤") (45 . "–") (42 . "•"))
        org-modern-table-vertical 1
        org-modern-table-horizontal 0.1
        org-modern-block-name
        '(("src" "»" "«")
          ("example" "»" "«")
          ("quote" """ """))

        org-modern-todo-faces
        '(("TODO"      . (:foreground "#f7768e" :weight bold))
          ("NEXT"      . (:foreground "#ff9e64" :weight bold))
          ("PROG"      . (:foreground "#7aa2f7" :weight bold))
          ("WAIT"      . (:foreground "#e0af68" :weight bold))
          ("DONE"      . (:background "#20293a" :foreground "#9ece6a" :weight bold))
          ("CANCEL"    . (:strike-through t :foreground "#565f89"))
          ("PLAN"      . (:foreground "#7dcfff" :weight bold))
          ("ACTIVE"    . (:foreground "#bb9af7" :weight bold))
          ("PAUSED"    . (:foreground "#a9b1d6" :weight bold))
          ("ACHIEVED"  . (:background "#20293a" :foreground "#9ece6a" :weight bold :box t))
          ("DROPPED"   . (:strike-through t :foreground "#565f89")))

        org-modern-tag-faces
        `((:foreground "#a9b1d6" :weight bold :box (:line-width (1 . -1) :color "#414868")))
        org-modern-checkbox '((todo . "☐") (done . "☑") (cancel . "☑") (priority . "⚑") (on . "◉") (off . "◯"))))
#+end_src

* Treesitter/Folding
#+begin_src emacs-lisp
(with-eval-after-load 'tresit
  (setq treesit-font-lock-level 4)
  (setq major-mode-remap-alist
        '((typescript-mode . typescript-ts-mode)
          (js-mode . javascript-ts-mode)
          (elisp-mode . elisp-ts-mode)
          (python-mode . python-ts-mode)
          (json-mode . json-ts-mode))))

(use-package treesit-auto
  :defer t
  :custom
  (treesit-auto-install 'prompt)
  :config
  (treesit-auto-add-to-auto-mode-alist 'all)
  (global-treesit-auto-mode))

(use-package treesit-fold
  :defer t
  :hook (((after-elpaca-init . global-treesit-fold-indicators-mode)
          treesit-auto-mode-hook . treesit-fold-mode))
  :init (setq treesit-fold-indicators-priority -1))

(use-package evil-textobj-tree-sitter
  :defer t
  :after evil
  :config
  ;; Goto start of next function
  (define-key evil-normal-state-map
              (kbd "]f")
              (lambda ()
                (interactive)
                (evil-textobj-tree-sitter-goto-textobj "function.outer")))

  ;; Goto start of previous function
  (define-key evil-normal-state-map
              (kbd "[f")
              (lambda ()
                (interactive)
                (evil-textobj-tree-sitter-goto-textobj "function.outer" t)))

  ;; Goto end of next function
  (define-key evil-normal-state-map
              (kbd "]F")
              (lambda ()
                (interactive)
                (evil-textobj-tree-sitter-goto-textobj "function.outer" nil t)))

  ;; Goto end of previous function
  (define-key evil-normal-state-map
              (kbd "[F")
            (lambda ()
              (interactive)
              (evil-textobj-tree-sitter-goto-textobj "function.outer" t t))))

(use-package hideshow
  :ensure nil
  :defer t
  :pretty-hydra
  ((:title (pretty-hydra-title "HideShow" 'octicon "nf-oct-fold")
    :color amaranth :quit-key ("q" "C-g"))
   ("Fold"
    (("t" hs-toggle-all "toggle all")
     ("a" hs-show-all "show all")
     ("i" hs-hide-all "hide all")
     ("g" hs-toggle-hiding "toggle hiding")
     ("c" hs-cycle "cycle block")
     ("s" hs-show-block "show block")
     ("h" hs-hide-block "hide block")
     ("l" hs-hide-level "hide level"))
    "Move"
    (("C-a" mwim-beginning-of-code-or-line "⭰")
     ("C-e" mwim-end-of-code-or-line "⭲")
     ("C-b" backward-char "←")
     ("C-n" next-line "↓")
     ("C-p" previous-line "↑")
     ("C-f" forward-char "→")
     ("C-v" pager-page-down "↘")
     ("M-v" pager-page-up "↖")
     ("M-<" beginning-of-buffer "⭶")
     ("M->" end-of-buffer "⭸"))))
  :bind (:map hs-minor-mode-map
         ("C-~" . hideshow-hydra/body)
         ("C-S-<escape>" . hideshow-hydra/body))
  :hook (prog-mode . hs-minor-mode)
  :config
  ;; More functions
  ;; @see https://karthinks.com/software/simple-folding-with-hideshow/
  (defun hs-cycle (&optional level)
    (interactive "p")
    (let (message-log-max
          (inhibit-message t))
      (if (= level 1)
          (pcase last-command
            ('hs-cycle
             (hs-hide-level 1)
             (setq this-command 'hs-cycle-children))
            ('hs-cycle-children
             (save-excursion (hs-show-block))
             (setq this-command 'hs-cycle-subtree))
            ('hs-cycle-subtree
             (hs-hide-block))
            (_
             (if (not (hs-already-hidden-p))
                 (hs-hide-block)
               (hs-hide-level 1)
               (setq this-command 'hs-cycle-children))))
        (hs-hide-level level)
        (setq this-command 'hs-hide-level))))

  (defun hs-toggle-all ()
    "Toggle hide/show all."
    (interactive)
    (pcase last-command
      ('hs-toggle-all
       (save-excursion (hs-show-all))
       (setq this-command 'hs-global-show))
      (_ (hs-hide-all))))

  ;; Display line counts
  (defun hs-display-code-line-counts (ov)
    "Display line counts when hiding codes."
    (when (eq 'code (overlay-get ov 'hs))
      (overlay-put ov 'display
                   (concat
                    " "
                    (propertize
                     (if (char-displayable-p ?⏷) "⏷" "...")
                     'face 'shadow)
                    (propertize
                     (format " (%d lines)"
                             (count-lines (overlay-start ov)
                                          (overlay-end ov)))
                     'face '(:inherit shadow :height 0.8))
                    " "))))
  (setq hs-set-up-overlay #'hs-display-code-line-counts))

(use-package vimish-fold
  :defer t
  :after evil
  :config
  (vimish-fold-global-mode 1))

(use-package evil-vimish-fold
  :defer t
  :after vimish-fold
  :init
  (setq evil-vimish-fold-mode-lighter " ⮒")
  (setq evil-vimish-fold-target-modes '(prog-mode conf-mode text-mode))
  :config
  (global-evil-vimish-fold-mode))
#+end_src

* Prettify Symbols
** Core Configuration
#+begin_src emacs-lisp
(use-package prog-mode
  :ensure nil
  :pretty-hydra
  ((:title (pretty-hydra-title "Prettify Symbols" 'mdicon "nf-md-code_tags")
    :color amaranth :quit-key ("q" "C-g"))
   ("Toggle"
    (("s" prettify-symbols-mode "mode" :toggle t)
     ("a" ar/prettify-symbols-toggle-aggressive "aggressive")
     ("u" ar/prettify-symbols-toggle-unprettify-at-point "unprettify"))
    "Info"
    (("p" ar/prettify-symbols-show-at-point "at point")
     ("l" ar/prettify-symbols-list-all "list all")
     ("d" ar/prettify-symbols-describe-char "describe"))
    "Edit"
    (("r" ar/prettify-symbols-reload "reload")
     ("i" ar/prettify-symbols-insert-unicode "insert"))))
  :bind ("C-c s" . prog-mode-hydra/body)
  :init
  ;; Unprettify when cursor approaches symbol (critical for editing)
  (setq prettify-symbols-unprettify-at-point 'right-edge)
  
  ;; Core configuration variables
  (defvar ar/prettify-symbols-base-alist
    '(;; Relational operators
      ("!=" . ?≠)              ; U+2260 NOT EQUAL TO
      ("<=" . ?≤)              ; U+2264 LESS-THAN OR EQUAL TO
      (">=" . ?≥)              ; U+2265 GREATER-THAN OR EQUAL TO
      ("==" . ?≡)              ; U+2261 IDENTICAL TO
      
      ;; Arrows (common across languages)
      ("->" . ?→)              ; U+2192 RIGHTWARDS ARROW
      ("=>" . ?⇒)              ; U+21D2 RIGHTWARDS DOUBLE ARROW
      ("<-" . ?←)              ; U+2190 LEFTWARDS ARROW
      
      ;; Mathematical operators
      ("sqrt" . ?√)            ; U+221A SQUARE ROOT
      ("sum" . ?∑)             ; U+2211 N-ARY SUMMATION
      ("pi" . ?π)              ; U+03C0 GREEK SMALL LETTER PI
      
      ;; Common symbols
      ("..." . ?…)             ; U+2026 HORIZONTAL ELLIPSIS
      ("lambda" . ?λ))         ; U+03BB GREEK SMALL LETTER LAMBDA
    "Base prettify symbols shared across multiple modes.")
  
  ;; Enable globally but allow modes to opt out
  :config
  (global-prettify-symbols-mode +1))
#+end_src

** Custom Compose Predicate
#+begin_src emacs-lisp
(defun ar/prettify-symbols-compose-p-default (start end _match)
  "Custom compose predicate that's more permissive than default.
Allows prettification in more contexts while still being safe."
  (let* ((syntaxes-beg (if (memq (char-syntax (char-after start)) '(?w ?_))
                          '(?w ?_) '(?. ?\\)))
         (syntaxes-end (if (memq (char-syntax (char-before end)) '(?w ?_))
                          '(?w ?_) '(?. ?\\))))
    (and
     ;; Check that surrounding syntax matches
     (not (memq (char-syntax (or (char-before start) ?\s)) syntaxes-beg))
     (not (memq (char-syntax (or (char-after end) ?\s)) syntaxes-end))
     ;; Avoid prettifying in strings (usually)
     ;; Remove this check if you want prettification in strings
     (not (nth 3 (syntax-ppss))))))

(defun ar/prettify-symbols-compose-p-aggressive (start end match)
  "More aggressive compose predicate that prettifies in comments and strings.
Use this if you want maximum prettification."
  (let* ((syntaxes-beg (if (memq (char-syntax (char-after start)) '(?w ?_))
                          '(?w ?_) '(?. ?\\)))
         (syntaxes-end (if (memq (char-syntax (char-before end)) '(?w ?_))
                          '(?w ?_) '(?. ?\\))))
    (and
     ;; Check that surrounding syntax matches
     (not (memq (char-syntax (or (char-before start) ?\s)) syntaxes-beg))
     (not (memq (char-syntax (or (char-after end) ?\s)) syntaxes-end)))))
#+end_src

** Emacs Lisp
#+begin_src emacs-lisp
(defun ar/prettify-symbols-elisp-setup ()
  "Configure prettify-symbols for Emacs Lisp modes."
  (setq prettify-symbols-alist
        (append
         ar/prettify-symbols-base-alist
         '(;; Lisp-specific symbols
           ("defun" . ?ƒ)          ; U+0192 LATIN SMALL LETTER F WITH HOOK
           ("defmacro" . ?μ)       ; U+03BC GREEK SMALL LETTER MU
           
           ;; Logical operators
           ("not" . ?¬)            ; U+00AC NOT SIGN
           ("and" . ?∧)            ; U+2227 LOGICAL AND
           ("or" . ?∨)             ; U+2228 LOGICAL OR
           
           ;; Special comparisons
           ("/=" . ?≠)             ; U+2260 NOT EQUAL TO
           
           ;; Constants (commented out - can be confusing)
           ;; ("nil" . ?∅)         ; U+2205 EMPTY SET
           ;; ("t" . ?⊤)           ; U+22A4 DOWN TACK (true)
           ))))

;; Apply to all Emacs Lisp modes
(add-hook 'emacs-lisp-mode-hook #'ar/prettify-symbols-elisp-setup)
(add-hook 'lisp-interaction-mode-hook #'ar/prettify-symbols-elisp-setup)
(add-hook 'inferior-emacs-lisp-mode-hook #'ar/prettify-symbols-elisp-setup)
#+end_src

** Python
#+begin_src emacs-lisp
(defun ar/prettify-symbols-python-setup ()
  "Configure prettify-symbols for Python modes."
  (setq prettify-symbols-alist
        (append
         ar/prettify-symbols-base-alist
         '(;; Python keywords - selective to maintain readability
           ("def" . ?ƒ)            ; U+0192 LATIN SMALL LETTER F WITH HOOK
           ("class" . ?𝒞)          ; U+1D49E MATHEMATICAL SCRIPT CAPITAL C
           ("return" . ?⟼)         ; U+27FC LONG RIGHTWARDS ARROW FROM BAR
           ("yield" . ?⟻)          ; U+27FB LONG LEFTWARDS ARROW FROM BAR
           
           ;; Python operators
           ("not" . ?¬)            ; U+00AC NOT SIGN
           ("in" . ?∈)             ; U+2208 ELEMENT OF
           ("not in" . ?∉)         ; U+2209 NOT AN ELEMENT OF
           ("and" . ?∧)            ; U+2227 LOGICAL AND
           ("or" . ?∨)             ; U+2228 LOGICAL OR
           
           ;; Python constants
           ("None" . ?∅)           ; U+2205 EMPTY SET
           ("True" . ?⊤)           ; U+22A4 DOWN TACK
           ("False" . ?⊥)          ; U+22A5 UP TACK
           
           ;; Type hints (Python 3.5+)
           ("int" . ?ℤ)            ; U+2124 DOUBLE-STRUCK CAPITAL Z
           ("float" . ?ℝ)          ; U+211D DOUBLE-STRUCK CAPITAL R
           ("str" . ?𝕊)            ; U+1D54A MATHEMATICAL DOUBLE-STRUCK CAPITAL S
           ("bool" . ?𝔹)           ; U+1D539 MATHEMATICAL DOUBLE-STRUCK CAPITAL B
           
           ;; Common type hints (commented - can be too aggressive)
           ;; ("List" . ?𝐋)        ; U+1D40B MATHEMATICAL BOLD CAPITAL L
           ;; ("Dict" . ?𝐃)        ; U+1D403 MATHEMATICAL BOLD CAPITAL D
           ;; ("Set" . ?𝐒)         ; U+1D412 MATHEMATICAL BOLD CAPITAL S
           ;; ("Tuple" . ?𝐓)       ; U+1D413 MATHEMATICAL BOLD CAPITAL T
           ;; ("Optional" . ??)    ; U+2370 APL FUNCTIONAL SYMBOL QUAD QUESTION
           )))
  
  ;; Custom predicate for Python to avoid conflicts with docstrings
  (setq prettify-symbols-compose-predicate
        #'ar/prettify-symbols-compose-p-default))

;; Apply to Python modes
(add-hook 'python-mode-hook #'ar/prettify-symbols-python-setup)
(add-hook 'python-ts-mode-hook #'ar/prettify-symbols-python-setup)
#+end_src

** JavaScript/TypeScript
#+begin_src emacs-lisp
(defun ar/prettify-symbols-javascript-setup ()
  "Configure prettify-symbols for JavaScript and TypeScript."
  (setq prettify-symbols-alist
        (append
         ar/prettify-symbols-base-alist
         '(;; JavaScript arrows and functions
           ("function" . ?ƒ)       ; U+0192 LATIN SMALL LETTER F WITH HOOK
           
           ;; Logical operators
           ("&&" . ?∧)             ; U+2227 LOGICAL AND
           ("||" . ?∨)             ; U+2228 LOGICAL OR
           
           ;; Strict equality (JavaScript-specific)
           ("===" . ?≡)            ; U+2261 IDENTICAL TO
           ("!==" . ?≢)            ; U+2262 NOT IDENTICAL TO
           
           ;; Special values
           ("null" . ?∅)           ; U+2205 EMPTY SET
           ("undefined" . ?⊥)      ; U+22A5 UP TACK
           
           ;; Math constants (when using Math object)
           ("Math.PI" . ?π)        ; U+03C0 GREEK SMALL LETTER PI
           ("Infinity" . ?∞)       ; U+221E INFINITY
           ))))

;; Apply to JavaScript and TypeScript modes
(add-hook 'javascript-mode-hook #'ar/prettify-symbols-javascript-setup)
(add-hook 'js-mode-hook #'ar/prettify-symbols-javascript-setup)
(add-hook 'js-ts-mode-hook #'ar/prettify-symbols-javascript-setup)
(add-hook 'typescript-mode-hook #'ar/prettify-symbols-javascript-setup)
(add-hook 'typescript-ts-mode-hook #'ar/prettify-symbols-javascript-setup)
(add-hook 'javascript-ts-mode-hook #'ar/prettify-symbols-javascript-setup)
#+end_src

** Shell/Bash
#+begin_src emacs-lisp
(defun ar/prettify-symbols-shell-setup ()
  "Configure prettify-symbols for shell scripts."
  (setq prettify-symbols-alist
        (append
         ar/prettify-symbols-base-alist
         '(;; Test operators (be conservative here)
           ("-eq" . ?=)            ; Keep simple for readability
           ("-ne" . ?≠)            ; U+2260 NOT EQUAL TO
           ("-le" . ?≤)            ; U+2264 LESS-THAN OR EQUAL TO
           ("-ge" . ?≥)            ; U+2265 GREATER-THAN OR EQUAL TO
           
           ;; Logical operators
           ("&&" . ?∧)             ; U+2227 LOGICAL AND
           ("||" . ?∨)             ; U+2228 LOGICAL OR
           
           ;; Don't prettify pipe | - it's too fundamental to shell syntax
           ))))

;; Apply to shell modes
(add-hook 'sh-mode-hook #'ar/prettify-symbols-shell-setup)
(add-hook 'bash-ts-mode-hook #'ar/prettify-symbols-shell-setup)
#+end_src

** C/C++
#+begin_src emacs-lisp
(defun ar/prettify-symbols-c-setup ()
  "Configure prettify-symbols for C/C++ modes."
  (setq prettify-symbols-alist
        (append
         ar/prettify-symbols-base-alist
         '(;; C/C++ specific
           ("NULL" . ?∅)           ; U+2205 EMPTY SET
           ("nullptr" . ?∅)        ; U+2205 EMPTY SET (C++11)
           
           ;; Logical operators (standard C operators)
           ("&&" . ?∧)             ; U+2227 LOGICAL AND
           ("||" . ?∨)             ; U+2228 LOGICAL OR
           
           ;; Avoid prettifying -> as it's semantically important for pointers
           ;; Avoid prettifying ! as it's used frequently and would be confusing
           
           ;; Math constants
           ("M_PI" . ?π)           ; U+03C0 GREEK SMALL LETTER PI
           ("INFINITY" . ?∞)       ; U+221E INFINITY
           ))))

;; Apply to C/C++ modes
(add-hook 'c-mode-hook #'ar/prettify-symbols-c-setup)
(add-hook 'c++-mode-hook #'ar/prettify-symbols-c-setup)
(add-hook 'c-ts-mode-hook #'ar/prettify-symbols-c-setup)
(add-hook 'c++-ts-mode-hook #'ar/prettify-symbols-c-setup)
#+end_src

** Rust
#+begin_src emacs-lisp
(defun ar/prettify-symbols-rust-setup ()
  "Configure prettify-symbols for Rust mode."
  (setq prettify-symbols-alist
        (append
         ar/prettify-symbols-base-alist
         '(;; Rust-specific
           ("fn" . ?ƒ)             ; U+0192 LATIN SMALL LETTER F WITH HOOK
           
           ;; Logical operators
           ("&&" . ?∧)             ; U+2227 LOGICAL AND
           ("||" . ?∨)             ; U+2228 LOGICAL OR
           
           ;; Avoid prettifying -> as it's the return type operator in Rust
           ;; This is semantically important
           )))
  
  ;; Custom predicate for Rust to avoid conflicts with closure syntax ||
  (setq-local prettify-symbols-compose-predicate
              (lambda (start end match)
                (and (ar/prettify-symbols-compose-p-default start end match)
                     ;; Don't prettify || in closure parameters
                     (not (and (string= match "||")
                               (save-excursion
                                 (goto-char start)
                                 (looking-back "\\(?:\\<move\\|=\\) *" 
                                              (line-beginning-position)))))))))

;; Apply to Rust mode (if installed)
(with-eval-after-load 'rust-mode
  (add-hook 'rust-mode-hook #'ar/prettify-symbols-rust-setup))
(with-eval-after-load 'rust-ts-mode
  (add-hook 'rust-ts-mode-hook #'ar/prettify-symbols-rust-setup))
#+end_src

** Org Mode
#+begin_src emacs-lisp
(defun ar/prettify-symbols-org-setup ()
  "Configure prettify-symbols for Org mode.
Note: org-modern handles most visual improvements, so we're conservative here."
  (setq prettify-symbols-alist
        '(;; Arrows and implications (useful in text)
          ("->" . ?→)              ; U+2192 RIGHTWARDS ARROW
          ("<-" . ?←)              ; U+2190 LEFTWARDS ARROW
          ("=>" . ?⇒)              ; U+21D2 RIGHTWARDS DOUBLE ARROW
          ("<=" . ?≤)              ; U+2264 LESS-THAN OR EQUAL TO (when used as symbol)
          (">=" . ?≥)              ; U+2265 GREATER-THAN OR EQUAL TO (when used as symbol)
          
          ;; Common symbols in prose
          ("!=" . ?≠)              ; U+2260 NOT EQUAL TO
          ("..." . ?…)             ; U+2026 HORIZONTAL ELLIPSIS
          
          ;; Source block markers (subtle, won't conflict with org-modern)
          ;; Commented out if you prefer org-modern's handling
          ;; ("#+BEGIN_SRC" . ?»)   ; U+00BB RIGHT-POINTING DOUBLE ANGLE QUOTATION MARK
          ;; ("#+END_SRC" . ?«)     ; U+00AB LEFT-POINTING DOUBLE ANGLE QUOTATION MARK
          ;; ("#+begin_src" . ?»)
          ;; ("#+end_src" . ?«)
          ))
  
  ;; Don't prettify in code blocks (org-modern handles those)
  (setq-local prettify-symbols-compose-predicate
              (lambda (start end match)
                (and (ar/prettify-symbols-compose-p-default start end match)
                     ;; Don't prettify in src blocks
                     (not (org-in-src-block-p))))))

(add-hook 'org-mode-hook #'ar/prettify-symbols-org-setup)
#+end_src

** Markdown
#+begin_src emacs-lisp
(defun ar/prettify-symbols-markdown-setup ()
  "Configure prettify-symbols for Markdown mode."
  (setq prettify-symbols-alist
        '(;; Common symbols
          ("->" . ?→)              ; U+2192 RIGHTWARDS ARROW
          ("<-" . ?←)              ; U+2190 LEFTWARDS ARROW
          ("=>" . ?⇒)              ; U+21D2 RIGHTWARDS DOUBLE ARROW
          ("<=" . ?≤)              ; U+2264 LESS-THAN OR EQUAL TO
          (">=" . ?≥)              ; U+2265 GREATER-THAN OR EQUAL TO
          ("!=" . ?≠)              ; U+2260 NOT EQUAL TO
          ("..." . ?…)             ; U+2026 HORIZONTAL ELLIPSIS
          
          ;; Code fence markers (subtle)
          ("```" . ?‣)             ; U+2023 TRIANGULAR BULLET
          
          ;; Checkbox syntax (if using GitHub-flavored markdown)
          ;; Note: Some markdown modes handle these specially
          ("[ ]" . ?☐)          ; U+2610 BALLOT BOX
          ("[x]" . ?☑)          ; U+2611 BALLOT BOX WITH CHECK
          ("[X]" . ?☑)          ; U+2611 BALLOT BOX WITH CHECK
          )))

(add-hook 'markdown-mode-hook #'ar/prettify-symbols-markdown-setup)
(add-hook 'gfm-mode-hook #'ar/prettify-symbols-markdown-setup)
#+end_src

** Helper Functions
#+begin_src emacs-lisp
(defun ar/prettify-symbols-reload ()
  "Reload prettify-symbols-mode for current buffer.
Useful after changing symbols configuration."
  (interactive)
  (when (bound-and-true-p prettify-symbols-mode)
    (prettify-symbols-mode -1)
    (prettify-symbols-mode +1)
    (message "Prettify symbols reloaded")))

(defun ar/prettify-symbols-show-at-point ()
  "Show the actual text of prettified symbol at point in the echo area."
  (interactive)
  (let* ((pos (point))
         (props (text-properties-at pos))
         (composition (plist-get props 'composition)))
    (if composition
        (let ((start (previous-single-property-change 
                      (1+ pos) 'composition nil (point-min)))
              (end (next-single-property-change 
                    pos 'composition nil (point-max))))
          (message "Symbol: %S" (buffer-substring start end)))
      (message "No prettified symbol at point"))))

(defun ar/prettify-symbols-toggle-unprettify-at-point ()
  "Cycle through unprettify-at-point options.
nil -> right-edge -> t -> nil"
  (interactive)
  (setq prettify-symbols-unprettify-at-point
        (pcase prettify-symbols-unprettify-at-point
          ('nil 'right-edge)
          ('right-edge t)
          (_ nil)))
  (ar/prettify-symbols-reload)
  (message "Prettify unprettify-at-point: %s" 
           (pcase prettify-symbols-unprettify-at-point
             ('nil "disabled")
             ('right-edge "at right edge")
             (_ "when on symbol"))))

(defun ar/prettify-symbols-list-all ()
  "Display all prettified symbols in current buffer's alist."
  (interactive)
  (if prettify-symbols-alist
      (let ((buf (get-buffer-create "*Prettify Symbols*")))
        (with-current-buffer buf
          (erase-buffer)
          (insert (format "Prettify Symbols for %s\n" major-mode))
          (insert (make-string 50 ?=) "\n\n")
          (insert (format "%-20s %-10s %s\n" "Text" "Symbol" "Unicode"))
          (insert (make-string 50 ?-) "\n")
          (dolist (pair prettify-symbols-alist)
            (insert (format "%-20s %-10c U+%04X\n"
                           (car pair)
                           (cdr pair)
                           (cdr pair))))
          (insert "\n")
          (insert "Unprettify at point: " 
                  (format "%s" prettify-symbols-unprettify-at-point) "\n")
          (goto-char (point-min))
          (special-mode))
        (display-buffer buf))
    (message "No prettify-symbols-alist defined for this buffer")))

(defun ar/prettify-symbols-toggle-aggressive ()
  "Toggle between default and aggressive prettification predicates."
  (interactive)
  (if (eq prettify-symbols-compose-predicate 
          #'ar/prettify-symbols-compose-p-aggressive)
      (progn
        (setq-local prettify-symbols-compose-predicate
                    #'ar/prettify-symbols-compose-p-default)
        (message "Using default prettification (no strings/comments)"))
    (setq-local prettify-symbols-compose-predicate
                #'ar/prettify-symbols-compose-p-aggressive)
    (message "Using aggressive prettification (includes strings/comments)"))
  (ar/prettify-symbols-reload))

(defun ar/prettify-symbols-insert-unicode ()
  "Insert a Unicode character by name or code point.
Helpful for finding symbols to use in configuration."
  (interactive)
  (call-interactively #'insert-char))

(defun ar/prettify-symbols-describe-char ()
  "Describe the character at point, showing Unicode info."
  (interactive)
  (describe-char (point)))

;; Advice to prevent prettification from breaking indentation/alignment
;; This isn't usually needed but can help in edge cases
(defun ar/prettify-symbols-before-save ()
  "Temporarily disable prettify-symbols before saving.
Re-enables it after save. Prevents indentation issues."
  (when (bound-and-true-p prettify-symbols-mode)
    (prettify-symbols-mode -1)
    (add-hook 'after-save-hook #'ar/prettify-symbols-after-save nil t)))

(defun ar/prettify-symbols-after-save ()
  "Re-enable prettify-symbols after saving."
  (prettify-symbols-mode +1)
  (remove-hook 'after-save-hook #'ar/prettify-symbols-after-save t))

;; Uncomment to enable save protection (usually not needed)
;; (add-hook 'before-save-hook #'ar/prettify-symbols-before-save)

#+end_src
* Elisp
#+begin_src emacs-lisp
(use-package elisp-mode
  :ensure nil
  :config
  (with-no-warnings
    (defun my-lisp-indent-function (indent-point state)
      (let ((normal-indent (current-column))
            (orig-point (point)))
        (goto-char (1+ (elt state 1)))
        (parse-partial-sexp (point) calculate-lisp-indent-last-sexp 0 t)
        (cond
         ((and (elt state 2)
               (or (not (looking-at "\\sw\\|\\s_"))
                   (looking-at ":")))
          (if (not (> (save-excursion (forward-line 1) (point))
                     calculate-lisp-indent-last-sexp))
              (progn (goto-char calculate-lisp-indent-last-sexp)
                     (beginning-of-line)
                     (parse-partial-sexp (point)
                                         calculate-lisp-indent-last-sexp 0 t)))
          (backward-prefix-chars)
          (current-column))
         ((and (save-excursion
                 (goto-char indent-point)
                 (skip-syntax-forward " ")
                 (not (looking-at ":")))
               (save-excursion
                 (goto-char orig-point)
                (looking-at ":")))
         (save-excursion
           (goto-char (+ 2 (elt state 1)))
           (current-column)))
        (t
         (let ((function (buffer-substring (point)
                                           (progn (forward-sexp 1) (point))))
               method)
           (setq method (or (function-get (intern-soft function)
                                          'lisp-indent-function)
                            (get (intern-soft function) 'lisp-indent-hook)))
           (cond ((or (eq method 'defun)
                      (and (null method)
                           (length> function 3)
                           (string-match "\\`def" function)))
                  (lisp-indent-defform state indent-point))
                 ((integerp method)
                  (lisp-indent-specform method state
                                        indent-point normal-indent))
                 (method
                  (funcall method indent-point state))))))))
   (add-hook 'emacs-lisp-mode-hook
             (lambda () (setq-local lisp-indent-function #'my-lisp-indent-function)))

   ;; Add remove buttons for advices
   (add-hook 'help-mode-hook 'cursor-sensor-mode)

   (defun function-advices (function)
     "Return FUNCTION's advices."
     (let ((flist (indirect-function function)) advices)
       (while (advice--p flist)
         (setq advices `(,@advices ,(advice--car flist)))
         (setq flist (advice--cdr flist)))
       advices))

   (defun add-remove-advice-button (advice function)
     (when (and (functionp advice) (functionp function))
       (let ((inhibit-read-only t)
             (msg (format "Remove advice `%s'" advice)))
         (insert "\t")
         (insert-button
          "Remove"
          'face 'custom-button
          'cursor-sensor-functions `((lambda (&rest _) ,msg))
          'help-echo msg
          'action (lambda (_)
                    (when (yes-or-no-p msg)
                      (message "%s from function `%s'" msg function)
                      (advice-remove function advice)
                      (if (eq major-mode 'helpful-mode)
                          (helpful-update)
                        (revert-buffer nil t))))
          'follow-link t))))

   (defun add-button-to-remove-advice (buffer-or-name function)
     "Add a button to remove advice."
     (with-current-buffer buffer-or-name
       (save-excursion
         (goto-char (point-min))
         (let ((ad-list (function-advices function)))
           (while (re-search-forward "^\\(?:This function has \\)?:[-a-z]+ advice: \\(.+\\)$" nil t)
             (let ((advice (car ad-list)))
               (add-remove-advice-button advice function)
               (setq ad-list (delq advice ad-list))))))))

   (define-advice describe-function-1 (:after (function) advice-remove-button)
     (add-button-to-remove-advice (help-buffer) function))
   (with-eval-after-load 'helpful
     (define-advice helpful-update (:after () advice-remove-button)
       (when helpful--callable-p
         (add-button-to-remove-advice (current-buffer) helpful--sym))))

   ;; Remove hooks
   (defun remove-hook-at-point ()
     "Remove the hook at the point in the *Help* buffer."
     (interactive)
     (unless (memq major-mode '(help-mode helpful-mode))
       (error "Only for help-mode or helpful-mode"))

     (let ((orig-point (point)))
       (save-excursion
         (when-let*
             ((hook (progn (goto-char (point-min)) (symbol-at-point)))
              (func (when (and
                           (or (re-search-forward (format "^Value:?[\s|\n]") nil t)
                               (goto-char orig-point))
                           (sexp-at-point))
                      (end-of-sexp)
                      (backward-char 1)
                      (catch 'break
                        (while t
                          (condition-case _err
                              (backward-sexp)
                            (scan-error (throw 'break nil)))
                          (let ((bounds (bounds-of-thing-at-point 'sexp)))
                            (when (<= (car bounds) orig-point (cdr bounds))
                              (throw 'break (sexp-at-point)))))))))
           (when (yes-or-no-p (format "Remove %s from %s? " func hook))
             (remove-hook hook func)
             (if (eq major-mode 'helpful-mode)
                 (helpful-update)
               (revert-buffer nil t)))))))
   (bind-key "r" #'remove-hook-at-point help-mode-map)))

;; Syntax highlighting of known Elisp symbols
(if (boundp 'elisp-fontify-semantically)
    (setq elisp-fontify-semantically t)
  (use-package highlight-defined
    :hook ((emacs-lisp-mode inferior-emacs-lisp-mode) . highlight-defined-mode)))

(use-package macrostep)

;; A better *Help* buffer
(use-package helpful
  :bind (([remap describe-function] . helpful-callable)
         ([remap describe-command]  . helpful-command)
         ([remap describe-variable] . helpful-variable)
         ([remap describe-key]      . helpful-key)
         ([remap describe-symbol]   . helpful-symbol))
  :hook (helpful-mode . cursor-sensor-mode) ; for remove-advice button
  :init
  (with-no-warnings
    (with-eval-after-load 'apropos
      ;; patch apropos buttons to call helpful instead of help
      (dolist (fun-bt '(apropos-function apropos-macro apropos-command))
        (button-type-put
         fun-bt 'action
         (lambda (button)
           (helpful-callable (button-get button 'apropos-symbol)))))
      (dolist (var-bt '(apropos-variable apropos-user-option))
        (button-type-put
         var-bt 'action
         (lambda (button)
           (helpful-variable (button-get button 'apropos-symbol))))))))
#+end_src

* Editor Behaviour
** Automatically reload files was modified by external program
#+begin_src emacs-lisp
(use-package autorevert
  :ensure nil
  :hook (elpaca-after-init . global-auto-revert-mode))
#+end_src

** Avy/Ace
#+begin_src emacs-lisp
;; Jump to things in Emacs tree-style
(use-package avy
  :hook (elpaca-after-init . avy-setup-default)
  :config (setq avy-all-windows nil
                avy-all-windows-alt t
                avy-background t
                avy-style 'pre))

;; Kill text between the point and the character CHAR
(use-package avy-zap
  :defer t)

;; Quickly follow links
(use-package ace-link
  :hook (elpaca-after-init . ace-link-setup-default))
#+end_src

** Anzu
#+begin_src emacs-lisp
(use-package anzu
  :bind (([remap query-replace] . anzu-query-replace)
         ([remap query-replace-regexp] . anzu-query-replace-regexp)
         :map isearch-mode-map
         ([remap isearch-query-replace] . anzu-isearch-query-replace)
         ([remap isearch-query-replace-regexp] . anzu-isearch-query-replace-regexp))
  :hook (elpaca-after-init . global-anzu-mode))

(use-package evil-anzu :after evil)
#+end_src

** Ediff
#+begin_src emacs-lisp
(use-package ediff
  :defer t
  :ensure nil
  :hook(;; show org ediffs unfolded
        (ediff-prepare-buffer . outline-show-all)
        ;; restore window layout when done
        (ediff-quit . winner-undo))
  :config
  (setq ediff-window-setup-function 'ediff-setup-windows-plain
        ediff-split-window-function 'split-window-horizontally
        ediff-merge-split-window-function 'split-window-horizontally))
#+end_src

** Automatic parenthesis pairing
#+begin_src emacs-lisp
(use-package elec-pair
  :ensure nil
  :hook (elpaca-after-init . electric-pair-mode)
  :init (setq electric-pair-inhibit-predicate 'electric-pair-conservative-inhibit))
#+end_src

** Edit multiple regions simultaneously
#+begin_src emacs-lisp
(use-package iedit :defer t)
#+end_src

** Subword: Handling capitalized subwords in a nomenclature
#+begin_src emacs-lisp
(use-package subword
  :ensure nil
  :hook ((prog-mode . subword-mode)
         (minibuffer-setup . subword-mode)))
#+end_src

** Misc
#+begin_src emacs-lisp
(use-package sudo-edit :defer t)

;; Hanlde minified code
(use-package so-long
  :hook (elpaca-after-init . global-so-long-mode))
#+end_src

* Completion Framework
** Orderless
#+begin_src emacs-lisp
(use-package orderless
  :custom
  (completion-styles '(orderless basic))
  (completion-category-defaults nil)
  (completion-category-overrides '((file (styles basic partial-completion))))
  (orderless-component-separator #'orderless-escapable-split-on-space))
#+end_src

** Vertico
VERTical Interactive COmpletion
#+begin_src emacs-lisp
(use-package vertico
  :custom
  (vertico-count 10)
  (vertico-resize nil)
  (vertico-cycle t)
  :bind (:map vertico-map
         ("RET" . vertico-directory-enter)
         ("DEL" . vertico-directory-delete-char)
         ("M-DEL" . vertico-directory-delete-word))
  :hook ((elpaca-after-init . vertico-mode)
         (rfn-eshadow-update-overlay . vertico-directory-tidy)))
#+end_src

** Marginalia
Enrich existing commands with completion annotations
#+begin_src emacs-lisp
(use-package marginalia
  :hook (elpaca-after-init . marginalia-mode)
  :config
  (setq marginalia-max-relative-age 0 ; Always show absolute time
        marginalia-align 'right))
#+end_src

** Nerd Icons Completion
Add icons to completion candidates
#+begin_src emacs-lisp
(use-package nerd-icons-completion
  :after marginalia
  :hook (marginalia-mode . nerd-icons-completion-marginalia-setup)
  :config
  (nerd-icons-completion-mode))
#+end_src

** Consult
Consulting completing-read
#+begin_src emacs-lisp
(use-package consult
  :defines (xref-show-xrefs-function xref-show-definitions-function)
  :defines shr-color-html-colors-alist
  :autoload (consult-register-format consult-register-window consult-xref)
  :autoload (consult--read consult--customize-put)
  :commands (consult-narrow-help)
  :functions (list-colors-duplicates consult-colors--web-list)
  :bind (([remap switch-to-buffer] . consult-buffer)
	 ([remap switch-to-buffer-other-window] . consult-buffer-other-window)
	 ([remap switch-to-buffer-other-frame] . consult-buffer-other-frame)
	 ([remap bookmark-jump] . consult-bookmark)
	 ([remap evil-show-marks] . consult-mark)
	 ([remap evil-show-jumps] . consult-jump-list)
	 ([remap goto-line] . consult-goto-line)
	 ([remap imenu] . consult-imenu)
	 ([remap load-theme] . consult-theme)
	 ([remap recentf-open-files] . consult-recent-file)
	 ([remap yank-pop] . consult-yank-pop)
         ([remap Info-search]        . consult-info)
         ([remap isearch-forward]    . consult-line))
  ;; Enable automatic preview at point in the *Completions* buffer. This is
  ;; relevant when you use the default completion UI.
  :hook (completion-list-mode . consult-preview-at-point-mode)
  :init
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)
  (advice-add #'register-preview :override #'consult-register-window)

  (with-eval-after-load 'xref
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref))

  (defvar consult-colors-history nil
    "History for `consult-colors-emacs' and `consult-colors-web'.")

  (autoload 'list-colors-duplicates "facemenu")
  (autoload 'consult--read "consult")

  (defun consult-colors-emacs (color)
    "Show a list of all supported colors for a particular frame.

You can insert the name (default), or insert or kill the hexadecimal or RGB
value of the selected COLOR."
    (interactive
     (list (consult--read (list-colors-duplicates (defined-colors))
                          :prompt "Emacs color: "
                          :require-match t
                          :category 'color
                          :history '(:input consult-colors-history))))
    (insert color))

  (defun consult-colors--web-list nil
    "Return list of CSS colors for `counsult-colors-web'."
    (require 'shr-color)
    (sort (mapcar #'downcase (mapcar #'car shr-color-html-colors-alist)) #'string-lessp))

  (defun consult-colors-web (color)
    "Show a list of all CSS colors.\

You can insert the name (default), or insert or kill the hexadecimal or RGB
value of the selected COLOR."
    (interactive
     (list (consult--read (consult-colors--web-list)
                          :prompt "Color: "
                          :require-match t
                          :category 'color
                          :history '(:input consult-colors-history))))
    (insert color))
  :config
  (setq consult-preview-key nil)

  (defvar consult--source-file-visiting-buffer
    `(:name "Main"
      :narrow ?f
      :category buffer
      :face consult-buffer
      :history buffer-name-history
      :state ,#'consult--buffer-state
      :default t
      :items ,(lambda ()
                (consult--buffer-query
                 :sort 'visibility
                 :predicate (lambda (buf)
                              ;; Only show buffers that are visiting files
                              (buffer-file-name buf))
                 :as #'buffer-name)))
    "Buffer source for file-visiting buffers only.")

  (setq consult-buffer-sources
        '(consult--source-file-visiting-buffer))

  ;; For some commands and buffer sources it is useful to configure the
  ;; :preview-key on a per-command basis using the `consult-customize' macro.
  (consult-customize
   consult-line consult-line-multi :preview-key 'any
   consult-buffer consult-recent-file consult-theme :preview-key '(:debounce 1.0 any)
   consult-goto-line :preview-key '(:debounce 0.5 any)
   consult-ripgrep consult-git-grep consult-grep
   :initial (selected-region-or-symbol-at-point)
   :preview-key '(:debounce 0.5 any))

  ;; Optionally configure the narrowing key.
  ;; Both < and C-+ work reasonably well.
  (setq consult-narrow-key "<") ;; "C-+"

  ;; Optionally make narrowing help available in the minibuffer.
  ;; You may want to use `embark-prefix-help-command' or which-key instead.
  (define-key consult-narrow-map (vconcat consult-narrow-key "?") #'consult-narrow-help))

(use-package consult-dir :defer t)
#+end_src

** Embark
#+begin_src emacs-lisp
(use-package embark
  :commands embark-prefix-help-command
  :init
  (setq prefix-help-command #'embark-prefix-help-command)
  :config
  ;; Manual preview for non-Consult commands using Embark
  (defun my-embark-preview ()
    "Previews candidate in vertico buffer, unless it's a consult command."
    (interactive)
    (unless (bound-and-true-p consult--preview-function)
      (save-selected-window
        (let ((embark-quit-after-action nil))
          (embark-dwim)))))

  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none))))

  (with-no-warnings
    (with-eval-after-load 'which-key
      (defun embark-which-key-indicator ()
        "An embark indicator that displays keymaps using which-key.
The which-key help message will show the type and value of the
current target followed by an ellipsis if there are further
targets."
        (lambda (&optional keymap targets prefix)
          (if (null keymap)
              (which-key--hide-popup-ignore-command)
            (which-key--show-keymap
             (if (eq (plist-get (car targets) :type) 'embark-become)
                 "Become"
               (format "Act on %s '%s'%s"
                       (plist-get (car targets) :type)
                       (embark--truncate-target (plist-get (car targets) :target))
                       (if (cdr targets) "…" "")))
             (if prefix
                 (pcase (lookup-key keymap prefix 'accept-default)
                   ((and (pred keymapp) km) km)
                   (_ (key-binding prefix 'accept-default)))
               keymap)
             nil nil t (lambda (binding)
                         (not (string-suffix-p "-argument" (cdr binding))))))))

      (setq embark-indicators
            '(embark-which-key-indicator
              embark-highlight-indicator
              embark-isearch-highlight-indicator))

      (defun embark-hide-which-key-indicator (fn &rest args)
        "Hide the which-key indicator immediately when using the completing-read prompter."
        (which-key--hide-popup-ignore-command)
        (let ((embark-indicators
               (remq #'embark-which-key-indicator embark-indicators)))
          (apply fn args)))

      (advice-add #'embark-completing-read-prompter
                  :around #'embark-hide-which-key-indicator))))
#+end_src

** Embark Consult
#+begin_src emacs-lisp
(use-package embark-consult
  :defer t
  :after (embark consult)
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** Corfu
#+begin_src emacs-lisp
(use-package corfu
  :autoload (corfu-quit consult-completion-in-region)
  :functions (persistent-scratch-save corfu-move-to-minibuffer)
  :custom
  (corfu-cycle t)
  (corfu-auto t)
  (corfu-auto-prefix 2)
  (corfu-count 12)
  (corfu-preview-current nil)
  (corfu-on-exact-match nil)
  (corfu-auto-delay 0.2)
  (corfu-popupinfo-delay '(0.1 . 0.1))
  (global-corfu-modes '((not erc-mode
                             circe-mode
                             help-mode
                             gud-mode
                             vterm-mode)
                        t))
  :custom-face
  (corfu-border ((t (:inherit region :background unspecified))))
  :bind
  (:map corfu-map
        ("TAB" . corfu-next)
        ([tab] . corfu-next)
        ("S-TAB" . corfu-previous)
        ([backtab] . corfu-previous)
        ("M-h" . corfu-info-documentation))
  :hook ((elpaca-after-init . global-corfu-mode)
         (global-corfu-mode . corfu-history-mode))
  :config
  ;;Quit completion before saving
  (add-hook 'before-save-hook #'corfu-quit)
  (advice-add #'persistent-scratch-save :before #'corfu-quit)

  ;; Move completions to minibuffer
  (defun corfu-move-to-minibuffer ()
    (interactive)
    (pcase completion-in-region--data
      (`(,beg ,end ,table ,pred ,extras)
       (let ((completion-extra-properties extras)
             completion-cycle-threshold completion-cycling)
         (consult-completion-in-region beg end table pred)))))
  (keymap-set corfu-map "M-m" #'corfu-move-to-minibuffer)
  (add-to-list 'corfu-continue-commands #'corfu-move-to-minibuffer))
#+end_src

** Basic Completion
#+begin_src emacs-lisp
(use-package emacs
  :ensure nil
  :custom
  (tab-always-indent 'complete)
  (text-mode-ispell-word-completion nil)
  (read-extended-command-predicate #'command-completion-default-include-p))
#+end_src

** Nerd Icons Corfu
#+begin_src emacs-lisp
(use-package nerd-icons-corfu
  :autoload nerd-icons-corfu-formatter
  :after corfu
  :init (add-to-list 'corfu-margin-formatters #'nerd-icons-corfu-formatter))
#+end_src

** Cape
#+begin_src emacs-lisp
(use-package cape
  :commands (cape-file cape-elisp-block cape-keyword 
             cape-wrap-noninterruptible cape-wrap-nonexclusive 
             cape-wrap-buster cape-wrap-silent cape-wrap-purify)
  :init
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-elisp-block)
  (add-to-list 'completion-at-point-functions #'cape-keyword)

  ;; Make these capfs composable.
  (advice-add 'lsp-completion-at-point :around #'cape-wrap-noninterruptible)
  (advice-add 'lsp-completion-at-point :around #'cape-wrap-nonexclusive)
  (advice-add 'comint-completion-at-point :around #'cape-wrap-nonexclusive)
  (advice-add 'eglot-completion-at-point :around #'cape-wrap-buster)
  (advice-add 'eglot-completion-at-point :around #'cape-wrap-nonexclusive)
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-nonexclusive))
#+end_src

* Snippet Engine
#+begin_src emacs-lisp
(defvar my/snippets-directory (expand-file-name "snippets" user-emacs-directory)
  "Directory for personal yasnippet snippets.")

;; Create the custom snippets directory if it doesn't exist.
(unless (file-directory-p my/snippets-directory)
  (make-directory my/snippets-directory t))

(use-package yasnippet-snippets :after yasnippet)

(use-package yasnippet
  :hook ((prog-mode text-mode org-mode) . yas-minor-mode)
  :custom
  (yas-prompt-functions '(yas-completing-prompt))
  :config
  (add-to-list 'yas-snippet-dirs my/snippets-directory)

  ;; --- Robust, Save-Based Automatic Snippet Reloading ---
  (defun ar/yas-reload-snippets-on-save ()
    "Reload all snippets if a snippet file is being saved."
    (when (string-prefix-p my/snippets-directory (buffer-file-name))
      (yas-reload-all)
      (message "Yasnippet collection reloaded.")))

  (add-hook 'after-save-hook #'ar/yas-reload-snippets-on-save))

(use-package consult-yasnippet
  :defer t
  :after (consult yasnippet)
  :config
  (consult-customize consult-yasnippet :preview-key 'any))

(use-package yasnippet-capf
  :after cape
  :config
  (add-to-list 'completion-at-point-functions #'yasnippet-capf))
#+end_src

* Dired/Dirvish
** Core Dired Configuration
#+begin_src emacs-lisp
(use-package dired
  :defer t
  :ensure nil
  :commands (dired dired-jump)
  :custom
  ;; Use GNU ls for better sorting (install coreutils on macOS: brew install coreutils)
  (insert-directory-program (if (executable-find "gls") "gls" "ls"))
  
  ;; Listing switches: human-readable sizes, almost-all files, group directories first
  (dired-listing-switches "-l --almost-all --human-readable --time-style=long-iso --group-directories-first --no-group")
  
  ;; Guess target directory for operations (very useful with split windows)
  (dired-dwim-target t)
  
  ;; Copy/move recursively without asking
  (dired-recursive-copies 'always)
  (dired-recursive-deletes 'top)
  
  ;; Use trash instead of permanent deletion
  (delete-by-moving-to-trash t)
  
  ;; Enable drag-and-drop on Emacs 29+
  (dired-mouse-drag-files t)
  (mouse-drag-and-drop-region-cross-program t)
  
  ;; Kill buffers of deleted files/directories
  (dired-kill-when-opening-new-dired-buffer t)
  
  ;; Hide details by default
  (dired-hide-details-hide-symlink-targets nil)
  
  ;; Better file name completion in minibuffer
  (dired-isearch-filenames 'dwim)
  
  :hook
  (dired-mode . dired-hide-details-mode)
  (dired-mode . hl-line-mode))

;; Dired Extra: additional features
(use-package dired-x
  :ensure nil
  :hook (dired-mode . dired-omit-mode)
  :config
  (require 'dired-x)

  (setq dired-omit-verbose nil
        dired-omit-files
        (concat "^\\.?#\\|^\\.$\\|^\\.\\.$"
                "\\|^\\.DS_Store\\'"
                "\\|^flycheck_.*"
                "\\|^\\.project\\(?:ile\\)?\\'"
                "\\|^\\.\\(?:svn\\|git\\)\\'"
                "\\|^\\.ccls-cache\\'"
                "\\|\\(?:\\.js\\)?\\.meta\\'"
                "\\|\\.\\(?:elc\\|o\\|pyo\\|swp\\|class\\)\\'"))

  ;; Disable the prompt about whether I want to kill the Dired buffer for a
  ;; deleted directory. Of course I do!
  (setq dired-clean-confirm-killing-deleted-buffers nil))

;; Colorful dired with better syntax highlighting
(use-package diredfl
  :hook (dired-mode . diredfl-mode))

;; Writable dired buffers - edit filenames like text
(use-package wdired
  :ensure nil
  :after dired
  :custom
  (wdired-allow-to-change-permissions t)
  (wdired-create-parent-directories t))
#+end_src

** Dirvish - Ranger-style File Manager
#+begin_src emacs-lisp
(use-package dirvish
  :after dired
  :commands (dirvish dirvish-side dirvish-dwim)
  :custom
  ;; Cache directory
  (dirvish-cache-dir (expand-file-name "dirvish/" user-emacs-directory))
  
  ;; Attributes to show (file-size, icons, git status, etc.)
  (dirvish-attributes
   '(nerd-icons file-size collapse subtree-state vc-state git-msg))
  
  ;; RANGER-LIKE LAYOUT: Miller columns with parent, current, and preview
  ;; Format: (PARENT-DEPTH PARENT-WIDTH PREVIEW-WIDTH)
  ;; (1 0.11 0.55) = 1 parent column : 3 current : 5 preview (1:3:5 ratio)
  (dirvish-default-layout '(1 0.11 0.55))
  
  ;; Layout recipes for different use cases
  (dirvish-layout-recipes
   '((0 0   0.4)   ; No parent, smaller preview
     (1 0.1 0.5)   ; Balanced layout
     (1 0.15 0.6))) ; More preview space
  
  ;; Quick access bookmarks (like ranger's bookmarks)
  (dirvish-quick-access-entries
   `(("h" "~/" "Home")
     ("e" ,user-emacs-directory "Emacs")
     ("d" "~/Downloads/" "Downloads")
     ("D" "~/Documents/" "Documents")
     ("p" "~/projects/" "Projects")
     ("o" ,my/org-directory "Org")
     ("c" "~/.config/" "Config")
     ("t" "~/.local/share/Trash/files/" "Trash")))
  
  ;; Mode line format (bottom bar)
  (dirvish-mode-line-format
   '(:left (sort file-time " " file-size symlink)
     :right (omit yank index)))
  
  ;; Header line format (top bar)
  (dirvish-header-line-format
   '(:left (path) :right (free-space)))
  
  ;; Preview dispatchers (file types to preview)
  (dirvish-preview-dispatchers
   '(image gif video audio epub archive pdf))
  
  ;; Peek mode settings
  (dirvish-use-header-line t)
  (dirvish-use-mode-line t)
  
  ;; Session management - set to nil for ranger-like behavior
  ;; (creates fresh sessions, kills all buffers on quit)
  (dirvish-reuse-session nil)
  
  ;; Hide cursor in non-selected windows
  (dirvish-hide-cursor t)
  
  ;; Hide details in specific contexts
  (dirvish-hide-details '(dirvish dirvish-side))
  
  ;; Emerge settings for full-frame mode
  (dirvish-emerge-groups
   '(("Recent files" (predicate . recent-files-2h))
     ("Documents" (extensions "pdf" "tex" "bib" "epub"))
     ("Video" (extensions "mp4" "mkv" "webm"))
     ("Pictures" (extensions "jpg" "png" "svg" "gif"))
     ("Audio" (extensions "mp3" "flac" "wav" "ape"))
     ("Archives" (extensions "gz" "rar" "zip"))))
  
  :config
  ;; Enable dirvish globally (replaces dired)
  (dirvish-override-dired-mode)
  
  ;; Enable automatic preview in minibuffer
  (dirvish-peek-mode)
  
  ;; Side window configuration (for dirvish-side)
  (setq dirvish-side-width 35)
  (setq dirvish-side-follow-buffer-file t)
  (setq dirvish-side-display-alist
        '((side . left)
          (slot . -1)
          (window-width . 0.2)))
  
  :bind
  ;; Main dirvish bindings
  (:map dirvish-mode-map
   ;; Help and navigation
   ("?"   . dirvish-dispatch)         ; Main help menu (transient)
   ("q"   . dirvish-quit)             ; Quit dirvish
   
   ;; Ranger-style layout controls
   ("F"   . dirvish-layout-toggle)    ; Toggle fullscreen layout
   ("M-t" . dirvish-layout-switch)    ; Cycle through layouts
   
   ;; File operations
   ("TAB" . dirvish-subtree-toggle)   ; Expand/collapse directories
   ("f"   . dirvish-file-info-menu)   ; File info menu
   ("y"   . dirvish-yank-menu)        ; Yank/copy menu
   ("s"   . dirvish-quicksort)        ; Quick sort menu
   ("a"   . dirvish-quick-access)     ; Quick access bookmarks
   
   ;; History and navigation
   ("SPC" . dirvish-show-history)     ; Show directory history
   ("M-f" . dirvish-history-go-forward)
   ("M-b" . dirvish-history-go-backward)
   ("M-n" . dirvish-history-go-forward)
   ("M-p" . dirvish-history-go-backward)
   
   ;; Advanced features
   ("M-s" . dirvish-setup-menu)       ; Setup menu
   ("M-e" . dirvish-emerge-menu)      ; Emerge menu (grouping)
   ("M-j" . dirvish-fd-jump)          ; Fast directory jump with fd
   ("M-l" . dirvish-ls-switches-menu) ; Listing switches menu
   ("M-m" . dirvish-mark-menu)        ; Mark menu
   
   ;; Version control
   ("v"   . dirvish-vc-menu)))        ; Git/VC operations
#+end_src

** Evil Integration for Dirvish
#+begin_src emacs-lisp
;; Enhanced Evil bindings for ranger-like navigation
(with-eval-after-load 'dirvish
  (when (featurep 'evil)
    (evil-define-key 'normal dirvish-mode-map
      ;; Vim-style navigation (ranger-like)
      (kbd "h") 'dired-up-directory          ; Go to parent directory
      (kbd "l") 'dired-find-file             ; Open file/enter directory
      (kbd "j") 'dired-next-line             ; Move down
      (kbd "k") 'dired-previous-line         ; Move up
      
      ;; Ranger-style shortcuts
      (kbd "gg") 'evil-goto-first-line       ; Go to top
      (kbd "G")  'evil-goto-line             ; Go to bottom
      (kbd "~")  'dirvish-quick-access       ; Quick bookmarks
      (kbd "`")  'dirvish-show-history       ; History
      (kbd "zh") 'dired-omit-mode            ; Toggle hidden files
      
      ;; Subtree operations
      (kbd "TAB")   'dirvish-subtree-toggle  ; Expand/collapse
      (kbd "S-TAB") 'dirvish-subtree-up      ; Go up in subtree
      
      ;; File operations
      (kbd "i") 'wdired-change-to-wdired-mode ; Edit mode
      (kbd "o") 'dired-find-file-other-window ; Open in other window
      (kbd "v") 'dired-view-file             ; View file (read-only)
      (kbd "I") 'dired-info                  ; File info
      
      ;; Marking
      (kbd "m") 'dired-mark                  ; Mark file
      (kbd "u") 'dired-unmark                ; Unmark file
      (kbd "U") 'dired-unmark-all-marks      ; Unmark all
      (kbd "V") 'dired-mark-files-regexp     ; Visual mark by regex
      (kbd "*") 'dired-mark-executables      ; Mark executables
      
      ;; Operations
      (kbd "c") 'dired-do-copy               ; Copy
      (kbd "C") 'dired-create-directory      ; Create directory
      (kbd "d") 'dired-do-delete             ; Delete
      (kbd "D") 'dired-do-delete             ; Delete (synonym)
      (kbd "r") 'dired-do-rename             ; Rename
      (kbd "R") 'dired-do-rename             ; Rename (synonym)
      (kbd "Y") 'dirvish-yank-menu           ; Yank menu
      
      ;; Sorting and filtering
      (kbd "s") 'dirvish-quicksort           ; Sort menu
      (kbd "O") 'dired-do-chown              ; Change owner
      (kbd "M") 'dired-do-chmod              ; Change mode
      
      ;; Special operations
      (kbd "!") 'dired-do-shell-command      ; Shell command
      (kbd "&") 'dired-do-async-shell-command ; Async shell command
      
      ;; Layout controls
      (kbd "F") 'dirvish-layout-toggle       ; Toggle fullscreen
      (kbd "+") 'dired-create-directory      ; Create directory
      
      ;; Help and quit
      (kbd "?") 'dirvish-dispatch            ; Help menu
      (kbd "q") 'dirvish-quit)))             ; Quit
#+end_src

** Additional Dirvish Extensions
#+begin_src emacs-lisp
;; Load additional dirvish extensions if needed
(with-eval-after-load 'dirvish
  ;; Ensure extensions are loaded
  (require 'dirvish-side nil t)
  (require 'dirvish-fd nil t)
  (require 'dirvish-narrow nil t)
  (require 'dirvish-emerge nil t)
  (require 'dirvish-subtree nil t)
  (require 'dirvish-yank nil t)
  
  ;; Optional: Customize preview for specific file types
  
  ;; Use eza for directory previews (if available)
  (when (executable-find "eza")
    (setq dirvish-preview-dired-command
          '("eza" "-al" "--color=always" "--icons" "--group-directories-first")))
  
  ;; Image preview settings
  (setq dirvish-media-auto-cache-threshold '(500 . 8192)) ; Cache images 500KB-8MB
  
  ;; Video thumbnail settings
  (when (executable-find "ffmpegthumbnailer")
    (setq dirvish-video-thumbnail-options
          '(:create-if-absent t
            :size 512))))
#+end_src

* iBuffer
#+begin_src emacs-lisp
(use-package ibuffer
  :defer t
  :ensure nil
  :init (setq ibuffer-filter-group-name-face '(:inherit (font-lock-string-face bold))))

;; Display icons for buffers
(use-package nerd-icons-ibuffer
  :defer t
  :hook (ibuffer-mode . nerd-icons-ibuffer-mode)
  :init
  (setq nerd-icons-ibuffer-icon t)
  (setq nerd-icons-ibuffer-color-icon t)
  (setq nerd-icons-ibuffer-icon-size 1.0)
  (setq nerd-icons-ibuffer-human-readable-size t))

;; Group ibuffer's list by project
(use-package ibuffer-project
  :defer t
  :autoload (ibuffer-project-generate-filter-groups ibuffer-do-sort-by-project-file-relative)
  :functions icons-displayable-p
  :hook (ibuffer . (lambda ()
                     "Group ibuffer's list by project."
                     (setq ibuffer-filter-groups (ibuffer-project-generate-filter-groups))
                     (unless (eq ibuffer-sorting-mode 'project-file-relative)
                       (ibuffer-do-sort-by-project-file-relative))))
  :init (setq ibuffer-project-use-cache t)
  :config
  (with-no-warnings
    (defun my-ibuffer-project-group-name (root type)
      "Return group name for project ROOT and TYPE."
      (if (and (stringp type) (> (length type) 0))
          (format "%s %s" type root)
        (format "%s" root)))
    (if (icons-displayable-p)
        (progn
          (advice-add #'ibuffer-project-group-name :override #'my-ibuffer-project-group-name)
          (setq ibuffer-project-root-functions
                `((ibuffer-project-project-root . ,(nerd-icons-octicon "nf-oct-repo" :height 1.2 :face ibuffer-filter-group-name-face))
                  (file-remote-p . ,(nerd-icons-codicon "nf-cod-radio_tower" :height 1.2 :face ibuffer-filter-group-name-face)))))
      (progn
        (advice-remove #'ibuffer-project-group-name #'my-ibuffer-project-group-name)
        (setq ibuffer-project-root-functions
              '((ibuffer-project-project-root . "Project")
                (file-remote-p . "Remote")))))))
#+end_src

* Kill Ring
#+begin_src emacs-lisp
;; Increase kill ring size
(setq kill-ring-max 200)

;; Save clipboard contents into kill-ring before replacing them
;; This is crucial for Evil users so that 'd', 'x', or 'c' operations
;; don't overwrite text copied from external applications.
(setq save-interprogram-paste-before-kill t)

;; Interactively insert and edit items from kill-ring
;; Required for the 'SPC k' keybinding defined in General Keybindings
(use-package browse-kill-ring
  :defer t
  :init
  (setq browse-kill-ring-separator "────────────────"
        browse-kill-ring-separator-face 'shadow))
#+end_src

* Tabspaces
#+begin_src emacs-lisp
(use-package tabspaces
  :hook (elpaca-after-init . tabspaces-mode)
  :custom
  (tab-bar-show nil) ;; We use the modeline/consult to visualize tabs
  
  ;; Filter buffers by default so Project A only sees Project A's buffers
  (tabspaces-use-filtered-buffers-as-default t)
  (tabspaces-default-tab "Default")
  (tabspaces-remove-to-default t)
  (tabspaces-include-buffers '("*scratch*" "*Messages*"))
  
  ;; CRITICAL FIX: Set to nil to ensure terminals are ISOLATED to their workspace.
  ;; If we added *vterm* here, it would be visible in ALL tabs (Global).
  (tabspaces-exclude-buffers nil)

  ;; Session management settings
  (tabspaces-session t)
  (tabspaces-session-auto-restore nil) ; We use a custom robust timer for this

  :config
  ;; --- Consult Integration ---
  ;; This safety check is REQUIRED because consult might not be loaded yet.
  (with-eval-after-load 'consult
    ;; Hide the full buffer list by default (so we rely on the workspace source)
    (consult-customize consult--source-buffer :hidden t :default nil)

    ;; Define a source that lists ONLY buffers in the current tabspace
    (defvar consult--source-workspace
      (list :name     "Workspace Buffer"
            :narrow   ?w
            :history  'buffer-name-history
            :category 'buffer
            :state    #'consult--buffer-state
            :default  t
            :items    (lambda () (consult--buffer-query
                               :predicate #'tabspaces--local-buffer-p
                               :sort 'visibility
                               :as #'buffer-name)))
      "Set workspace buffer list for consult-buffer.")
    
    ;; Add the workspace source to consult
    (add-to-list 'consult-buffer-sources 'consult--source-workspace))

  ;; --- Crash Prevention & Cleanup ---

  (defun my-tabspaces-delete-childframe (&rest _)
    "Delete all child frames (posframes) before saving session to prevent read errors."
    (when (and (fboundp 'posframe-delete-all)
               (featurep 'posframe))
      (ignore-errors (posframe-delete-all))))

  (defun my-tabspaces-clean-markers (&rest _)
    "Clean up dead markers in buffer-local variables to prevent invalid-read-syntax errors."
    (dolist (buf (buffer-list))
      (with-current-buffer buf
        (dolist (var (buffer-local-variables))
          (when (and (consp var) (markerp (cdr var)))
            (let ((marker (cdr var)))
              (unless (and (marker-buffer marker)
                           (buffer-live-p (marker-buffer marker)))
                (set (car var) nil))))))))

  (defun my-tabspaces-bury-window (&rest _)
    "Bury *Messages* buffer after restoring session to keep the view clean."
    (run-with-idle-timer 0.5 nil
      (lambda ()
        (ignore-errors
          (when-let ((msg-buf (get-buffer "*Messages*")))
            (quit-windows-on msg-buf))))))

  ;; --- Session Management Wrappers ---

  (defun my-tabspaces-save-wrapper (orig-fun &rest args)
    "Advice wrapper to clean environment before saving tabspaces."
    (my-tabspaces-delete-childframe)
    (my-tabspaces-clean-markers)
    (apply orig-fun args))

  (defun my-tabspaces-safe-restore ()
    "Safely restore tabspaces session with error handling."
    (interactive)
    ;; Don't restore if Emacs was launched with a specific file argument
    (unless command-line-args-left
      (condition-case err
          (progn
            (tabspaces-restore-session)
            (message "Tabspaces session restored."))
        (error
         (message "Tabspaces restore failed: %s" (error-message-string err))
         ;; Fallback: Create a default tab if restore fails
         (ignore-errors
           (tab-bar-new-tab)
           (tab-bar-rename-tab "Default"))
         nil))))

  (defun my-tabspaces-safe-save ()
    "Safely save tabspaces session with error handling (for timer)."
    (interactive)
    (condition-case err
        (progn
          (my-tabspaces-delete-childframe)
          (my-tabspaces-clean-markers)
          (tabspaces-save-session)
          (message "Tabspaces session saved."))
      (error
       (message "Tabspaces save failed: %s" (error-message-string err)))))

  ;; Apply Advice
  (advice-add 'tabspaces-save-session :around #'my-tabspaces-save-wrapper)
  (advice-add 'tabspaces-restore-session :after #'my-tabspaces-bury-window)

  ;; Auto-save session every 5 minutes when idle
  (run-with-idle-timer 300 t #'my-tabspaces-safe-save)

  ;; Attempt restore 2 seconds after startup
  (add-hook 'elpaca-after-init-hook
            (lambda ()
              (run-with-idle-timer 2 nil #'my-tabspaces-safe-restore))))
#+end_src

* Window
** Winner
#+begin_src emacs-lisp
(use-package winner
  :ensure nil
  :commands (winner-undo winner-redo)
  :hook (elpaca-after-init . winner-mode)
  :init (setq winner-boring-buffers '("*Completions*"
                                      "*Compile-Log*"
                                      "*inferior-lisp*"
                                      "*Fuzzy Completions*"
                                      "*Apropos*"
                                      "*Help*"
                                      "*cvs*"
                                      "*Buffer List*"
                                      "*Ibuffer*"
                                      "*esh command on file*")))
#+end_src

** Ace window
#+begin_src emacs-lisp
(use-package ace-window
  :defer t
  ;; Ensure this function is autoloaded so SPC w t works immediately
  :commands (toggle-window-split) 
  :pretty-hydra
  ((:title (pretty-hydra-title "Window Management" 'faicon "nf-fa-th")
    :foreign-keys warn :quit-key ("q" "C-g"))
   ("Actions"
    (("TAB" other-window "switch")
     ("x" ace-delete-window "delete")
     ("X" ace-delete-other-windows "delete other" :exit t)
     ("s" ace-swap-window "swap")
     ("a" ace-select-window "select" :exit t)
     ("m" toggle-frame-maximized "maximize" :exit t)
     ("u" toggle-frame-fullscreen "fullscreen" :exit t))
    "Resize"
    (("h" shrink-window-horizontally "←")
     ("j" enlarge-window "↓")
     ("k" shrink-window "↑")
     ("l" enlarge-window-horizontally "→")
     ("n" balance-windows "balance"))
    "Split"
    (("r" split-window-right "horizontally")
     ("R" split-window-horizontally-instead "horizontally instead")
     ("v" split-window-below "vertically")
     ("V" split-window-vertically-instead "vertically instead")
     ("t" toggle-window-split "toggle"))
    "Zoom"
    (("+" text-scale-increase "in")
     ("=" text-scale-increase "in")
     ("-" text-scale-decrease "out")
     ("0" (text-scale-increase 0) "reset"))
    "Misc"
    (("o" set-frame-font "frame font")
     ("f" make-frame-command "new frame")
     ("d" delete-frame "delete frame")
     ("<left>" winner-undo "winner undo")
     ("<right>" winner-redo "winner redo"))))
  :custom-face
  (aw-leading-char-face ((t (:inherit font-lock-keyword-face :foreground unspecified :bold t :height 3.0))))
  (aw-minibuffer-leading-char-face ((t (:inherit font-lock-keyword-face :bold t :height 1.0))))
  (aw-mode-line-face ((t (:inherit mode-line-emphasis :bold t))))
  :bind (([remap other-window] . ace-window)
         ("C-c w" . ace-window-hydra/body)
         ("C-x |" . split-window-horizontally-instead)
         ("C-x _" . split-window-vertically-instead))
  :hook (emacs-startup . ace-window-display-mode)
  :config
  (defun toggle-window-split ()
    (interactive)
    (if (= (count-windows) 2)
        (let* ((this-win-buffer (window-buffer))
               (next-win-buffer (window-buffer (next-window)))
               (this-win-edges (window-edges (selected-window)))
               (next-win-edges (window-edges (next-window)))
               (this-win-2nd (not (and (<= (car this-win-edges)
                                           (car next-win-edges))
                                       (<= (cadr this-win-edges)
                                           (cadr next-win-edges)))))
               (splitter
                (if (= (car this-win-edges)
                       (car (window-edges (next-window))))
                    'split-window-horizontally
                  'split-window-vertically)))
          (delete-other-windows)
          (let ((first-win (selected-window)))
            (funcall splitter)
            (if this-win-2nd (other-window 1))
            (set-window-buffer (selected-window) this-win-buffer)
            (set-window-buffer (next-window) next-win-buffer)
            (select-window first-win)
            (if this-win-2nd (other-window 1))))
      (user-error "`toggle-window-split' only supports two windows")))

  ;; Bind hydra to dispatch list
  (add-to-list 'aw-dispatch-alist '(?w ace-window-hydra/body) t)

  ;; Select window via `M-1'...`M-9'
  (defun aw--select-window (number)
    "Select the specified window."
    (when (numberp number)
      (let ((found nil))
        (dolist (win (aw-window-list))
          (when (and (window-live-p win)
                     (eq number
                         (string-to-number
                          (window-parameter win 'ace-window-path))))
            (setq found t)
            (aw-switch-to-window win)))
        (unless found
          (message "No specified window: %d" number)))))
  (dotimes (n 9)
    (bind-key (format "M-%d" (1+ n))
              (lambda ()
                (interactive)
                (aw--select-window (1+ n))))))
#+end_src

** Popper
#+begin_src emacs-lisp
(use-package popper
  :custom
  (popper-group-function #'popper-group-by-directory)
  (popper-echo-dispatch-actions t)
  :hook (elpaca-after-init . popper-echo-mode)
  :init
  (setq popper-mode-line ""
        popper-reference-buffers
        '("\\*Messages\\*$"
          "\\*Warnings\\*$"
          "Output\\*$"
          "\\*Pp Eval Output\\*$"
          "\\*Pp Macroexpand Output\\*$"
          "^\\*eldoc.*\\*$"
          "\\*Compile-Log\\*$"
          "\\*compilation\\*$"
          "\\*Completions\\*$"
          "\\*Async Shell Command\\*$"
          "\\*Shell Command Output\\*$"
          "\\*Apropos\\*$"
          "\\*Backtrace\\*$"
          "\\*Calendar\\*$"
          "\\*Calculator\\*$"
          "\\*Calc Trail\\*$"
          "\\*Fd\\*$"
          "\\*Find\\*$"
          "\\*Finder\\*$"
          "\\*Kill Ring\\*$"
          "\\*Occur\\*$"
          "\\*xref\\*$"
          "\\*Embark \\(Collect\\|Live\\|Export\\):.*\\*$"
          "\\*Embark Actions\\*$"
          "\\*Org Select\\*$"
          "\\*Org Agenda.*\\*$"
          "\\*Agenda Commands\\*$"
          "\\*Capture\\*$"
          "^CAPTURE-.*\\.org*"
          "\\*Local variables\\*$"
          "\\*Org-Babel Error Output\\*$"
          "\\*Org Export Dispatcher\\*$"
          "\\*Org Note\\*$"

          ;; Helpful, Help, Info
          bookmark-bmenu-mode
          comint-mode
          compilation-mode
          help-mode
          helpful-mode
          tabulated-list-mode
          Buffer-menu-mode
          Info-mode
          Custom-mode
          special-mode

          ;; Flycheck/Flymake
          flymake-diagnostics-buffer-mode
          flymake-project-diagnostics-mode
          flycheck-error-list-mode
          flycheck-verify-mode

          ;; Dictionary and translation
          gnus-article-mode
          devdocs-mode
          dictionary-mode
          youdao-dictionary-mode
          osx-dictionary-mode
          fanyi-mode
          "^\\*gt-result\\*$"
          "^\\*gt-log\\*$"
          "^\\*DeepL\\*$"
          "^\\*Google Translate\\*$"

          ;; Search results
          grep-mode
          occur-mode
          rg-mode
          deadgrep-mode
          ag-mode
          pt-mode
          ivy-occur-grep-mode
          ivy-occur-mode

          ;; Process and environment
          "^\\*Process List\\*$"
          process-menu-mode
          list-environment-mode
          cargo-process-mode

          ;; Terminals
          "^\\*.*eat.*\\*.*$"
          "^\\*.*eshell.*\\*.*$"
          "^\\*.*shell.*\\*.*$"
          "^\\*.*terminal.*\\*.*$"
          "^\\*.*vterm[inal]*.*\\*.*$"
          "^\\*.*ansi-term.*\\*.*$"

          ;; Development tools
          "\\*DAP Templates\\*$"
          dap-server-log-mode
          "^\\*dap-ui.*\\*$"
          "\\*ELP Profiling Results\\*$"
          profiler-report-mode
          "\\*package update results\\*$"
          "\\*Package-Lint\\*$"
          "\\*Packages\\*$"
          "\\*Native-compile-Log\\*$"
          "\\*Paradox Report\\*$"
          "^\\*straight-.*\\*$"
          "^\\*elpaca-.*\\*$"

          ;; Documentation
          "\\*[Wo]*Man.*\\*$"
          woman-mode
          Man-mode

          ;; Testing
          "\\*ert\\*$"
          overseer-buffer-mode
          "^\\*Buttercup\\*$"
          "\\*cider-test-report\\*$"

          ;; Debugging
          "\\*gud-debug\\*$"
          "\\*LLDB.*\\*$"
          "\\*breakpoints of.*\\*$"
          "\\*gdb-.*\\*$"

          ;; LSP
          "\\*lsp-help\\*$"
          "\\*lsp session\\*$"
          "\\*lsp-log\\*$"
          "\\*lsp-ui-doc\\*$"
          "\\*lsp-ui-imenu\\*$"
          "\\*LSP Error\\*$"
          "\\*eglot.*\\*$"

          ;; Misc development
          "\\*quickrun\\*$"
          "\\*tldr\\*$"
          "\\*vc-.*\\*$"
          "\\*vc-diff\\*$"
          "\\*vc-change-log\\*$"
          "\\*diff-hl\\*$"
          "^\\*macro expansion\\*$"
          "^\\*Macrostep\\*$"
          "\\*ediff-.*\\*$"
          "\\*grep\\*$"
          "\\*nosetests\\*$"
          "\\*pytest\\*$"

          ;; Language-specific
          "\\*Gofmt Errors\\*$"
          "\\*Go Test\\*$"
          godoc-mode
          "\\*rustfmt\\*$"
          "\\*cargo-.*\\*$"
          rustic-compilation-mode
          rustic-cargo-clippy-mode
          rustic-cargo-outdated-mode
          rustic-cargo-run-mode
          rustic-cargo-test-mode
          "\\*Python\\*$"
          "\\*inferior-python.*\\*$"
          inferior-python-mode
          inf-ruby-mode
          swift-repl-mode
          "\\*prolog\\*$"
          "\\*sly-.*\\*$"
          "\\*slime-.*\\*$"

          ;; Docker
          "\\*docker-.+\\*"
          "\\*docker-compose.*\\*$"
          "\\*dockerfile.*\\*$"

          ;; Miscellaneous
          "\\*Semantic SymRef\\*$"
          "\\*Messages\\*$"
          "\\*Warnings\\*$"
          "\\*Error\\*$"
          "\\*Flycheck.*\\*$"
          "\\*Format All Errors\\*$"
          "\\*Pp Eval Output\\*$"))
  :config
  (with-no-warnings
    (defun my-popper-fit-window-height (win)
      "Adjust the height of popup window WIN to fit the buffer's content."
      (let ((desired-height (floor (/ (frame-height) 3))))
        (fit-window-to-buffer win desired-height desired-height)))
    (setq popper-window-height #'my-popper-fit-window-height)

    (defun popper-close-window-hack (&rest _args)
      "Close popper window via `C-g'."
      (when (and (not (region-active-p))
                 popper-open-popup-alist)
        (let ((window (caar popper-open-popup-alist))
              (buffer (cdar popper-open-popup-alist)))
          (when (and (window-live-p window)
                     (buffer-live-p buffer)
                     (not (with-current-buffer buffer
                            (derived-mode-p 'eshell-mode
                                            'shell-mode
                                            'term-mode
                                            'vterm-mode
                                            'eat-mode))))
            (delete-window window)))))
    (advice-add #'keyboard-quit :before #'popper-close-window-hack)))
#+end_src

* Version Control
** Magit: The Core Git Client
#+begin_src emacs-lisp
(use-package transient :defer t)

(use-package magit
  :defer t
  :init
  (setq magit-auto-revert-mode nil)
  :commands (magit-status magit-blame)
  :custom
  ;; For a focused view, display the Magit status buffer in its own frame.
  (magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1)
  ;; Automatically save file-visiting buffers before staging changes.
  (magit-save-repository-buffers 'dont-confirmk))
#+end_src

** Forge: Git Forge Integration
#+begin_src emacs-lisp
(use-package forge :defer t :after magit)
#+end_src

* Treemacs
#+begin_src emacs-lisp
(use-package treemacs
  :defer t

  :custom-face
  ;; Matches the border color to your theme's posframe border
  (cfrs-border-color ((t (:inherit posframe-border))))
  :custom
  (treemacs-width 30)
  (treemacs-position 'left)
  (treemacs-is-never-other-window t) ;; Prevent 'other-window' from jumping into sidebar
  (treemacs-space-between-root-nodes t)
  (treemacs-silent-refresh t)
  (treemacs-silent-filewatch t)
  (treemacs-file-follow-delay 0.2)
  :config
  (treemacs-follow-mode t)      ;; Highlight file in sidebar when selected in buffer
  (treemacs-filewatch-mode t)   ;; Watch file system for changes
  (treemacs-fringe-indicator-mode 'always)

  ;; Check for python3 and git to determine how to run git integration
  (pcase (cons (not (null (executable-find "git")))
               (not (null (executable-find "python3"))))
    (`(t . t) (treemacs-git-mode 'deferred)) ;; Best performance (requires python3)
    (`(t . _) (treemacs-git-mode 'simple))))

;; Consistent icons with the rest of your config
(use-package treemacs-nerd-icons
  :after treemacs
  :functions treemacs-load-theme
  :config (treemacs-load-theme "nerd-icons"))

;; Magit integration (refresh sidebar on git changes)
(use-package treemacs-magit
  :after (treemacs magit)
  :hook ((magit-post-commit
          git-commit-post-finish
          magit-post-stage
          magit-post-unstage)
         . treemacs-magit--schedule-update))

;; Scope Treemacs to Tabs (Essential for Tabspaces integration)
(use-package treemacs-tab-bar
  :after treemacs
  :functions treemacs-set-scope-type
  :config (treemacs-set-scope-type 'Tabs))

;; Evil navigation in the sidebar
(use-package treemacs-evil
  :after (treemacs evil)
  :config
  (evil-define-key 'normal treemacs-mode-map
    (kbd "TAB") #'treemacs-TAB-action
    (kbd "o")   #'treemacs-visit-node-ace
    (kbd "q")   #'treemacs-quit))
#+end_src

* Markdown
#+begin_src emacs-lisp
(use-package markdown-mode
  :defer t
  :mode (("README\\.md\\'" . gfm-mode))
  :init
  (setq markdown-enable-wiki-links t
        markdown-italic-underscore t
        markdown-asymmetric-header t
        markdown-make-gfm-checkboxes-buttons t
        markdown-gfm-uppercase-checkbox t
        markdown-fontify-code-blocks-natively t

        markdown-content-type "application/xhtml+xml"
        markdown-css-paths '("https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css"
                             "https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/github.min.css")
        markdown-xhtml-header-content "
<meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'>
<style>
body {
  box-sizing: border-box;
  max-width: 740px;
  width: 100%;
  margin: 40px auto;
  padding: 0 10px;
}
</style>

<link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/default.min.css'>
<script src='https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js'></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  document.body.classList.add('markdown-body');
  document.querySelectorAll('pre code').forEach((code) => {
    if (code.className != 'mermaid') {
      hljs.highlightBlock(code);
    }
  });
});
</script>

<script src='https://unpkg.com/mermaid@8.4.8/dist/mermaid.min.js'></script>
<script>
mermaid.initialize({
  theme: 'default',  // default, forest, dark, neutral
  startOnLoad: true
});
</script>
"
        markdown-gfm-additional-languages "Mermaid")

  ;; `multimarkdown' is necessary for `highlight.js' and `mermaid.js'
  (when (executable-find "multimarkdown")
    (setq markdown-command "multimarkdown"))
  :config
  ;; Support `mermaid'
  (add-to-list 'markdown-code-lang-modes '("mermaid" . mermaid-mode))

  (with-no-warnings
    ;; Use `which-key' instead
    (advice-add #'markdown--command-map-prompt :override #'ignore)
    (advice-add #'markdown--style-map-prompt   :override #'ignore)

   ))

;; Table of contents
(use-package markdown-toc
  :defer t
  :bind (:map markdown-mode-command-map
         ("r" . markdown-toc-generate-or-refresh-toc))
  :hook (markdown-mode . markdown-toc-mode)
  :init (setq markdown-toc-indentation-space 2
              markdown-toc-header-toc-title "\n## Table of Contents"
              markdown-toc-user-toc-structure-manipulation-fn 'cdr)
  :config
  (with-no-warnings
    (define-advice markdown-toc-generate-toc (:around (fn &rest args) lsp)
      "Generate or refresh toc after disabling lsp."
      (cond
       ((bound-and-true-p lsp-managed-mode)
        (lsp-managed-mode -1)
        (apply fn args)
        (lsp-managed-mode 1))
       ((bound-and-true-p eglot--manage-mode)
        (eglot--manage-mode -1)
        (apply fn args)
        (eglot--manage-mode 1))
       (t
        (apply fn args))))))

;; Preview markdown files
;; @see https://github.com/seagle0128/grip-mode?tab=readme-ov-file#prerequisite
(use-package grip-mode
  :defer t
  :defines markdown-mode-command-map org-mode-map grip-update-after-change grip-use-mdopen
  :functions auth-source-user-and-password
  :autoload grip-mode
  :init
  (with-eval-after-load 'markdown-mode
    (bind-key "g" #'grip-mode markdown-mode-command-map))

  (with-eval-after-load 'org
    (bind-key "C-c C-g" #'grip-mode org-mode-map))

  (setq grip-update-after-change nil)

  ;; mdopen doesn't need credentials, and only support external browsers
  (if (executable-find "mdopen")
      (setq grip-use-mdopen t)
    (when-let* ((credential (and (require 'auth-source nil t)
                                 (auth-source-user-and-password "api.github.com"))))
      (setq grip-github-user (car credential)
            grip-github-password (cadr credential)))))
#+end_src

* Reader
** PDF Tools
#+begin_src emacs-lisp
(when (display-graphic-p)
  (use-package pdf-view
    :ensure pdf-tools
    :defines pdf-annot-activate-created-annotations
    :functions pdf-tools-install
    :hook ((pdf-tools-enabled . pdf-view-auto-slice-minor-mode)
           (pdf-tools-enabled . pdf-isearch-minor-mode))
    :mode ("\\.[pP][dD][fF]\\'" . pdf-view-mode)
    :magic ("%PDF" . pdf-view-mode)
    :init
    (setq pdf-view-use-scaling t
          pdf-view-use-imagemagick nil
          pdf-annot-activate-created-annotations t
          ;; Tokyo Night theme colors
          pdf-view-midnight-colors '("#c0caf5" . "#1a1b26"))
    :config
    (pdf-tools-install t nil t nil)

    ;; Tokyo Night theme custom faces
    (custom-set-faces
     '(pdf-view-rectangle-face ((t (:background "#7aa2f7" :foreground "#1a1b26"))))
     '(pdf-isearch-match ((t (:background "#e0af68" :foreground "#1a1b26"))))
     '(pdf-isearch-lazy ((t (:background "#414868" :foreground "#c0caf5"))))
     '(pdf-isearch-batch ((t (:background "#414868" :foreground "#c0caf5"))))
     '(pdf-view-region ((t (:background "#364a82"))))
     '(pdf-links-read-link ((t (:background "#7aa2f7" :foreground "#1a1b26"))))
     '(pdf-occur-document-face ((t (:foreground "#7aa2f7"))))
     '(pdf-occur-page-face ((t (:foreground "#9ece6a"))))
     '(pdf-annot-list-annotation-face ((t (:foreground "#bb9af7"))))
     '(pdf-annot-list-location-face ((t (:foreground "#565f89"))))
     '(pdf-history-debug-message-face ((t (:foreground "#565f89"))))
     '(pdf-sync-forward-matching-page-label ((t (:foreground "#e0af68"))))
     '(pdf-sync-backward-matching-page-label ((t (:foreground "#e0af68")))))

    (with-eval-after-load 'org
      (add-to-list 'org-open-at-point-functions 'org-pdftools-open-link)
      (setq org-pdftools-link-prefix "pdf"))))
#+end_src

** Save PDF View
#+begin_src emacs-lisp
(when (display-graphic-p)
  (use-package saveplace-pdf-view
    :when (ignore-errors (pdf-info-check-epdfinfo) t)
    :autoload (saveplace-pdf-view-find-file-advice saveplace-pdf-view-to-alist-advice)
    :functions pdf-info-check-epdfinfo
    :init
    (advice-add 'save-place-find-file-hook :around #'saveplace-pdf-view-find-file-advice)
    (advice-add 'save-place-to-alist :around #'saveplace-pdf-view-to-alist-advice)))
#+end_src

* Development Tools
** envrc
#+begin_src emacs-lisp
(use-package envrc
  :hook (elpaca-after-init . envrc-global-mode))
#+end_src

** LSP Mode
*** Prereq
#+begin_src emacs-lisp
(defvar my-lsp-format-on-save nil
  "Enable format on save with LSP.")

(defvar my-lsp-format-on-save-ignore-modes
  '(c-mode c++-mode python-mode)
  "Major modes to ignore when formatting on save.")

;; Helper function for icons
(defun icons-displayable-p ()
  "Return non-nil if icons can be displayed."
  (and (display-graphic-p)
       (or (featurep 'nerd-icons)
           (require 'nerd-icons nil t))))

;; Helper function for childframe
(defun childframe-workable-p ()
  "Test whether childframe is workable."
  (and (display-graphic-p)
       (or (featurep 'posframe)
           (require 'posframe nil t))))
#+end_src

*** Lsp Mode
#+begin_src emacs-lisp
(use-package lsp-mode
  :defer t
  :defines (lsp-diagnostics-disabled-modes lsp-clients-python-library-directories)
  :autoload lsp-enable-which-key-integration
  :commands (lsp-format-buffer lsp-organize-imports)
  :hook ((prog-mode . (lambda ()
                       (unless (derived-mode-p
                                'emacs-lisp-mode 'lisp-mode
                                'makefile-mode 'snippet-mode
                                'ron-mode)
                         (lsp-deferred))))
         ((markdown-mode yaml-mode yaml-ts-mode) . lsp-deferred)
         (lsp-mode . (lambda ()
                       ;; Integrate `which-key'
                      (lsp-enable-which-key-integration)

                      ;; Format and organize imports
                      (when (and my-lsp-format-on-save
                                 (not (apply #'derived-mode-p my-lsp-format-on-save-ignore-modes)))
                        (add-hook 'before-save-hook #'lsp-format-buffer t t)
                        (add-hook 'before-save-hook #'lsp-organize-imports t t)))))
  :bind (:map lsp-mode-map
         ("C-c C-d" . lsp-describe-thing-at-point)
         ([remap xref-find-definitions] . lsp-find-definition)
         ([remap xref-find-references] . lsp-find-references))
  :init (setq lsp-use-plists t
              lsp-log-io nil

              lsp-keymap-prefix "C-c l"
              lsp-keep-workspace-alive nil
              lsp-signature-auto-activate nil
              lsp-modeline-code-actions-enable nil
              lsp-modeline-diagnostics-enable nil
              lsp-modeline-workspace-status-enable nil

              lsp-semantic-tokens-enable t
              lsp-progress-spinner-type 'progress-bar-filled

              lsp-enable-file-watchers nil
              lsp-enable-folding nil
              lsp-enable-symbol-highlighting nil
              lsp-enable-text-document-color nil

              lsp-enable-indentation nil
              lsp-enable-on-type-formatting nil

              ;; For diagnostics
              lsp-diagnostics-disabled-modes '(markdown-mode gfm-mode)

              ;; For clients
              lsp-clients-python-library-directories '("/usr/local/" "/usr/"))
  :config

  (with-no-warnings
    ;; Disable `lsp-mode' in `git-timemachine-mode'
    (defun my-lsp--init-if-visible (fn &rest args)
      (unless (bound-and-true-p git-timemachine-mode)
        (apply fn args)))
    (advice-add #'lsp--init-if-visible :around #'my-lsp--init-if-visible)

    ;; Enable `lsp-mode' in sh/bash/zsh
    (defun my-lsp-bash-check-sh-shell (&rest _)
      (and (memq major-mode '(sh-mode bash-ts-mode))
           (memq sh-shell '(sh bash zsh))))
    (advice-add #'lsp-bash-check-sh-shell :override #'my-lsp-bash-check-sh-shell)
    (add-to-list 'lsp-language-id-configuration '(bash-ts-mode . "shellscript"))

    ;; Display icons
    (when (icons-displayable-p)
      (defun my-lsp-icons-get-by-file-ext (file-ext &optional feature)
        (when (and file-ext
                   (lsp-icons--enabled-for-feature feature))
          (nerd-icons-icon-for-extension file-ext)))
      (advice-add #'lsp-icons-get-by-file-ext :override #'my-lsp-icons-get-by-file-ext)

      (defvar lsp-symbol-alist
        '((misc          nerd-icons-codicon "nf-cod-symbol_namespace" :face font-lock-warning-face)
          (document      nerd-icons-codicon "nf-cod-symbol_file" :face font-lock-string-face)
          (namespace     nerd-icons-codicon "nf-cod-symbol_namespace" :face font-lock-type-face)
          (string        nerd-icons-codicon "nf-cod-symbol_string" :face font-lock-doc-face)
          (boolean-data  nerd-icons-codicon "nf-cod-symbol_boolean" :face font-lock-builtin-face)
          (numeric       nerd-icons-codicon "nf-cod-symbol_numeric" :face font-lock-builtin-face)
          (method        nerd-icons-codicon "nf-cod-symbol_method" :face font-lock-function-name-face)
          (field         nerd-icons-codicon "nf-cod-symbol_field" :face font-lock-variable-name-face)
          (localvariable nerd-icons-codicon "nf-cod-symbol_variable" :face font-lock-variable-name-face)
          (class         nerd-icons-codicon "nf-cod-symbol_class" :face font-lock-type-face)
          (interface     nerd-icons-codicon "nf-cod-symbol_interface" :face font-lock-type-face)
          (property      nerd-icons-codicon "nf-cod-symbol_property" :face font-lock-variable-name-face)
          (indexer       nerd-icons-codicon "nf-cod-symbol_enum" :face font-lock-builtin-face)
          (enumerator    nerd-icons-codicon "nf-cod-symbol_enum" :face font-lock-builtin-face)
          (treemacs-icon-enumitem      nerd-icons-codicon "nf-cod-symbol_enum_member" :face font-lock-builtin-face)
          (constant      nerd-icons-codicon "nf-cod-symbol_constant" :face font-lock-constant-face)
          (structure     nerd-icons-codicon "nf-cod-symbol_structure" :face font-lock-variable-name-face)
          (event         nerd-icons-codicon "nf-cod-symbol_event" :face font-lock-warning-face)
          (operator      nerd-icons-codicon "nf-cod-symbol_operator" :face font-lock-comment-delimiter-face)
          (template      nerd-icons-codicon "nf-cod-symbol_snippet" :face font-lock-type-face)))

      (defun my-lsp-icons-get-by-symbol-kind (kind &optional feature)
        (when (and kind
                   (lsp-icons--enabled-for-feature feature))
          (let* ((icon (cdr (assoc (lsp-treemacs-symbol-kind->icon kind) lsp-symbol-alist)))
                 (args (cdr icon)))
            (apply (car icon) args))))
      (advice-add #'lsp-icons-get-by-symbol-kind :override #'my-lsp-icons-get-by-symbol-kind)

      (setq lsp-headerline-arrow (nerd-icons-octicon "nf-oct-chevron_right"
                                                     :face 'lsp-headerline-breadcrumb-separator-face)))))
#+end_src

*** LSP UI
#+begin_src emacs-lisp
(use-package lsp-ui
  :defer t
  :custom-face
  (lsp-ui-sideline-code-action ((t (:inherit warning))))
  :pretty-hydra
  ((:title (pretty-hydra-title "LSP UI" 'faicon "nf-fa-rocket" :face 'nerd-icons-green)
    :color amaranth :quit-key ("q" "C-g"))
   ("Doc"
    (("d e" (progn
              (lsp-ui-doc-enable (not lsp-ui-doc-mode))
              (setq lsp-ui-doc-enable (not lsp-ui-doc-enable)))
      "enable" :toggle lsp-ui-doc-mode)
     ("d s" (setq lsp-ui-doc-include-signature (not lsp-ui-doc-include-signature))
      "signature" :toggle lsp-ui-doc-include-signature)
     ("d t" (setq lsp-ui-doc-position 'top)
      "top" :toggle (eq lsp-ui-doc-position 'top))
     ("d b" (setq lsp-ui-doc-position 'bottom)
      "bottom" :toggle (eq lsp-ui-doc-position 'bottom))
     ("d p" (setq lsp-ui-doc-position 'at-point)
      "at point" :toggle (eq lsp-ui-doc-position 'at-point))
     ("d h" (setq lsp-ui-doc-header (not lsp-ui-doc-header))
      "header" :toggle lsp-ui-doc-header)
     ("d f" (setq lsp-ui-doc-alignment 'frame)
      "align frame" :toggle (eq lsp-ui-doc-alignment 'frame))
     ("d w" (setq lsp-ui-doc-alignment 'window)
      "align window" :toggle (eq lsp-ui-doc-alignment 'window)))
    "Sideline"
    (("s e" (progn
              (lsp-ui-sideline-enable (not lsp-ui-sideline-mode))
              (setq lsp-ui-sideline-enable (not lsp-ui-sideline-enable)))
      "enable" :toggle lsp-ui-sideline-mode)
     ("s h" (setq lsp-ui-sideline-show-hover (not lsp-ui-sideline-show-hover))
      "hover" :toggle lsp-ui-sideline-show-hover)
     ("s d" (setq lsp-ui-sideline-show-diagnostics (not lsp-ui-sideline-show-diagnostics))
      "diagnostics" :toggle lsp-ui-sideline-show-diagnostics)
     ("s s" (setq lsp-ui-sideline-show-symbol (not lsp-ui-sideline-show-symbol))
      "symbol" :toggle lsp-ui-sideline-show-symbol)
     ("s c" (setq lsp-ui-sideline-show-code-actions (not lsp-ui-sideline-show-code-actions))
     "code actions" :toggle lsp-ui-sideline-show-code-actions)
     ("s i" (setq lsp-ui-sideline-ignore-duplicate (not lsp-ui-sideline-ignore-duplicate))
      "ignore duplicate" :toggle lsp-ui-sideline-ignore-duplicate))
    "Action"
    (("h" backward-char "←")
     ("j" next-line "↓")
     ("k" previous-line "↑")
     ("l" forward-char "→")
     ("C-a" mwim-beginning-of-code-or-line nil)
     ("C-e" mwim-end-of-code-or-line nil)
     ("C-b" backward-char nil)
     ("C-n" next-line nil)
     ("C-p" previous-line nil)
     ("C-f" forward-char nil)
     ("M-b" backward-word nil)
     ("M-f" forward-word nil)
     ("c" lsp-ui-sideline-apply-code-actions "apply code actions"))))
  :bind (("C-c u" . lsp-ui-imenu)
         :map lsp-ui-mode-map
         ("M-<f6>" . lsp-ui-hydra/body)
         ("s-<return>" . lsp-ui-sideline-apply-code-actions)
         ([remap xref-find-definitions] . lsp-ui-peek-find-definitions)
         ([remap xref-find-references] . lsp-ui-peek-find-references))
  :hook (lsp-mode . lsp-ui-mode)
  :init
  (setq lsp-ui-sideline-show-diagnostics nil
        lsp-ui-sideline-ignore-duplicate t
        lsp-ui-doc-delay 0.1
        lsp-ui-doc-show-with-cursor (not (display-graphic-p))
        lsp-ui-imenu-auto-refresh 'after-save
        lsp-ui-imenu-colors `(,(face-foreground 'font-lock-keyword-face)
                              ,(face-foreground 'font-lock-string-face)
                              ,(face-foreground 'font-lock-constant-face)
                              ,(face-foreground 'font-lock-variable-name-face)))
  ;; Set correct color to borders
  (defun my-lsp-ui-doc-set-border ()
    "Set the border color of lsp doc."
    (setq lsp-ui-doc-border
          (face-background 'posframe-border nil t)))
  (my-lsp-ui-doc-set-border)
  (add-hook 'after-load-theme-hook #'my-lsp-ui-doc-set-border t)
  :config
  (with-no-warnings
    ;; Display peek in child frame if possible
    ;; @see https://github.com/emacs-lsp/lsp-ui/issues/441
    (defvar-local lsp-ui-peek--buffer nil)
    (defun lsp-ui-peek--peek-display (fn src1 src2)
      (if (childframe-workable-p)
          (-let* ((win-width (frame-width))
                  (lsp-ui-peek-list-width (/ (frame-width) 2))
                  (string (-some--> (-zip-fill "" src1 src2)
                            (--map (lsp-ui-peek--adjust win-width it) it)
                            (-map-indexed 'lsp-ui-peek--make-line it)
                            (-concat it (lsp-ui-peek--make-footer)))))
            (setq lsp-ui-peek--buffer (get-buffer-create " *lsp-peek--buffer*"))
           (posframe-show lsp-ui-peek--buffer
                          :string (mapconcat 'identity string "")
                          :min-width (frame-width)
                          :internal-border-color (face-background 'posframe-border nil t)
                          :internal-border-width 1
                          :poshandler #'posframe-poshandler-frame-center))
        (funcall fn src1 src2)))
    (defun lsp-ui-peek--peek-destroy (fn)
      (if (childframe-workable-p)
          (progn
            (when (bufferp lsp-ui-peek--buffer)
              (posframe-hide lsp-ui-peek--buffer))
            (setq lsp-ui-peek--last-xref nil))
        (funcall fn)))
    (advice-add #'lsp-ui-peek--peek-new :around #'lsp-ui-peek--peek-display)
    (advice-add #'lsp-ui-peek--peek-hide :around #'lsp-ui-peek--peek-destroy)

    ;; Handle docs
    (defun my-lsp-ui-doc--handle-hr-lines nil
      (let (bolp next before after)
        (goto-char 1)
        (while (setq next (next-single-property-change (or next 1) 'markdown-hr))
         (when (get-text-property next 'markdown-hr)
           (goto-char next)
           (setq bolp (bolp)
                 before (char-before))
           (delete-region (point) (save-excursion (forward-visible-line 1) (point)))
           (setq after- (char-after (1+ (point))))
           (insert
            (concat
             (and bolp (not (equal before ?\n)) (propertize "\n" 'face '(:height 0.5)))
             (propertize "\n" 'face '(:height 0.5))
             (propertize " "
                         ;; :align-to is added with lsp-ui-doc--fix-hr-props
                         'display- '(space :height (1))
                         'lsp-ui-doc--replace-hr t
                         'face `(:background ,(face-foreground 'font-lock-comment-face nil t)))
             ;; :align-to is added here too
             (propertize " " 'display- '(space :height (1)))
             (and (not (equal after ?\n)) (propertize " \n" 'face '(:height 0.5)))))))))
    (advice-add #'lsp-ui-doc--handle-hr-lines :override #'my-lsp-ui-doc--handle-hr-lines)))
#+end_src

*** Consult Integration

#+begin_src emacs-lisp
(use-package consult-lsp
  :defer t
  :bind (:map lsp-mode-map
         ("C-M-." . consult-lsp-symbols)))
#+end_src

*** LSP Treemacs
#+begin_src emacs-lisp
(use-package lsp-treemacs
 :after lsp-mode
 :functions lsp-treemacs-sync-mode
 :bind (:map lsp-mode-map
        ("C-<f8>" . lsp-treemacs-errors-list)
        ("M-<f8>" . lsp-treemacs-symbols)
        ("s-<f8>" . lsp-treemacs-java-deps-list))
 :init (lsp-treemacs-sync-mode 1)
 :config
 (with-eval-after-load 'ace-window
   (when (boundp 'aw-ignored-buffers)
     (push 'lsp-treemacs-symbols-mode aw-ignored-buffers)
     (push 'lsp-treemacs-java-deps-mode aw-ignored-buffers)))

 (with-no-warnings
   (when (icons-displayable-p)
     (treemacs-create-theme "lsp-nerd-icons"
       :config
       (progn
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-repo" :face 'nerd-icons-blue))
          :extensions (root))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_boolean" :face 'nerd-icons-lblue))
          :extensions (boolean-data))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_class" :face 'nerd-icons-orange))
          :extensions (class))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_color"))
          :extensions (color-palette))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_constant"))
          :extensions (constant))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_file"))
          :extensions (document))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_misc" :face 'nerd-icons-orange))
          :extensions (enumerator))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_enum_member" :face 'nerd-icons-lblue))
          :extensions (enumitem))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_event" :face 'nerd-icons-orange))
          :extensions (event))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_field" :face 'nerd-icons-lblue))
          :extensions (field))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_misc"))
          :extensions (indexer))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_keyword"))
          :extensions (intellisense-keyword))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_interface" :face 'nerd-icons-lblue))
          :extensions (interface))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_variable" :face 'nerd-icons-lblue))
          :extensions (localvariable))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_method" :face 'nerd-icons-purple))
          :extensions (method))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_namespace" :face 'nerd-icons-lblue))
          :extensions (namespace))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_numeric"))
          :extensions (numeric))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_operator"))
          :extensions (operator))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_property"))
          :extensions (property))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_snippet"))
          :extensions (snippet))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_string"))
          :extensions (string))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_structure" :face 'nerd-icons-orange))
          :extensions (structure))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_snippet"))
          :extensions (template))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-chevron_right" :face 'nerd-icons-dsilver))
          :extensions (collapsed) :fallback "+")
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-chevron_down" :face 'nerd-icons-dsilver))
          :extensions (expanded) :fallback "-")
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-file_binary" :face 'nerd-icons-dsilver))
          :extensions (classfile))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder_opened" :face 'nerd-icons-blue))
          :extensions (default-folder-opened))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder" :face 'nerd-icons-blue))
          :extensions (default-folder))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder_opened" :face 'nerd-icons-green))
          :extensions (default-root-folder-opened))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder" :face 'nerd-icons-green))
          :extensions (default-root-folder))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-file_binary" :face 'nerd-icons-dsilver))
          :extensions ("class"))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-file_zip" :face 'nerd-icons-dsilver))
          :extensions (file-type-jar))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder_opened" :face 'nerd-icons-dsilver))
          :extensions (folder-open))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder" :face 'nerd-icons-dsilver))
          :extensions (folder))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder_opened" :face 'nerd-icons-orange))
          :extensions (folder-type-component-opened))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder" :face 'nerd-icons-orange))
          :extensions (folder-type-component))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder_opened" :face 'nerd-icons-green))
          :extensions (folder-type-library-opened))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder" :face 'nerd-icons-green))
          :extensions (folder-type-library))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder_opened" :face 'nerd-icons-pink))
          :extensions (folder-type-maven-opened))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder" :face 'nerd-icons-pink))
          :extensions (folder-type-maven))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder_opened" :face 'nerd-icons-orange))
          :extensions (folder-type-package-opened))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder" :face 'nerd-icons-orange))
          :extensions (folder-type-package))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-add" :face 'nerd-icons-dsilver))
          :extensions (icon-create))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-list_flat" :face 'nerd-icons-dsilver))
          :extensions (icon-flat))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-symbol_class" :face 'nerd-icons-blue))
          :extensions (icon-hierarchical))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-link" :face 'nerd-icons-dsilver))
          :extensions (icon-link))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-refresh" :face 'nerd-icons-dsilver))
          :extensions (icon-refresh))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-faicon "nf-fa-unlink" :face 'nerd-icons-dsilver))
          :extensions (icon-unlink))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-devicon "nf-dev-java" :face 'nerd-icons-orange))
          :extensions (jar))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-library" :face 'nerd-icons-green))
          :extensions (library))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder_opened" :face 'nerd-icons-lblue))
          :extensions (packagefolder-open))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-folder" :face 'nerd-icons-lblue))
          :extensions (packagefolder))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-archive" :face 'nerd-icons-dsilver))
          :extensions (package))
         (treemacs-create-icon
          :icon (format "%s " (nerd-icons-codicon "nf-cod-repo" :face 'nerd-icons-blue))
          :extensions (java-project))))

     (setq lsp-treemacs-theme "lsp-nerd-icons"))))
#+end_src

*** LSP pyright
#+begin_src emacs-lisp
(use-package lsp-pyright
  :custom (lsp-pyright-langserver-command "pyright") ;; or basedpyright
  :hook (((python-mode python-ts-mode) . (lambda ()
                                          (require 'lsp-pyright)
                                          (lsp-deferred)))))  ; or lsp-deferred
#+end_src

*** Enable LSP in org babel
#+begin_src emacs-lisp
(cl-defmacro lsp-org-babel-enable (lang)
  "Support LANG in org source code block."
  (cl-check-type lang string)
  (let* ((edit-pre (intern (format "org-babel-edit-prep:%s" lang)))
         (intern-pre (intern (format "lsp--%s" (symbol-name edit-pre)))))
    `(progn
       (defun ,intern-pre (info)
         (setq buffer-file-name (or (->> info caddr (alist-get :file))
                                    "org-src-babel.tmp"))
         (when (fboundp 'lsp-deferred)
           ;; Avoid headerline conflicts
           (setq-local lsp-headerline-breadcrumb-enable nil)
           (lsp-deferred)))
       (put ',intern-pre 'function-documentation
            (format "Enable lsp-mode in the buffer of org source block (%s)."
                    (upcase ,lang)))

       (if (fboundp ',edit-pre)
           (advice-add ',edit-pre :after ',intern-pre)
         (progn
           (defun ,edit-pre (info)
             (,intern-pre info))
           (put ',edit-pre 'function-documentation
                (format "Prepare local buffer environment for org source block (%s)."
                        (upcase ,lang))))))))

(defconst org-babel-lang-list
  '("go" "python" "ipython" "ruby" "js" "css" "sass" "c" "rust" "java" "cpp" "c++" "shell")
  "The supported programming languages for interactive Babel.")
(dolist (lang org-babel-lang-list)
  (eval `(lsp-org-babel-enable ,lang)))
#+end_src

** DAP
#+begin_src emacs-lisp
(use-package dape
  :defer t
  :bind (("<f5>" . dape)
         ("M-<f5>" . dape-hydra/body))
  :custom (dape-buffer-window-arrangment 'right)
  :pretty-hydra
  ((:title (pretty-hydra-title "Debug" 'codicon "nf-cod-debug")
    :color pink :quit-key ("q" "C-g"))
   ("Stepping"
    (("n" dape-next "next")
     ("s" dape-step-in "step in")
     ("o" dape-step-out "step out")
     ("c" dape-continue "continue")
     ("p" dape-pause "pause")
     ("k" dape-kill "kill")
     ("r" dape-restart "restart")
     ("D" dape-disconnect-quit "disconnect"))
    "Switch"
    (("m" dape-read-memory "memory")
     ("t" dape-select-thread "thread")
     ("w" dape-watch-dwim "watch")
     ("S" dape-select-stack "stack")
     ("i" dape-info "info")
     ("R" dape-repl "repl"))
    "Breakpoints"
    (("b" dape-breakpoint-toggle "toggle")
     ("l" dape-breakpoint-log "log")
     ("e" dape-breakpoint-expression "expression")
     ("B" dape-breakpoint-remove-all "clear"))
    "Debug"
    (("d" dape "dape")
     ("Q" dape-quit "quit" :exit t))))
  :config
  ;; Save buffers on startup, useful for interpreted languages
  (add-hook 'dape-on-start-hooks
            (defun dape--save-on-start ()
              (save-some-buffers t t)))
  ;; Display hydra on startup
  (add-hook 'dape-on-start-hooks #'dape-hydra/body))
#+end_src

** TODO Syntax Checking
=Integrate with scimax=
#+begin_src emacs-lisp
(use-package flycheck
  :defer t
  :hook (prog-mode . flycheck-mode)
  :config
  (setq flycheck-emacs-lisp-load-path 'inherit)
  (delq 'new-line flycheck-check-syntax-automatically)
  (setq flycheck-idle-change-delay 1.0)
  (setq flycheck-buffer-switch-check-intermediate-buffers t)
  (setq flycheck-display-errors-delay 0.25))

(use-package flycheck-posframe
  :defer t
  :after flycheck
  :hook (flycheck-mode . flycheck-posframe-mode))
#+end_src

** Formatting
#+begin_src emacs-lisp
(use-package apheleia
  :defer t
  :config
  (apheleia-global-mode +1))
#+end_src

** Eldoc
#+begin_src emacs-lisp
(use-package eldoc
  :defer t
  :ensure nil
  :config
  (when (childframe-workable-p)
    (use-package eldoc-mouse
      :bind (:map eldoc-mouse-mode-map
             ("C-h ." . eldoc-mouse-pop-doc-at-cursor))
      :hook (eglot-managed-mode emacs-lisp-mode)
      :init (setq eldoc-mouse-posframe-border-color (face-background 'posframe-border nil t))
      :config
      (tooltip-mode -1)                 ; Conflict with `track-mouse'
      (add-to-list 'eldoc-mouse-posframe-override-parameters
                   `(background-color . ,(face-background 'tooltip nil t))))))
#+end_src

** Cross Referencing Commands
#+begin_src emacs-lisp
(use-package xref
  :ensure nil
  :defer t
  :autoload xref-show-definitions-completing-read
  :bind (("M-g ." . xref-find-definitions)
         ("M-g ," . xref-go-back))
  :init
  ;; Use faster search tool
  (when (executable-find "rg")
    (setq xref-search-program 'ripgrep))

  ;; Select from xref candidates in minibuffer
  (setq xref-show-definitions-function #'xref-show-definitions-completing-read
        xref-show-xrefs-function #'xref-show-definitions-completing-read))
#+end_src

* Utils
** Which Key
#+begin_src emacs-lisp
(use-package which-key
  :defer 0.5
  :hook (elpaca-after-init . which-key-mode)
  :custom
  (which-key-idle-delay 0.1)
  (which-key-separator " → ")
  (which-key-popup-type 'minibuffer))
#+end_src

** Grep
Search tools
#+begin_src emacs-lisp
(use-package grep
  :defer t
  :ensure nil
  :autoload grep-apply-setting
  :init
  (when (executable-find "rg")
    (grep-apply-setting
     'grep-command "rg --color=auto --null -nH --no-heading -e ")
    (grep-apply-setting
     'grep-template "rg --color=auto --null --no-heading -g '!*/' -e <R> <D>")
    (grep-apply-setting
     'grep-find-command '("rg --color=auto --null -nH --no-heading -e ''" . 38))
    (grep-apply-setting
     'grep-find-template "rg --color=auto --null -nH --no-heading -e <R> <D>")))
#+end_src

** Wgrep
Writable `grep' buffer
#+begin_src emacs-lisp
(use-package wgrep
  :defer t
  :init (setq wgrep-auto-save-buffer t
              wgrep-change-readonly-file t))
#+end_src

** Rg
Fast search tool `ripgrep'
#+begin_src emacs-lisp
(use-package rg
  :defer t
  :hook (elpaca-after-init . rg-enable-default-bindings)
  :bind (:map rg-global-map
         ("c" . rg-dwim-current-dir)
         ("f" . rg-dwim-current-file)
         ("m" . rg-menu))
  :init (setq rg-show-columns t)
  :config (add-to-list 'rg-custom-type-aliases '("tmpl" . "*.tmpl")))
#+end_src

** ztree
text mode directory tree
#+begin_src emacs-lisp
(use-package ztree
  :defer t
  :custom-face
  (ztreep-header-face ((t (:inherit diff-header :foreground unspecified))))
  (ztreep-arrow-face ((t (:inherit font-lock-comment-face :foreground unspecified))))
  (ztreep-leaf-face ((t (:inherit diff-index :foreground unspecified))))
  (ztreep-node-face ((t (:inherit font-lock-variable-name-face :foreground unspecified))))
  (ztreep-expand-sign-face ((t (:inherit font-lock-function-name-face))))
  (ztreep-diff-header-face ((t (:inherit (diff-header bold :foreground unspecified)))))
  (ztreep-diff-header-small-face ((t (:inherit diff-file-header :foreground unspecified))))
  (ztreep-diff-model-normal-face ((t (:inherit font-lock-doc-face :foreground unspecified))))
  (ztreep-diff-model-ignored-face ((t (:inherit font-lock-doc-face :strike-through t :foreground unspecified))))
  (ztreep-diff-model-diff-face ((t (:inherit diff-removed :foreground unspecified))))
  (ztreep-diff-model-add-face ((t (:inherit diff-nonexistent :foreground unspecified))))
  :pretty-hydra
  ((:title (pretty-hydra-title "Ztree" 'octicon "nf-oct-diff" :face 'nerd-icons-green)
    :color pink :quit-key ("q" "C-g"))
   ("Diff"
    (("C" ztree-diff-copy "copy" :exit t)
     ("h" ztree-diff-toggle-show-equal-files "show/hide equals" :exit t)
     ("H" ztree-diff-toggle-show-filtered-files "show/hide ignores" :exit t)
     ("D" ztree-diff-delete-file "delete" :exit t)
     ("v" ztree-diff-view-file "view" :exit t)
     ("d" ztree-diff-simple-diff-files "simple diff" :exit t)
     ("r" ztree-diff-partial-rescan "partial rescan" :exit t)
     ("R" ztree-diff-full-rescan "full rescan" :exit t))
    "View"
    (("RET" ztree-perform-action "expand/collapse or view" :exit t)
     ("SPC" ztree-perform-soft-action "expand/collapse or view in other" :exit t)
     ("TAB" ztree-jump-side "jump side" :exit t)
     ("g" ztree-refresh-buffer "refresh" :exit t)
     ("x" ztree-toggle-expand-subtree "expand/collapse" :exit t)
     ("<backspace>" ztree-move-up-in-tree "go to parent" :exit t))))
  :bind (:map ztreediff-mode-map
         ("C-<f5>" . ztree-hydra/body))
  :init (setq ztree-draw-unicode-lines t
              ztree-show-number-of-children t))
#+end_src

* General Keybindings
#+begin_src emacs-lisp
(use-package general
  :after evil
  :ensure (:wait t)
  :demand t
  :config
  ;; Set up leader keys
  (general-create-definer ar/global-leader
    :states '(normal insert visual emacs)
    :prefix "SPC"
    :global-prefix "C-SPC")

  (general-create-definer ar/local-leader
    :states '(normal insert visual emacs)
    :prefix "SPC m"
    :global-prefix "C-SPC m")

  (ar/global-leader
    "SPC" '(execute-extended-command :wk "M-x")
    ":" '(eval-expression :wk "Eval")
    ";" '(evilnc-comment-or-uncomment-lines :wk "Comment")
    "u" '(universal-argument :wk "Universal arg")
    "!" '(shell-command :wk "Shell cmd")
    "X" '(org-capture :wk "Org capture"))

  ;; File operations (SPC f)
  (ar/global-leader
    "f" '(:ignore t :wk "file")
    "f f" '(find-file :wk "Find file")
    "f r" '(consult-recent-file :wk "Recent files")
    "f s" '(save-buffer :wk "Save file")
    "f S" '(write-file :wk "Save as")
    "f D" '(delete-this-file :wk "Delete file")
    "f R" '(rename-this-file :wk "Rename file")
    "f c" '(copy-file-name :wk "Copy filename")
    "f y" '(copy-file-name :wk "Yank filename")
    "f E" '(sudo-edit :wk "Sudo edit")
    "f l" '(reload-init-file :wk "Reload config")
    "f e" '(:ignore t :wk "emacs")
    "f e d" '((lambda () (interactive) (find-file user-emacs-directory)) :wk "Open emacs.d")
    "f e i" '((lambda () (interactive) (find-file user-init-file)) :wk "Open init.el")
    "f e c" '(find-custom-file :wk "Open custom.el")
    "f d" '(consult-dir :wk "Change directory")
    "f j" '(consult-dir-jump-file :wk "Jump to file in dir"))

  ;; Buffer operations (SPC b)
  (ar/global-leader
    "b" '(:ignore t :wk "buffer")
    "b b" '(consult-buffer :wk "Switch buffer")
    "b i" '(ibuffer :wk "Ibuffer")
    "b k" '(kill-current-buffer :wk "Kill buffer")
    "b K" '(kill-buffer :wk "Kill buffer (choose)")
    "b n" '(next-buffer :wk "Next buffer")
    "b p" '(previous-buffer :wk "Previous buffer")
    "b r" '(revert-buffer-quick :wk "Revert buffer")
    "b R" '(rename-buffer :wk "Rename buffer")
    "b s" '(create-scratch-buffer :wk "Scratch buffer")
    "b S" '(save-buffer :wk "Save buffer")
    "b y" '(copy-file-name :wk "Copy buffer name")
    "b z" '(bury-buffer :wk "Bury buffer")
    "b [" '(previous-buffer :wk "Previous buffer")
    "b ]" '(next-buffer :wk "Next buffer"))

  ;; Search operations (SPC s)
  (ar/global-leader
    "s" '(:ignore t :wk "search")
    "s s" '(consult-line :wk "Search buffer")
    "s S" '(consult-line-multi :wk "Search buffers")
    "s p" '(consult-ripgrep :wk "Search project")
    "s d" '(consult-dir :wk "Search directory")
    "s i" '(consult-imenu :wk "Imenu")
    "s I" '(consult-imenu-multi :wk "Imenu multi")
    "s o" '(consult-outline :wk "Outline")
    "s b" '(consult-line :wk "Search buffer")
    "s j" '(evil-show-jumps :wk "Jump list")
    "s m" '(consult-mark :wk "Mark ring")
    "s r" '(rg :wk "Ripgrep")
    "s e" '(consult-isearch-history :wk "Search history")
    "s y" '(consult-yasnippet :wk "Yasnippet")
    "s t" '(hl-todo-occur :wk "Todo list")
    "s T" '(hl-todo-rg-project :wk "Todo in project")

    "s h" '(:ignore t :wk "highlight")
    "s h h" '(symbol-overlay-put :wk "Highlight symbol")
    "s h c" '(symbol-overlay-remove-all :wk "Clear highlights")
    "s h n" '(symbol-overlay-jump-next :wk "Next occurrence")
    "s h p" '(symbol-overlay-jump-prev :wk "Prev occurrence")
    "s h d" '(symbol-overlay-jump-to-definition :wk "Jump to definition")
    "s h r" '(symbol-overlay-rename :wk "Rename symbol")
    "s h q" '(symbol-overlay-query-replace :wk "Query replace")
    "s h t" '(symbol-overlay-toggle-in-scope :wk "Toggle scope")
    "s h w" '(symbol-overlay-save-symbol :wk "Copy symbol")
    "s h m" '(symbol-overlay-mode :wk "Symbol overlay mode"))

  ;; Window operations (SPC w)
  (ar/global-leader
    "w" '(:ignore t :wk "window")
    "w w" '(other-window :wk "Other window")
    "w d" '(delete-window :wk "Delete window")
    "w D" '(delete-other-windows :wk "Delete other windows")
    "w s" '(split-window-below :wk "Split below")
    "w v" '(split-window-right :wk "Split right")
    "w h" '(evil-window-left :wk "Window left")
    "w j" '(evil-window-down :wk "Window down")
    "w k" '(evil-window-up :wk "Window up")
    "w l" '(evil-window-right :wk "Window right")
    "w H" '(evil-window-move-far-left :wk "Move far left")
    "w J" '(evil-window-move-very-bottom :wk "Move bottom")
    "w K" '(evil-window-move-very-top :wk "Move top")
    "w L" '(evil-window-move-far-right :wk "Move far right")
    "w =" '(balance-windows :wk "Balance windows")
    "w m" '(delete-other-windows :wk "Maximize")
    "w o" '(other-window :wk "Other window")
    "w u" '(winner-undo :wk "Winner undo")
    "w r" '(winner-redo :wk "Winner redo")
    "w t" '(toggle-window-split :wk "Toggle split")
    "w _" '(split-window-vertically-instead :wk "Split vertically instead")
    "w |" '(split-window-horizontally-instead :wk "Split horizontally instead"))

  ;; Project operations (SPC p)
  (ar/global-leader
    "p" '(:ignore t :wk "project")
    "p p" '(project-switch-project :wk "Switch project")
    "p f" '(project-find-file :wk "Find file in project")
    "p s" '(consult-ripgrep :wk "Search project")
    "p b" '(consult-project-buffer :wk "Project buffers")
    "p k" '(project-kill-buffers :wk "Kill project buffers")
    "p c" '(project-compile :wk "Compile project")
    "p d" '(project-dired :wk "Dired project root")
    "p e" '(project-eshell :wk "Eshell in project")
    "p t" '(treemacs :wk "Treemacs"))

  ;; Toggle operations (SPC t)
  (ar/global-leader
    "t" '(:ignore t :wk "toggle")
    "t l" '(display-line-numbers-mode :wk "Line numbers")
    "t w" '(whitespace-mode :wk "Whitespace")
    "t f" '(toggle-frame-fullscreen :wk "Fullscreen")
    "t m" '(toggle-frame-maximized :wk "Maximize")
    "t t" '(consult-theme :wk "Theme")
    "t v" '(visual-line-mode :wk "Visual line mode")
    "t i" '(highlight-indent-guides-mode :wk "Indent guides")
    "t r" '(rainbow-mode :wk "Rainbow mode")
    "t h" '(global-hl-line-mode :wk "Highlight line")
    "t p" '(show-paren-mode :wk "Show paren")
    "t T" '(toggles-hydra/body :wk "Toggles hydra")
    "t o" '(olivetti-mode :wk "Olivetti mode")
    "t z" '(:ignore t :wk "transparency")
    "t z i" '(transwin-inc :wk "Increase")
    "t z d" '(transwin-dec :wk "Decrease")
    "t z t" '(transwin-toggle :wk "Toggle"))

  ;; Dired operations
  (ar/global-leader
    "d" '(:ignore t :wk "dired/dirvish")
    "d d" '(dired :wk "Dired")
    "d f" '(dirvish :wk "Dirvish fullscreen")
    "d s" '(dirvish-side :wk "Dirvish sidebar")
    "d w" '(dirvish-dwim :wk "Dirvish dwim")
    "d h" '(dirvish-show-history :wk "Show history")
    "d a" '(dirvish-quick-access :wk "Quick access")
    "d j" '(dirvish-fd-jump :wk "Jump with fd"))
  
  ;; Open operations (SPC o)
  (ar/global-leader
    "o" '(:ignore t :wk "open")
    "o p" '(treemacs :wk "Treemacs")
    "o t" '(vterm :wk "Terminal")
    "o e" '(eshell :wk "Eshell")
    "o s" '(shell :wk "Shell")
    "o d" '(dired :wk "Dired")
    "o D" '(dashboard-open :wk "Dashboard")
    "o P" '(popper-toggle :wk "Toggle popup"))

  ;; Help operations (SPC h)
  (ar/global-leader
    "h" '(:ignore t :wk "help")
    "h f" '(helpful-callable :wk "Describe function")
    "h v" '(helpful-variable :wk "Describe variable")
    "h k" '(helpful-key :wk "Describe key")
    "h m" '(describe-mode :wk "Describe mode")
    "h o" '(helpful-symbol :wk "Describe symbol")
    "h c" '(helpful-command :wk "Describe command")
    "h ." '(helpful-at-point :wk "Describe at point")
    "h i" '(info :wk "Info")
    "h I" '(consult-info :wk "Consult info")
    "h p" '(describe-package :wk "Describe package")
    "h a" '(apropos :wk "Apropos")
    "h w" '(woman :wk "Woman")
    "h r" '(:ignore t :wk "reload")
    "h r r" '(reload-init-file :wk "Reload config"))

  ;; Code operations (SPC c)
  (ar/global-leader
    "c" '(:ignore t :wk "code")
    "c a" '(lsp-execute-code-action :wk "Code action")
    "c d" '(lsp-find-definition :wk "Definition")
    "c D" '(lsp-find-declaration :wk "Declaration")
    "c r" '(lsp-find-references :wk "References")
    "c i" '(lsp-find-implementation :wk "Implementation")
    "c t" '(lsp-find-type-definition :wk "Type definition")
    "c s" '(consult-lsp-symbols :wk "Symbols")
    "c S" '(lsp-ui-doc-show :wk "Show doc")
    "c f" '(lsp-format-buffer :wk "Format buffer")
    "c F" '(lsp-format-region :wk "Format region")
    "c o" '(lsp-organize-imports :wk "Organize imports")
    "c R" '(lsp-rename :wk "Rename")
    "c e" '(consult-flymake :wk "Errors")
    "c x" '(quickrun :wk "Quickrun")
    "c X" '(quickrun-shell :wk "Quickrun shell")
    "c c" '(compile :wk "Compile")
    "c C" '(recompile :wk "Recompile")
    "c l" '(:ignore t :wk "lsp")
    "c l r" '(lsp-workspace-restart :wk "Restart workspace")
    "c l s" '(lsp-workspace-shutdown :wk "Shutdown workspace")
    "c l d" '(lsp-describe-session :wk "Describe session")
    "c l D" '(lsp-disconnect :wk "Disconnect")
    "c l u" '(lsp-ui-hydra/body :wk "LSP UI hydra")
    "c l i" '(lsp-ui-imenu :wk "LSP Imenu")
    "c l t" '(lsp-treemacs-symbols :wk "Treemacs symbols")
    "c l e" '(lsp-treemacs-errors-list :wk "Treemacs errors"))

  ;; Git operations (SPC g)
  (ar/global-leader
    "g" '(:ignore t :wk "git")
    "g s" '(magit-status :wk "status")
    "g c" '(magit-commit :wk "commit")
    "g C" '(magit-commit-amend :wk "commit amend")
    "g p" '(magit-push-current-to-pushremote :wk "push")
    "g P" '(magit-pull-from-upstream :wk "pull")
    "g b" '(magit-branch :wk "branches")
    "g l" '(magit-log-buffer-file :wk "log current file")
    "g L" '(magit-log-current :wk "log current branch")
    "g d" '(magit-diff-unstaged :wk "diff")
    "g f" '(magit-fetch :wk "fetch")
    "g m" '(magit-merge :wk "merge")
    "g r" '(magit-rebase :wk "rebase")
    "g n" '(git-gutter:next-hunk :wk "next hunk")
    "g N" '(git-gutter:previous-hunk :wk "previous hunk")
    "g S" '(git-gutter:stage-hunk :wk "stage hunk"))

  ;; Register/Bookmark operations (SPC r)
  (ar/global-leader
    "r" '(:ignore t :wk "register/bookmark")
    "r r" '(consult-register :wk "Registers")
    "r s" '(consult-register-store :wk "Store register")
    "r l" '(consult-register-load :wk "Load register")
    "r b" '(consult-bookmark :wk "Bookmarks")
    "r B" '(bookmark-set :wk "Set bookmark")
    "r d" '(bookmark-delete :wk "Delete bookmark")
    "r m" '(bookmark-bmenu-list :wk "Bookmark menu"))

  ;; Notes operations (SPC n)
  (ar/global-leader
    "n" '(:ignore t :wk "notes")
    "n a" '(org-agenda :wk "Agenda")
    "n c" '(org-capture :wk "Capture")
    "n f" '(org-roam-node-find :wk "Find node")
    "n F" '(consult-org-roam-file-find :wk "Find file")
    "n i" '(org-roam-node-insert :wk "Insert node")
    "n l" '(org-roam-buffer-toggle :wk "Roam buffer")
    "n g" '(org-roam-graph :wk "Roam graph")
    "n u" '(org-roam-ui-open :wk "Roam UI")
    "n j" '(org-roam-dailies-capture-today :wk "Daily note")
    "n b" '(consult-org-roam-backlinks :wk "Backlinks")
    "n B" '(consult-org-roam-backlinks-recursive :wk "Backlinks recursive")
    "n L" '(consult-org-roam-forward-links :wk "Forward links")
    "n s" '(consult-org-roam-search :wk "Search roam")
    "n t" '(:ignore t :wk "table")
    "n t c" '(org-table-create :wk "Create table")
    "n t a" '(org-table-align :wk "Align table")
    "n t r" '(org-table-recalculate :wk "Recalculate"))

  ;; Quit/Session operations (SPC q)
  (ar/global-leader
    "q" '(:ignore t :wk "quit/session")
    "q q" '(save-buffers-kill-terminal :wk "Quit Emacs")
    "q Q" '(kill-emacs :wk "Quit (no save)")
    "q r" '(restart-emacs :wk "Restart Emacs")
    "q f" '(delete-frame :wk "Delete frame")
    "q s" '(tabspaces-save-session :wk "Save session")
    "q l" '(tabspaces-restore-session :wk "Load session"))

  ;; Insert operations (SPC i)
  (ar/global-leader
    "i" '(:ignore t :wk "insert")
    "i s" '(consult-yasnippet :wk "Snippet")
    "i u" '(insert-char :wk "Unicode char")
    "i e" '(emoji-insert :wk "Emoji")
    "i t" '(insert-time :wk "Timestamp"))

  ;; Zoom operations (SPC z)
  (ar/global-leader
    "z" '(:ignore t :wk "zoom")
    "z +" '(text-scale-increase :wk "Zoom in")
    "z -" '(text-scale-decrease :wk "Zoom out")
    "z 0" '((lambda () (interactive) (text-scale-set 0)) :wk "Reset zoom")
    "z f" '(toggle-frame-fullscreen :wk "Fullscreen")
    "z m" '(toggle-frame-maximized :wk "Maximize")
    "z l" '(centaur-frame-left-half :wk "Left half")
    "z r" '(centaur-frame-right-half :wk "Right half")
    "z t" '(centaur-frame-top-half :wk "Top half")
    "z b" '(centaur-frame-bottom-half :wk "Bottom half")
    "z R" '(centaur-frame-restore :wk "Restore frame"))

  ;; Workspace operations (SPC TAB)
  (ar/global-leader
    "TAB" '(:ignore t :wk "workspace")
    "TAB TAB" '(tabspaces-switch-or-create-workspace :wk "Switch workspace")
    "TAB n" '(tabspaces-switch-or-create-workspace :wk "New workspace")
    "TAB d" '(tabspaces-close-workspace :wk "Delete workspace")
    "TAB r" '(tabspaces-switch-or-create-workspace :wk "Rename workspace")
    "TAB [" '(tabspaces-switch-buffer-and-tab :wk "Previous workspace")
    "TAB ]" '(tabspaces-switch-buffer-and-tab :wk "Next workspace")
    "TAB s" '(tabspaces-save-session :wk "Save session")
    "TAB l" '(tabspaces-restore-session :wk "Load session"))

  ;; Macro operations (SPC @)
  (ar/global-leader
    "@" '(:ignore t :wk "macro")
    "@ @" '(kmacro-end-and-call-macro :wk "End and call")
    "@ s" '(kmacro-start-macro :wk "Start recording")
    "@ e" '(kmacro-end-macro :wk "End recording")
    "@ c" '(kmacro-call-macro :wk "Call macro")
    "@ n" '(kmacro-name-last-macro :wk "Name last")
    "@ b" '(kmacro-bind-to-key :wk "Bind to key")
    "@ v" '(kmacro-view-macro :wk "View macro")
    "@ d" '(kmacro-delete-ring-head :wk "Delete"))

  ;; Kill ring (SPC k)
  (ar/global-leader
    "k" '(browse-kill-ring :wk "Kill ring"))

  ;; Iedit (SPC e)
  (ar/global-leader
    "e" '(:ignore t :wk "iedit")
    "e e" '(iedit-mode :wk "Iedit mode")
    "e r" '(iedit-rectangle-mode :wk "Rectangle mode"))

  ;; Casual suite (SPC ?)
  (ar/global-leader
    "?" '(:ignore t :wk "casual")
    "? a" '(casual-avy-tmenu :wk "Avy")
    "? e" '(casual-editkit-main-tmenu :wk "Editkit")
    "? d" '(casual-dired-tmenu :wk "Dired")
    "? i" '(casual-isearch-tmenu :wk "Isearch")
    "? I" '(casual-info-tmenu :wk "Info")
    "? b" '(casual-bookmarks-tmenu :wk "Bookmarks")
    "? c" '(casual-calc-tmenu :wk "Calc"))

  ;; Treemacs (SPC 0)
  (ar/global-leader
    "0" '(treemacs-select-window :wk "Select treemacs"))

  (general-define-key
   :states 'motion
   ;; Avy bindings
   "g s" 'avy-goto-char-2
   "g S" 'avy-goto-line
   "g w" 'avy-goto-word-1
   "g e" 'avy-goto-word-0

   ;; Xref/LSP navigation
   "g d" 'xref-find-definitions
   "g D" 'xref-find-references
   "g i" 'lsp-find-implementation
   "g t" 'lsp-find-type-definition
   "g [" 'diff-hl-previous-hunk
   "g ]" 'diff-hl-next-hunk
   "g ," 'xref-go-back
   "g ." 'xref-find-definitions)

  (general-define-key
   :states '(normal visual)
   ;; Better navigation
   "j" 'evil-next-visual-line
   "k" 'evil-previous-visual-line
   "gj" 'evil-next-line
   "gk" 'evil-previous-line

   ;; Avy zap
   "z" 'avy-zap-to-char-dwim
   "Z" 'avy-zap-up-to-char-dwim)

  (general-define-key
   :states 'normal
   ;; Undo-fu
   "u" 'undo-fu-only-undo
   "C-r" 'undo-fu-only-redo)

  (general-define-key
   :states 'insert
   ;; Yasnippet navigation with Tab conflict resolution handled by yasnippet itself
   )

  (general-define-key
   ;; Ace-link
   "M-o" 'ace-link-addr

   ;; Popper
   "C-`" 'popper-toggle
   "C-~" 'popper-cycle
   "M-`" 'popper-toggle-type)

  (general-define-key
   :states 'normal
   :keymaps 'dired-mode-map
   "h" 'dired-up-directory
   "l" 'dired-find-file
   "o" 'dired-find-file-other-window
   "v" 'dired-view-file
   "m" 'dired-mark
   "u" 'dired-unmark
   "U" 'dired-unmark-all-marks
   "c" 'dired-create-directory
   "C" 'dired-do-copy
   "D" 'dired-do-delete
   "R" 'dired-do-rename
   "Y" 'dired-do-copy
   "!" 'dired-do-shell-command
   "&" 'dired-do-async-shell-command
   "q" 'quit-window
   "g r" 'revert-buffer
   "g g" 'evil-goto-first-line
   "G" 'evil-goto-line
   "s" 'dired-sort-toggle-or-edit
   "(" 'dired-hide-details-mode
   ")" 'dired-omit-mode)

  (general-define-key
   :states 'normal
   :keymaps 'helpful-mode-map
   "q" 'quit-window
   "g r" 'helpful-update
   "TAB" 'forward-button
   "S-TAB" 'backward-button
   "RET" 'push-button)

  (general-define-key
   :states 'normal
   :keymaps 'pdf-view-mode-map
   "j" 'pdf-view-next-line-or-next-page
   "k" 'pdf-view-previous-line-or-previous-page
   "h" 'image-backward-hscroll
   "l" 'image-forward-hscroll
   "J" 'pdf-view-next-page
   "K" 'pdf-view-previous-page
   "g g" 'pdf-view-first-page
   "G" 'pdf-view-last-page
   "g t" 'pdf-view-goto-page
   "g l" 'pdf-view-goto-label
   "+" 'pdf-view-enlarge
   "=" 'pdf-view-enlarge
   "-" 'pdf-view-shrink
   "0" 'pdf-view-scale-reset
   "W" 'pdf-view-fit-width-to-window
   "H" 'pdf-view-fit-height-to-window
   "P" 'pdf-view-fit-page-to-window
   "n" 'pdf-view-next-page-command
   "p" 'pdf-view-previous-page-command
   "d" 'pdf-view-midnight-minor-mode
   "/" 'isearch-forward
   "?" 'isearch-backward
   "o" 'pdf-outline
   "m" 'pdf-view-set-slice-using-mouse
   "b" 'pdf-view-set-slice-from-bounding-box
   "r" 'pdf-view-reset-slice
   "q" 'quit-window)

  (ar/local-leader
    :keymaps 'org-mode-map
    "," '(org-ctrl-c-ctrl-c :wk "Ctrl-c Ctrl-c")
    "." '(org-time-stamp :wk "Timestamp")
    "*" '(org-ctrl-c-star :wk "Heading")
    "-" '(org-ctrl-c-minus :wk "List")
    "a" '(org-agenda :wk "Agenda")
    "c" '(org-capture :wk "Capture")
    "e" '(org-export-dispatch :wk "Export")
    "i" '(:ignore t :wk "insert")
    "i l" '(org-insert-link :wk "Link")
    "i s" '(org-download-screenshot :wk "Screenshot")
    "i y" '(org-download-yank :wk "Yank image")
    "i t" '(org-table-create :wk "Table")
    "i h" '(org-insert-heading :wk "Heading")
    "t" '(org-todo :wk "Todo")
    "T" '(org-show-todo-tree :wk "Todo tree")
    "s" '(org-schedule :wk "Schedule")
    "d" '(org-deadline :wk "Deadline")
    "p" '(org-priority :wk "Priority")
    "r" '(org-refile :wk "Refile")
    "A" '(org-archive-subtree :wk "Archive")
    "l" '(:ignore t :wk "link")
    "l l" '(org-insert-link :wk "Insert link")
    "l s" '(org-store-link :wk "Store link")
    "l i" '(org-id-get-create :wk "Insert ID")
    "b" '(:ignore t :wk "babel")
    "b t" '(org-babel-tangle :wk "Tangle")
    "b e" '(org-babel-execute-src-block :wk "Execute")
    "b b" '(org-babel-execute-buffer :wk "Execute buffer")
    "b c" '(org-babel-check-src-block :wk "Check")
    "x" '(:ignore t :wk "text")
    "x b" '(org-toggle-checkbox :wk "Toggle checkbox")
    "x i" '(org-toggle-item :wk "Toggle item")
    "x p" '(org-set-property :wk "Set property")
    "x t" '(org-set-tags-command :wk "Set tags")))
#+end_src

