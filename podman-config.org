** Podman Container Development Environment
#+begin_src emacs-lisp
;; ============================================================================
;; Container Configuration
;; ============================================================================
(defcustom ar/dev-container-name "emacs-dev-env"
  "Name of the development container."
  :type 'string
  :group 'ar)

(defcustom ar/dev-container-image "emacs-dev-env:latest"
  "Podman image name for the development container."
  :type 'string
  :group 'ar)

(defcustom ar/dev-container-user "devuser"
  "Username inside the container."
  :type 'string
  :group 'ar)

(defcustom ar/dev-container-workspace "/home/devuser/workspace"
  "Workspace path inside the container."
  :type 'string
  :group 'ar)

;; ============================================================================
;; TRAMP Configuration for Podman (Emacs 29+ Built-in Support)
;; ============================================================================
(with-eval-after-load 'tramp
  ;; Performance optimizations for remote development
  (setq remote-file-name-inhibit-locks t
        remote-file-name-inhibit-auto-save-visited t
        tramp-use-scp-direct-remote-copying t
        tramp-verbose 1
        tramp-default-remote-shell "/bin/bash")
  
  ;; Enable direct async process for containers (critical performance boost)
  (connection-local-set-profile-variables
   'remote-direct-async
   '((tramp-direct-async-process . t)))
  
  (connection-local-set-profiles
   '(:application tramp :protocol "podman")
   'remote-direct-async)
  
  ;; Configure remote PATH for container binaries
  (connection-local-set-profile-variables
   'container-path
   '((tramp-remote-path . (tramp-own-remote-path
                          "/home/devuser/.local/bin"
                          "/home/devuser/.cargo/bin"
                          "/home/devuser/.bun/bin"
                          "/home/linuxbrew/.linuxbrew/bin"
                          "/usr/local/texlive/2025/bin/x86_64-linux"))))
  
  (connection-local-set-profiles
   `(:application tramp :protocol "podman" :machine ,ar/dev-container-name)
   'container-path 'remote-direct-async))

;; ============================================================================
;; Eglot Configuration for Container Development
;; ============================================================================
;; NOTE: Eglot works over TRAMP automatically since v1.8 (Emacs 29+)
;; No language-specific configuration needed - eglot finds LSP servers via PATH
;; Just open files via /podman:user@container:/path and eglot works
;;
;; ANSWER: Are language-specific settings needed?
;; NO - Eglot automatically detects and launches LSP servers on remote containers
;; as long as they're in the PATH (configured via connection-local-variables above).
;; The LSP servers (basedpyright, typescript-language-server, texlab, etc.) will
;; be found and used automatically without any Python/JS/TeX-specific configuration.

(with-eval-after-load 'eglot
  ;; Performance settings for remote connections
  (connection-local-set-profile-variables
   'eglot-container
   '((eglot-connect-timeout . 60)
     (eglot-sync-connect . nil)
     (eglot-events-buffer-size . 0)))
  
  (connection-local-set-profiles
   '(:application tramp :protocol "podman")
   'eglot-container))

;; eglot-booster works with remote servers (emacs-lsp-booster is in container)
(with-eval-after-load 'eglot-booster
  (setq eglot-booster-no-remote-boost nil))

;; ============================================================================
;; Dockerfile Editing Support
;; ============================================================================
(use-package dockerfile-ts-mode
  :ensure nil
  :mode ("Dockerfile\\'" "\\.dockerfile\\'"
         "Containerfile\\'" "\\.containerfile\\'"
         "Dockerfile\\..*\\'" "Containerfile\\..*\\'")
  :config
  ;; Fix Eglot language ID (server expects "dockerfile" not "dockerfile-ts-mode")
  (with-eval-after-load 'eglot
    (put 'dockerfile-ts-mode 'eglot-language-id "dockerfile")
    (add-to-list 'eglot-server-programs
                 '(dockerfile-ts-mode . ("docker-langserver" "--stdio"))))
  
  ;; Inject Bash grammar into RUN instructions for better syntax highlighting
  (defun ar/dockerfile-inject-bash ()
    "Inject Bash grammar into shell commands."
    (when (treesit-ready-p 'bash)
      (setq-local treesit-range-settings
                  (treesit-range-rules
                   :embed 'bash
                   :host 'dockerfile
                   '((run_instruction (shell_command) @injection.content))))
      (treesit-major-mode-setup)))
  
  (add-hook 'dockerfile-ts-mode-hook #'ar/dockerfile-inject-bash))

;; ============================================================================
;; Docker/Podman Management
;; ============================================================================
(use-package docker
  :defer t
  :commands (docker docker-containers docker-images container-hydra/body)
  :bind ("C-c C-p" . container-hydra/body)
  :pretty-hydra
  ((:title (pretty-hydra-title "Container Management" 'devicon "nf-dev-docker" :face 'nerd-icons-blue)
    :color amaranth :quit-key ("q" "C-g"))
   ("Container Lifecycle"
    (("b" ar/podman-build "build image" :exit t)
     ("r" ar/podman-run "run new container" :exit t)
     ("s" ar/podman-start "start container")
     ("S" ar/podman-stop "stop container")
     ("k" ar/podman-kill "kill container")
     ("x" ar/podman-remove "remove container"))
    
    "Access"
    (("o" ar/podman-open "open workspace" :exit t)
     ("t" ar/podman-shell "shell" :exit t)
     ("e" ar/podman-exec "exec command" :exit t))
    
    "Management"
    (("c" docker-containers "list containers" :exit t)
     ("i" docker-images "list images" :exit t)
     ("d" docker "docker menu" :exit t)
     ("l" ar/podman-logs "view logs" :exit t))
    
    "Status"
    (("?" ar/podman-status "container status")
     ("R" ar/podman-restart "restart container"))))
  :config
  (setq docker-command "podman"
        docker-compose-command "podman-compose"
        docker-container-tramp-method "podman"))

;; ============================================================================
;; Container Management Functions
;; ============================================================================

(defun ar/podman-build ()
  "Build the development container image from Dockerfile."
  (interactive)
  (let ((dockerfile-dir (locate-dominating-file default-directory "Dockerfile")))
    (unless dockerfile-dir
      (user-error "No Dockerfile found in project hierarchy"))
    (let ((default-directory dockerfile-dir)
          (compile-command (format "podman build -t %s ." ar/dev-container-image)))
      (compile compile-command))))

(defun ar/podman--exists-p ()
  "Check if container exists (running or stopped)."
  (zerop (call-process "podman" nil nil nil "ps" "-a" "-q" "-f"
                       (format "name=^%s$" ar/dev-container-name))))

(defun ar/podman--running-p ()
  "Check if container is currently running."
  (zerop (call-process "podman" nil nil nil "ps" "-q" "-f"
                       (format "name=^%s$" ar/dev-container-name))))

(defun ar/podman-run ()
  "Create and run a new development container."
  (interactive)
  (if (ar/podman--exists-p)
      (user-error "Container '%s' exists. Use 'ar/podman-start' or remove it first"
                  ar/dev-container-name)
    (let* ((project-root (or (and (project-current)
                                 (project-root (project-current)))
                            (read-directory-name "Project root: ")))
           (command (format "podman run -d --name %s -v %s:%s:Z %s tail -f /dev/null"
                           ar/dev-container-name
                           (expand-file-name project-root)
                           ar/dev-container-workspace
                           ar/dev-container-image)))
      (async-shell-command command "*podman-run*")
      (message "Creating container '%s'..." ar/dev-container-name))))

(defun ar/podman-start ()
  "Start the development container."
  (interactive)
  (cond
   ((not (ar/podman--exists-p))
    (when (y-or-n-p (format "Container '%s' doesn't exist. Create it? "
                           ar/dev-container-name))
      (call-interactively #'ar/podman-run)))
   ((ar/podman--running-p)
    (message "Container '%s' is already running" ar/dev-container-name))
   (t
    (async-shell-command (format "podman start %s" ar/dev-container-name)
                        "*podman-start*")
    (message "Starting container '%s'..." ar/dev-container-name))))

(defun ar/podman-stop ()
  "Stop the development container."
  (interactive)
  (if (ar/podman--running-p)
      (progn
        (async-shell-command (format "podman stop %s" ar/dev-container-name)
                            "*podman-stop*")
        (message "Stopping container '%s'..." ar/dev-container-name))
    (message "Container '%s' is not running" ar/dev-container-name)))

(defun ar/podman-kill ()
  "Force kill the development container."
  (interactive)
  (if (ar/podman--running-p)
      (when (y-or-n-p (format "Force kill container '%s'? "
                             ar/dev-container-name))
        (async-shell-command (format "podman kill %s" ar/dev-container-name)
                            "*podman-kill*")
        (message "Killing container '%s'..." ar/dev-container-name))
    (message "Container '%s' is not running" ar/dev-container-name)))

(defun ar/podman-remove ()
  "Remove the development container."
  (interactive)
  (cond
   ((not (ar/podman--exists-p))
    (message "Container '%s' doesn't exist" ar/dev-container-name))
   ((ar/podman--running-p)
    (user-error "Container is running. Stop it first with 'ar/podman-stop'"))
   (t
    (when (y-or-n-p (format "Remove container '%s'? " ar/dev-container-name))
      (async-shell-command (format "podman rm %s" ar/dev-container-name)
                          "*podman-rm*")
      (message "Removing container '%s'..." ar/dev-container-name)))))

(defun ar/podman-restart ()
  "Restart the development container."
  (interactive)
  (if (ar/podman--running-p)
      (progn
        (async-shell-command (format "podman restart %s" ar/dev-container-name)
                            "*podman-restart*")
        (message "Restarting container '%s'..." ar/dev-container-name))
    (user-error "Container '%s' is not running" ar/dev-container-name)))

(defun ar/podman-open ()
  "Open workspace in container via TRAMP."
  (interactive)
  (if (ar/podman--running-p)
      (find-file (format "/podman:%s@%s:%s"
                        ar/dev-container-user
                        ar/dev-container-name
                        ar/dev-container-workspace))
    (when (y-or-n-p (format "Container '%s' is not running. Start it? "
                           ar/dev-container-name))
      (ar/podman-start)
      (run-with-timer 2 nil
                     (lambda ()
                       (find-file (format "/podman:%s@%s:%s"
                                        ar/dev-container-user
                                        ar/dev-container-name
                                        ar/dev-container-workspace)))))))

(defun ar/podman-shell ()
  "Open shell in the running container."
  (interactive)
  (if (ar/podman--running-p)
      (let ((default-directory (format "/podman:%s@%s:%s"
                                      ar/dev-container-user
                                      ar/dev-container-name
                                      ar/dev-container-workspace)))
        (shell (format "*shell-%s*" ar/dev-container-name)))
    (user-error "Container '%s' is not running. Start it with 'ar/podman-start'"
               ar/dev-container-name)))

(defun ar/podman-exec (command)
  "Execute COMMAND in the running container."
  (interactive "sCommand: ")
  (if (ar/podman--running-p)
      (async-shell-command
       (format "podman exec %s %s" ar/dev-container-name command)
       (format "*podman-exec-%s*" ar/dev-container-name))
    (user-error "Container '%s' is not running" ar/dev-container-name)))

(defun ar/podman-logs ()
  "View logs from the container."
  (interactive)
  (if (ar/podman--exists-p)
      (async-shell-command
       (format "podman logs -f %s" ar/dev-container-name)
       (format "*podman-logs-%s*" ar/dev-container-name))
    (user-error "Container '%s' doesn't exist" ar/dev-container-name)))

(defun ar/podman-status ()
  "Display container status information."
  (interactive)
  (cond
   ((not (ar/podman--exists-p))
    (message "Container '%s' does not exist" ar/dev-container-name))
   ((ar/podman--running-p)
    (message "Container '%s' is RUNNING" ar/dev-container-name))
   (t
    (message "Container '%s' exists but is STOPPED" ar/dev-container-name))))
#+end_src
