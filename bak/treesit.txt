(use-package treesit
  :ensure nil
  :mode (("\\.tsx\\'" . tsx-ts-mode))
  :init
  (defvar ar/treesit-grammar-dir
    (file-truename (expand-file-name "tree-sitter" user-emacs-directory))
    "Target directory for installing tree-sitter grammars.")

  (unless (file-exists-p ar/treesit-grammar-dir)
    (make-directory ar/treesit-grammar-dir t))

  (defvar treesit-extra-load-path nil)
  (add-to-list 'treesit-extra-load-path ar/treesit-grammar-dir)

  :config
  (setq treesit-font-lock-level 4)

  (setq treesit-language-source-alist
        '((python "https://github.com/tree-sitter/tree-sitter-python")
          (cpp "https://github.com/tree-sitter/tree-sitter-cpp")
          (c "https://github.com/tree-sitter/tree-sitter-c")
          (json "https://github.com/tree-sitter/tree-sitter-json")
          (nix "https://github.com/nix-community/tree-sitter-nix")
          (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")))

  (setq major-mode-remap-alist
        '((python-mode . python-ts-mode)
          (c-mode . c-ts-mode)
          (c++-mode . c++-ts-mode)
          (c-or-c++-mode . c-or-c++-ts-mode)
          (json-mode . json-ts-mode)
          (js-mode . js-ts-mode)
          (typescript-mode . typescript-ts-mode)
          (conf-toml-mode . toml-ts-mode))))
